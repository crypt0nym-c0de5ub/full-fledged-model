

output["\\documentclass{standalone}\n" ++ 
       "\\usepackage{tikz}\n" ++ 
       "\\usepackage{fontawesome}\n" ++
       "\\usetikzlibrary{patterns}\n" ++
       "\\usepackage{bm}\n" ++
       "\\usepackage{amsmath}\n" ++
       "\\usetikzlibrary{crypto.symbols}\n" ++
       "\\tikzset{shadows=no}\n" ++
       "\\begin{document}\n" ++
       "\\begin{tikzpicture}[scale=0.32]\n" ++
       "\\definecolor{fk}{RGB}{0, 255, 0}\n" ++
       "\\definecolor{fs}{RGB}{48, 180, 255}\n" ++
       "\\definecolor{tt}{RGB}{172, 172, 180}\n" ++
       "\\definecolor{gk}{RGB}{255, 0, 0}\n" ++
       "\\definecolor{geqk}{RGB}{255, 128, 0}\n" ++
       "\\definecolor{dt}{RGB}{200, 0, 255}\n" ++
       "\\definecolor{fr}{RGB}{255, 0, 255}];\n\n"];
       
% === draw for Eb ===
output [
    if r mod 2 == 0 then 
    "\\begin{scope}[yshift=-" ++ show((r/2)*6) ++ "cm]\n" ++
    "  \\begin{scope}[xshift=" ++ show(0) ++ "cm]\n" ++    
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta STK_" ++ show(r) ++ "$};\n" ++
    if fix(uSTK[r, 0]) == 1 then "    \\fill[fk] (0,3) rectangle (1,4);\n" endif ++
    if fix(uSTK[r, 1]) == 1 then "    \\fill[fk] (0,2) rectangle (1,3);\n" endif ++
    if fix(uSTK[r, 2]) == 1 then "    \\fill[fk] (0,1) rectangle (1,2);\n" endif ++
    if fix(uSTK[r, 3]) == 1 then "    \\fill[fk] (0,0) rectangle (1,1);\n" endif ++
    if fix(uSTK[r, 4]) == 1 then "    \\fill[fk] (1,3) rectangle (2,4);\n" endif ++
    if fix(uSTK[r, 5]) == 1 then "    \\fill[fk] (1,2) rectangle (2,3);\n" endif ++
    if fix(uSTK[r, 6]) == 1 then "    \\fill[fk] (1,1) rectangle (2,2);\n" endif ++
    if fix(uSTK[r, 7]) == 1 then "    \\fill[fk] (1,0) rectangle (2,1);\n" endif ++
    if fix(uSTK[r, 8]) == 1 then "    \\fill[fk] (2,3) rectangle (3,4);\n" endif ++
    if fix(uSTK[r, 9]) == 1 then "    \\fill[fk] (2,2) rectangle (3,3);\n" endif ++
    if fix(uSTK[r,10]) == 1 then "    \\fill[fk] (2,1) rectangle (3,2);\n" endif ++
    if fix(uSTK[r,11]) == 1 then "    \\fill[fk] (2,0) rectangle (3,1);\n" endif ++
    if fix(uSTK[r,12]) == 1 then "    \\fill[fk] (3,3) rectangle (4,4);\n" endif ++
    if fix(uSTK[r,13]) == 1 then "    \\fill[fk] (3,2) rectangle (4,3);\n" endif ++
    if fix(uSTK[r,14]) == 1 then "    \\fill[fk] (3,1) rectangle (4,2);\n" endif ++
    if fix(uSTK[r,15]) == 1 then "    \\fill[fk] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    if fix(uGSTK[r, 0]) == 1 then "    \\draw[gk, ultra thick] (0,3) rectangle (1,4);\n" endif ++
    if fix(uGSTK[r, 1]) == 1 then "    \\draw[gk, ultra thick] (0,2) rectangle (1,3);\n" endif ++
    if fix(uGSTK[r, 2]) == 1 then "    \\draw[gk, ultra thick] (0,1) rectangle (1,2);\n" endif ++
    if fix(uGSTK[r, 3]) == 1 then "    \\draw[gk, ultra thick] (0,0) rectangle (1,1);\n" endif ++
    if fix(uGSTK[r, 4]) == 1 then "    \\draw[gk, ultra thick] (1,3) rectangle (2,4);\n" endif ++
    if fix(uGSTK[r, 5]) == 1 then "    \\draw[gk, ultra thick] (1,2) rectangle (2,3);\n" endif ++
    if fix(uGSTK[r, 6]) == 1 then "    \\draw[gk, ultra thick] (1,1) rectangle (2,2);\n" endif ++
    if fix(uGSTK[r, 7]) == 1 then "    \\draw[gk, ultra thick] (1,0) rectangle (2,1);\n" endif ++
    if fix(uGSTK[r, 8]) == 1 then "    \\draw[gk, ultra thick] (2,3) rectangle (3,4);\n" endif ++
    if fix(uGSTK[r, 9]) == 1 then "    \\draw[gk, ultra thick] (2,2) rectangle (3,3);\n" endif ++
    if fix(uGSTK[r,10]) == 1 then "    \\draw[gk, ultra thick] (2,1) rectangle (3,2);\n" endif ++
    if fix(uGSTK[r,11]) == 1 then "    \\draw[gk, ultra thick] (2,0) rectangle (3,1);\n" endif ++
    if fix(uGSTK[r,12]) == 1 then "    \\draw[gk, ultra thick] (3,3) rectangle (4,4);\n" endif ++
    if fix(uGSTK[r,13]) == 1 then "    \\draw[gk, ultra thick] (3,2) rectangle (4,3);\n" endif ++
    if fix(uGSTK[r,14]) == 1 then "    \\draw[gk, ultra thick] (3,1) rectangle (4,2);\n" endif ++
    if fix(uGSTK[r,15]) == 1 then "    \\draw[gk, ultra thick] (3,0) rectangle (4,1);\n" endif ++
    if fix(uSGK[r, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 0]) == fix(uSGK[r, 0]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 0]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 1]) == fix(uSGK[r, 1]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 1]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 2]) == fix(uSGK[r, 2]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 2]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 3]) == fix(uSGK[r, 3]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 3]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 4]) == fix(uSGK[r, 4]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 4]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 5]) == fix(uSGK[r, 5]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 5]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 6]) == fix(uSGK[r, 6]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 6]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 7]) == fix(uSGK[r, 7]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 7]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 8]) == fix(uSGK[r, 8]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 8]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 9]) == fix(uSGK[r, 9]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 9]) ++ "}$};\n" endif ++
    if fix(uSGK[r,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r,10]) == fix(uSGK[r,10]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r,10]) ++ "}$};\n" endif ++
    if fix(uSGK[r,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r,11]) == fix(uSGK[r,11]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r,11]) ++ "}$};\n" endif ++
    if fix(uSGK[r,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r,12]) == fix(uSGK[r,12]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r,12]) ++ "}$};\n" endif ++
    if fix(uSGK[r,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r,13]) == fix(uSGK[r,13]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r,13]) ++ "}$};\n" endif ++
    if fix(uSGK[r,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r,14]) == fix(uSGK[r,14]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r,14]) ++ "}$};\n" endif ++
    if fix(uSGK[r,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r,15]) == fix(uSGK[r,15]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r,15]) ++ "}$};\n" endif ++
    "  \\end{scope}\n" ++
    
    % -----------------------------
    "  \\begin{scope}[xshift=" ++ show(5) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta " ++ if r==0 then "P" else "W_" ++ show(r) endif ++ "$};\n" ++
    if fix(uXAK[r, 0]+uYAK[r, 0] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 0]+uYAK[r, 0] == 2) then "tt" elseif fix(uXAK[r, 0]+uYAK[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(uXAK[r, 1]+uYAK[r, 1] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 1]+uYAK[r, 1] == 2) then "tt" elseif fix(uXAK[r, 1]+uYAK[r, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(uXAK[r, 2]+uYAK[r, 2] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 2]+uYAK[r, 2] == 2) then "tt" elseif fix(uXAK[r, 2]+uYAK[r, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(uXAK[r, 3]+uYAK[r, 3] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 3]+uYAK[r, 3] == 2) then "tt" elseif fix(uXAK[r, 3]+uYAK[r, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(uXAK[r, 4]+uYAK[r, 4] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 4]+uYAK[r, 4] == 2) then "tt" elseif fix(uXAK[r, 4]+uYAK[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(uXAK[r, 5]+uYAK[r, 5] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 5]+uYAK[r, 5] == 2) then "tt" elseif fix(uXAK[r, 5]+uYAK[r, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(uXAK[r, 6]+uYAK[r, 6] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 6]+uYAK[r, 6] == 2) then "tt" elseif fix(uXAK[r, 6]+uYAK[r, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(uXAK[r, 7]+uYAK[r, 7] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 7]+uYAK[r, 7] == 2) then "tt" elseif fix(uXAK[r, 7]+uYAK[r, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(uXAK[r, 8]+uYAK[r, 8] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 8]+uYAK[r, 8] == 2) then "tt" elseif fix(uXAK[r, 8]+uYAK[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(uXAK[r, 9]+uYAK[r, 9] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 9]+uYAK[r, 9] == 2) then "tt" elseif fix(uXAK[r, 9]+uYAK[r, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(uXAK[r,10]+uYAK[r,10] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r,10]+uYAK[r,10] == 2) then "tt" elseif fix(uXAK[r,10]+uYAK[r,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(uXAK[r,11]+uYAK[r,11] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r,11]+uYAK[r,11] == 2) then "tt" elseif fix(uXAK[r,11]+uYAK[r,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(uXAK[r,12]+uYAK[r,12] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r,12]+uYAK[r,12] == 2) then "tt" elseif fix(uXAK[r,12]+uYAK[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(uXAK[r,13]+uYAK[r,13] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r,13]+uYAK[r,13] == 2) then "tt" elseif fix(uXAK[r,13]+uYAK[r,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(uXAK[r,14]+uYAK[r,14] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r,14]+uYAK[r,14] == 2) then "tt" elseif fix(uXAK[r,14]+uYAK[r,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(uXAK[r,15]+uYAK[r,15] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r,15]+uYAK[r,15] == 2) then "tt" elseif fix(uXAK[r,15]+uYAK[r,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    if fix(uVAK[r, 0] == 1) then "    \\draw[pattern=north west lines] (0,3) rectangle (1,4);\n" endif ++
    if fix(uVAK[r, 1] == 1) then "    \\draw[pattern=north west lines] (0,2) rectangle (1,3);\n" endif ++
    if fix(uVAK[r, 2] == 1) then "    \\draw[pattern=north west lines] (0,1) rectangle (1,2);\n" endif ++
    if fix(uVAK[r, 3] == 1) then "    \\draw[pattern=north west lines] (0,0) rectangle (1,1);\n" endif ++
    if fix(uVAK[r, 4] == 1) then "    \\draw[pattern=north west lines] (1,3) rectangle (2,4);\n" endif ++
    if fix(uVAK[r, 5] == 1) then "    \\draw[pattern=north west lines] (1,2) rectangle (2,3);\n" endif ++
    if fix(uVAK[r, 6] == 1) then "    \\draw[pattern=north west lines] (1,1) rectangle (2,2);\n" endif ++
    if fix(uVAK[r, 7] == 1) then "    \\draw[pattern=north west lines] (1,0) rectangle (2,1);\n" endif ++
    if fix(uVAK[r, 8] == 1) then "    \\draw[pattern=north west lines] (2,3) rectangle (3,4);\n" endif ++
    if fix(uVAK[r, 9] == 1) then "    \\draw[pattern=north west lines] (2,2) rectangle (3,3);\n" endif ++
    if fix(uVAK[r,10] == 1) then "    \\draw[pattern=north west lines] (2,1) rectangle (3,2);\n" endif ++
    if fix(uVAK[r,11] == 1) then "    \\draw[pattern=north west lines] (2,0) rectangle (3,1);\n" endif ++
    if fix(uVAK[r,12] == 1) then "    \\draw[pattern=north west lines] (3,3) rectangle (4,4);\n" endif ++
    if fix(uVAK[r,13] == 1) then "    \\draw[pattern=north west lines] (3,2) rectangle (4,3);\n" endif ++
    if fix(uVAK[r,14] == 1) then "    \\draw[pattern=north west lines] (3,1) rectangle (4,2);\n" endif ++
    if fix(uVAK[r,15] == 1) then "    \\draw[pattern=north west lines] (3,0) rectangle (4,1);\n" endif ++
    if fix(uSSB[r, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 0]) == fix(uSSB[r, 0]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r, 0]) ++ "}$}};\n" endif ++
    if fix(uSAK[r, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 1]) == fix(uSAK[r, 1]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r, 1]) ++ "}$}};\n" endif ++
    if fix(uSAK[r, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 2]) == fix(uSAK[r, 2]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r, 2]) ++ "}$}};\n" endif ++
    if fix(uSAK[r, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 3]) == fix(uSAK[r, 3]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r, 3]) ++ "}$}};\n" endif ++
    if fix(uSAK[r, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 4]) == fix(uSAK[r, 4]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r, 4]) ++ "}$}};\n" endif ++
    if fix(uSAK[r, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 5]) == fix(uSAK[r, 5]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r, 5]) ++ "}$}};\n" endif ++
    if fix(uSAK[r, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 6]) == fix(uSAK[r, 6]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r, 6]) ++ "}$}};\n" endif ++
    if fix(uSAK[r, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 7]) == fix(uSAK[r, 7]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r, 7]) ++ "}$}};\n" endif ++
    if fix(uSAK[r, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 8]) == fix(uSAK[r, 8]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r, 8]) ++ "}$}};\n" endif ++
    if fix(uSAK[r, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 9]) == fix(uSAK[r, 9]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r, 9]) ++ "}$}};\n" endif ++
    if fix(uSAK[r,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,10]) == fix(uSAK[r,10]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r,10]) ++ "}$}};\n" endif ++
    if fix(uSAK[r,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,11]) == fix(uSAK[r,11]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r,11]) ++ "}$}};\n" endif ++
    if fix(uSAK[r,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,12]) == fix(uSAK[r,12]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r,12]) ++ "}$}};\n" endif ++
    if fix(uSAK[r,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,13]) == fix(uSAK[r,13]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r,13]) ++ "}$}};\n" endif ++
    if fix(uSAK[r,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,14]) == fix(uSAK[r,14]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r,14]) ++ "}$}};\n" endif ++
    if fix(uSAK[r,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,15]) == fix(uSAK[r,15]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSAK[r,15]) ++ "}$}};\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    "    \\draw[->] (4,2) -- +(2,0);\n" ++ 
    "    \\draw[->] (-3,4)--++(0,0.5) --++(8,0)--++(0,-2.2);\n" ++
    "    \\node at (5,2) {$\\oplus$};\n" ++
    "  \\end{scope}\n" ++ 
    
% -----------------------------
    "  \\begin{scope}[xshift=" ++ show(11) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta X_" ++ show(r) ++ "$};\n" ++
    if fix(uXSB[r, 0]+uYSB[r, 0] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 0]+uYSB[r, 0] == 2) then "tt" elseif fix(uXSB[r, 0]+uYSB[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(uXSB[r, 1]+uYSB[r, 1] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 1]+uYSB[r, 1] == 2) then "tt" elseif fix(uXSB[r, 1]+uYSB[r, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(uXSB[r, 2]+uYSB[r, 2] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 2]+uYSB[r, 2] == 2) then "tt" elseif fix(uXSB[r, 2]+uYSB[r, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(uXSB[r, 3]+uYSB[r, 3] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 3]+uYSB[r, 3] == 2) then "tt" elseif fix(uXSB[r, 3]+uYSB[r, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(uXSB[r, 4]+uYSB[r, 4] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 4]+uYSB[r, 4] == 2) then "tt" elseif fix(uXSB[r, 4]+uYSB[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(uXSB[r, 5]+uYSB[r, 5] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 5]+uYSB[r, 5] == 2) then "tt" elseif fix(uXSB[r, 5]+uYSB[r, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(uXSB[r, 6]+uYSB[r, 6] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 6]+uYSB[r, 6] == 2) then "tt" elseif fix(uXSB[r, 6]+uYSB[r, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(uXSB[r, 7]+uYSB[r, 7] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 7]+uYSB[r, 7] == 2) then "tt" elseif fix(uXSB[r, 7]+uYSB[r, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(uXSB[r, 8]+uYSB[r, 8] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 8]+uYSB[r, 8] == 2) then "tt" elseif fix(uXSB[r, 8]+uYSB[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(uXSB[r, 9]+uYSB[r, 9] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 9]+uYSB[r, 9] == 2) then "tt" elseif fix(uXSB[r, 9]+uYSB[r, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(uXSB[r,10]+uYSB[r,10] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,10]+uYSB[r,10] == 2) then "tt" elseif fix(uXSB[r,10]+uYSB[r,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(uXSB[r,11]+uYSB[r,11] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,11]+uYSB[r,11] == 2) then "tt" elseif fix(uXSB[r,11]+uYSB[r,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(uXSB[r,12]+uYSB[r,12] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,12]+uYSB[r,12] == 2) then "tt" elseif fix(uXSB[r,12]+uYSB[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(uXSB[r,13]+uYSB[r,13] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,13]+uYSB[r,13] == 2) then "tt" elseif fix(uXSB[r,13]+uYSB[r,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(uXSB[r,14]+uYSB[r,14] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,14]+uYSB[r,14] == 2) then "tt" elseif fix(uXSB[r,14]+uYSB[r,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(uXSB[r,15]+uYSB[r,15] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,15]+uYSB[r,15] == 2) then "tt" elseif fix(uXSB[r,15]+uYSB[r,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    if fix(uVSB[r, 0] == 1) then "    \\draw[pattern=north west lines] (0,3) rectangle (1,4);\n" endif ++
    if fix(uVSB[r, 1] == 1) then "    \\draw[pattern=north west lines] (0,2) rectangle (1,3);\n" endif ++
    if fix(uVSB[r, 2] == 1) then "    \\draw[pattern=north west lines] (0,1) rectangle (1,2);\n" endif ++
    if fix(uVSB[r, 3] == 1) then "    \\draw[pattern=north west lines] (0,0) rectangle (1,1);\n" endif ++
    if fix(uVSB[r, 4] == 1) then "    \\draw[pattern=north west lines] (1,3) rectangle (2,4);\n" endif ++
    if fix(uVSB[r, 5] == 1) then "    \\draw[pattern=north west lines] (1,2) rectangle (2,3);\n" endif ++
    if fix(uVSB[r, 6] == 1) then "    \\draw[pattern=north west lines] (1,1) rectangle (2,2);\n" endif ++
    if fix(uVSB[r, 7] == 1) then "    \\draw[pattern=north west lines] (1,0) rectangle (2,1);\n" endif ++
    if fix(uVSB[r, 8] == 1) then "    \\draw[pattern=north west lines] (2,3) rectangle (3,4);\n" endif ++
    if fix(uVSB[r, 9] == 1) then "    \\draw[pattern=north west lines] (2,2) rectangle (3,3);\n" endif ++
    if fix(uVSB[r,10] == 1) then "    \\draw[pattern=north west lines] (2,1) rectangle (3,2);\n" endif ++
    if fix(uVSB[r,11] == 1) then "    \\draw[pattern=north west lines] (2,0) rectangle (3,1);\n" endif ++
    if fix(uVSB[r,12] == 1) then "    \\draw[pattern=north west lines] (3,3) rectangle (4,4);\n" endif ++
    if fix(uVSB[r,13] == 1) then "    \\draw[pattern=north west lines] (3,2) rectangle (4,3);\n" endif ++
    if fix(uVSB[r,14] == 1) then "    \\draw[pattern=north west lines] (3,1) rectangle (4,2);\n" endif ++
    if fix(uVSB[r,15] == 1) then "    \\draw[pattern=north west lines] (3,0) rectangle (4,1);\n" endif ++
    if fix(uSSB[r, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 0]) == fix(uSSB[r, 0]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 0]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 1]) == fix(uSSB[r, 1]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 1]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 2]) == fix(uSSB[r, 2]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 2]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 3]) == fix(uSSB[r, 3]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 3]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 4]) == fix(uSSB[r, 4]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 4]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 5]) == fix(uSSB[r, 5]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 5]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 6]) == fix(uSSB[r, 6]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 6]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 7]) == fix(uSSB[r, 7]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 7]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 8]) == fix(uSSB[r, 8]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 8]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 9]) == fix(uSSB[r, 9]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 9]) ++ "}$}};\n" endif ++
    if fix(uSSB[r,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,10]) == fix(uSSB[r,10]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r,10]) ++ "}$}};\n" endif ++
    if fix(uSSB[r,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,11]) == fix(uSSB[r,11]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r,11]) ++ "}$}};\n" endif ++
    if fix(uSSB[r,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,12]) == fix(uSSB[r,12]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r,12]) ++ "}$}};\n" endif ++
    if fix(uSSB[r,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,13]) == fix(uSSB[r,13]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r,13]) ++ "}$}};\n" endif ++
    if fix(uSSB[r,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,14]) == fix(uSSB[r,14]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r,14]) ++ "}$}};\n" endif ++
    if fix(uSSB[r,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,15]) == fix(uSSB[r,15]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r,15]) ++ "}$}};\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++    
    "    \\draw[->] (4,2) -- node[above] {\\tiny SB} node[below] {\\tiny SR} +(2,0);\n" ++
    "  \\end{scope}\n" ++ 

    % -----------------------------
    "  \\begin{scope}[xshift=" ++ show(17) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta Z_" ++ show(r) ++ "$};\n" ++
    if fix(uXSR[r, 0]+uYSR[r, 0] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 0]+uYSR[r, 0] == 2) then "tt" elseif fix(uXSR[r, 0]+uYSR[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(uXSR[r, 5]+uYSR[r, 5] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 5]+uYSR[r, 5] == 2) then "tt" elseif fix(uXSR[r, 5]+uYSR[r, 5] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(uXSR[r,10]+uYSR[r,10] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,10]+uYSR[r,10] == 2) then "tt" elseif fix(uXSR[r,10]+uYSR[r,10] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(uXSR[r,15]+uYSR[r,15] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,15]+uYSR[r,15] == 2) then "tt" elseif fix(uXSR[r,15]+uYSR[r,15] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(uXSR[r, 4]+uYSR[r, 4] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 4]+uYSR[r, 4] == 2) then "tt" elseif fix(uXSR[r, 4]+uYSR[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(uXSR[r, 9]+uYSR[r, 9] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 9]+uYSR[r, 9] == 2) then "tt" elseif fix(uXSR[r, 9]+uYSR[r, 9] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(uXSR[r,14]+uYSR[r,14] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,14]+uYSR[r,14] == 2) then "tt" elseif fix(uXSR[r,14]+uYSR[r,14] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(uXSR[r, 3]+uYSR[r, 3] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 3]+uYSR[r, 3] == 2) then "tt" elseif fix(uXSR[r, 3]+uYSR[r, 3] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(uXSR[r, 8]+uYSR[r, 8] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 8]+uYSR[r, 8] == 2) then "tt" elseif fix(uXSR[r, 8]+uYSR[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(uXSR[r,13]+uYSR[r,13] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,13]+uYSR[r,13] == 2) then "tt" elseif fix(uXSR[r,13]+uYSR[r,13] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(uXSR[r, 2]+uYSR[r, 2] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 2]+uYSR[r, 2] == 2) then "tt" elseif fix(uXSR[r, 2]+uYSR[r, 2] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(uXSR[r, 7]+uYSR[r, 7] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 7]+uYSR[r, 7] == 2) then "tt" elseif fix(uXSR[r, 7]+uYSR[r, 7] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(uXSR[r,12]+uYSR[r,12] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,12]+uYSR[r,12] == 2) then "tt" elseif fix(uXSR[r,12]+uYSR[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(uXSR[r, 1]+uYSR[r, 1] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 1]+uYSR[r, 1] == 2) then "tt" elseif fix(uXSR[r, 1]+uYSR[r, 1] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(uXSR[r, 6]+uYSR[r, 6] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 6]+uYSR[r, 6] == 2) then "tt" elseif fix(uXSR[r, 6]+uYSR[r, 6] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(uXSR[r,11]+uYSR[r,11] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,11]+uYSR[r,11] == 2) then "tt" elseif fix(uXSR[r,11]+uYSR[r,11] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    if fix(uVSR[r, 0] == 1) then "    \\draw[pattern=north west lines] (0,3) rectangle (1,4);\n" endif ++
    if fix(uVSR[r, 5] == 1) then "    \\draw[pattern=north west lines] (0,2) rectangle (1,3);\n" endif ++
    if fix(uVSR[r,10] == 1) then "    \\draw[pattern=north west lines] (0,1) rectangle (1,2);\n" endif ++
    if fix(uVSR[r,15] == 1) then "    \\draw[pattern=north west lines] (0,0) rectangle (1,1);\n" endif ++
    if fix(uVSR[r, 4] == 1) then "    \\draw[pattern=north west lines] (1,3) rectangle (2,4);\n" endif ++
    if fix(uVSR[r, 9] == 1) then "    \\draw[pattern=north west lines] (1,2) rectangle (2,3);\n" endif ++
    if fix(uVSR[r,14] == 1) then "    \\draw[pattern=north west lines] (1,1) rectangle (2,2);\n" endif ++
    if fix(uVSR[r, 3] == 1) then "    \\draw[pattern=north west lines] (1,0) rectangle (2,1);\n" endif ++
    if fix(uVSR[r, 8] == 1) then "    \\draw[pattern=north west lines] (2,3) rectangle (3,4);\n" endif ++
    if fix(uVSR[r,13] == 1) then "    \\draw[pattern=north west lines] (2,2) rectangle (3,3);\n" endif ++
    if fix(uVSR[r, 2] == 1) then "    \\draw[pattern=north west lines] (2,1) rectangle (3,2);\n" endif ++
    if fix(uVSR[r, 7] == 1) then "    \\draw[pattern=north west lines] (2,0) rectangle (3,1);\n" endif ++
    if fix(uVSR[r,12] == 1) then "    \\draw[pattern=north west lines] (3,3) rectangle (4,4);\n" endif ++
    if fix(uVSR[r, 1] == 1) then "    \\draw[pattern=north west lines] (3,2) rectangle (4,3);\n" endif ++
    if fix(uVSR[r, 6] == 1) then "    \\draw[pattern=north west lines] (3,1) rectangle (4,2);\n" endif ++
    if fix(uVSR[r,11] == 1) then "    \\draw[pattern=north west lines] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    if fix(uFSB[r, 0] == 1) then "    \\draw[fr, ultra thick] (0,3) rectangle (1,4);\n" endif ++
    if fix(uFSB[r, 5] == 1) then "    \\draw[fr, ultra thick] (0,2) rectangle (1,3);\n" endif ++
    if fix(uFSB[r,10] == 1) then "    \\draw[fr, ultra thick] (0,1) rectangle (1,2);\n" endif ++
    if fix(uFSB[r,15] == 1) then "    \\draw[fr, ultra thick] (0,0) rectangle (1,1);\n" endif ++
    if fix(uFSB[r, 4] == 1) then "    \\draw[fr, ultra thick] (1,3) rectangle (2,4);\n" endif ++
    if fix(uFSB[r, 9] == 1) then "    \\draw[fr, ultra thick] (1,2) rectangle (2,3);\n" endif ++
    if fix(uFSB[r,14] == 1) then "    \\draw[fr, ultra thick] (1,1) rectangle (2,2);\n" endif ++
    if fix(uFSB[r, 3] == 1) then "    \\draw[fr, ultra thick] (1,0) rectangle (2,1);\n" endif ++
    if fix(uFSB[r, 8] == 1) then "    \\draw[fr, ultra thick] (2,3) rectangle (3,4);\n" endif ++
    if fix(uFSB[r,13] == 1) then "    \\draw[fr, ultra thick] (2,2) rectangle (3,3);\n" endif ++
    if fix(uFSB[r, 2] == 1) then "    \\draw[fr, ultra thick] (2,1) rectangle (3,2);\n" endif ++
    if fix(uFSB[r, 7] == 1) then "    \\draw[fr, ultra thick] (2,0) rectangle (3,1);\n" endif ++
    if fix(uFSB[r,12] == 1) then "    \\draw[fr, ultra thick] (3,3) rectangle (4,4);\n" endif ++
    if fix(uFSB[r, 1] == 1) then "    \\draw[fr, ultra thick] (3,2) rectangle (4,3);\n" endif ++
    if fix(uFSB[r, 6] == 1) then "    \\draw[fr, ultra thick] (3,1) rectangle (4,2);\n" endif ++
    if fix(uFSB[r,11] == 1) then "    \\draw[fr, ultra thick] (3,0) rectangle (4,1);\n" endif ++
    if fix(uSMC[r, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 0]) == fix(uSMC[r, 0]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 0]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 1]) == fix(uSMC[r, 1]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 1]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 2]) == fix(uSMC[r, 2]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 2]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 3]) == fix(uSMC[r, 3]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 3]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 4]) == fix(uSMC[r, 4]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 4]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 5]) == fix(uSMC[r, 5]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 5]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 6]) == fix(uSMC[r, 6]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 6]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 7]) == fix(uSMC[r, 7]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 7]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 8]) == fix(uSMC[r, 8]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 8]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 9]) == fix(uSMC[r, 9]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 9]) ++ "}$}};\n" endif ++
    if fix(uSMC[r,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r,10]) == fix(uSMC[r,10]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r,10]) ++ "}$}};\n" endif ++
    if fix(uSMC[r,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r,11]) == fix(uSMC[r,11]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r,11]) ++ "}$}};\n" endif ++
    if fix(uSMC[r,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r,12]) == fix(uSMC[r,12]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r,12]) ++ "}$}};\n" endif ++
    if fix(uSMC[r,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r,13]) == fix(uSMC[r,13]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r,13]) ++ "}$}};\n" endif ++
    if fix(uSMC[r,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r,14]) == fix(uSMC[r,14]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r,14]) ++ "}$}};\n" endif ++
    if fix(uSMC[r,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r,15]) == fix(uSMC[r,15]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r,15]) ++ "}$}};\n" endif ++
    "    \\draw[->] (4,2) -- node[above] {\\tiny MC} +(2,0);\n" ++
    if r == Rb-1 then "    \\node at (5,1.5)[below, fill opacity=0.5] {$\\stackrel{E_b}{\\leftarrow}$}\n"
    endif ++
    "  \\end{scope}\n" ++ 
    
    "  \\begin{scope}[xshift=" ++ show(23) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta W_" ++ show(r) ++ "$};\n" ++
    if fix(uXAK[r+1, 0]+uYAK[r+1, 0] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 0]+uYAK[r+1, 0] == 2) then "tt" elseif fix(uXAK[r+1, 0]+uYAK[r+1, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(uXAK[r+1, 1]+uYAK[r+1, 1] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 1]+uYAK[r+1, 1] == 2) then "tt" elseif fix(uXAK[r+1, 1]+uYAK[r+1, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(uXAK[r+1, 2]+uYAK[r+1, 2] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 2]+uYAK[r+1, 2] == 2) then "tt" elseif fix(uXAK[r+1, 2]+uYAK[r+1, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(uXAK[r+1, 3]+uYAK[r+1, 3] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 3]+uYAK[r+1, 3] == 2) then "tt" elseif fix(uXAK[r+1, 3]+uYAK[r+1, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(uXAK[r+1, 4]+uYAK[r+1, 4] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 4]+uYAK[r+1, 4] == 2) then "tt" elseif fix(uXAK[r+1, 4]+uYAK[r+1, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(uXAK[r+1, 5]+uYAK[r+1, 5] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 5]+uYAK[r+1, 5] == 2) then "tt" elseif fix(uXAK[r+1, 5]+uYAK[r+1, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(uXAK[r+1, 6]+uYAK[r+1, 6] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 6]+uYAK[r+1, 6] == 2) then "tt" elseif fix(uXAK[r+1, 6]+uYAK[r+1, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(uXAK[r+1, 7]+uYAK[r+1, 7] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 7]+uYAK[r+1, 7] == 2) then "tt" elseif fix(uXAK[r+1, 7]+uYAK[r+1, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(uXAK[r+1, 8]+uYAK[r+1, 8] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 8]+uYAK[r+1, 8] == 2) then "tt" elseif fix(uXAK[r+1, 8]+uYAK[r+1, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(uXAK[r+1, 9]+uYAK[r+1, 9] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 9]+uYAK[r+1, 9] == 2) then "tt" elseif fix(uXAK[r+1, 9]+uYAK[r+1, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(uXAK[r+1,10]+uYAK[r+1,10] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,10]+uYAK[r+1,10] == 2) then "tt" elseif fix(uXAK[r+1,10]+uYAK[r+1,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(uXAK[r+1,11]+uYAK[r+1,11] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,11]+uYAK[r+1,11] == 2) then "tt" elseif fix(uXAK[r+1,11]+uYAK[r+1,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(uXAK[r+1,12]+uYAK[r+1,12] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,12]+uYAK[r+1,12] == 2) then "tt" elseif fix(uXAK[r+1,12]+uYAK[r+1,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(uXAK[r+1,13]+uYAK[r+1,13] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,13]+uYAK[r+1,13] == 2) then "tt" elseif fix(uXAK[r+1,13]+uYAK[r+1,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(uXAK[r+1,14]+uYAK[r+1,14] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,14]+uYAK[r+1,14] == 2) then "tt" elseif fix(uXAK[r+1,14]+uYAK[r+1,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(uXAK[r+1,15]+uYAK[r+1,15] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,15]+uYAK[r+1,15] == 2) then "tt" elseif fix(uXAK[r+1,15]+uYAK[r+1,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    
    if fix(uVAK[r+1, 0] == 1) then "    \\draw[pattern=north west lines] (0,3) rectangle (1,4);\n" endif ++
    if fix(uVAK[r+1, 1] == 1) then "    \\draw[pattern=north west lines] (0,2) rectangle (1,3);\n" endif ++
    if fix(uVAK[r+1, 2] == 1) then "    \\draw[pattern=north west lines] (0,1) rectangle (1,2);\n" endif ++
    if fix(uVAK[r+1, 3] == 1) then "    \\draw[pattern=north west lines] (0,0) rectangle (1,1);\n" endif ++
    if fix(uVAK[r+1, 4] == 1) then "    \\draw[pattern=north west lines] (1,3) rectangle (2,4);\n" endif ++
    if fix(uVAK[r+1, 5] == 1) then "    \\draw[pattern=north west lines] (1,2) rectangle (2,3);\n" endif ++
    if fix(uVAK[r+1, 6] == 1) then "    \\draw[pattern=north west lines] (1,1) rectangle (2,2);\n" endif ++
    if fix(uVAK[r+1, 7] == 1) then "    \\draw[pattern=north west lines] (1,0) rectangle (2,1);\n" endif ++
    if fix(uVAK[r+1, 8] == 1) then "    \\draw[pattern=north west lines] (2,3) rectangle (3,4);\n" endif ++
    if fix(uVAK[r+1, 9] == 1) then "    \\draw[pattern=north west lines] (2,2) rectangle (3,3);\n" endif ++
    if fix(uVAK[r+1,10] == 1) then "    \\draw[pattern=north west lines] (2,1) rectangle (3,2);\n" endif ++
    if fix(uVAK[r+1,11] == 1) then "    \\draw[pattern=north west lines] (2,0) rectangle (3,1);\n" endif ++
    if fix(uVAK[r+1,12] == 1) then "    \\draw[pattern=north west lines] (3,3) rectangle (4,4);\n" endif ++
    if fix(uVAK[r+1,13] == 1) then "    \\draw[pattern=north west lines] (3,2) rectangle (4,3);\n" endif ++
    if fix(uVAK[r+1,14] == 1) then "    \\draw[pattern=north west lines] (3,1) rectangle (4,2);\n" endif ++
    if fix(uVAK[r+1,15] == 1) then "    \\draw[pattern=north west lines] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    if fix(uFMC[r, 0] == 1) then "    \\draw[fr, ultra thick] (0,3) rectangle (1,4);\n" endif ++
    if fix(uFMC[r, 1] == 1) then "    \\draw[fr, ultra thick] (0,2) rectangle (1,3);\n" endif ++
    if fix(uFMC[r, 2] == 1) then "    \\draw[fr, ultra thick] (0,1) rectangle (1,2);\n" endif ++
    if fix(uFMC[r, 3] == 1) then "    \\draw[fr, ultra thick] (0,0) rectangle (1,1);\n" endif ++
    if fix(uFMC[r, 4] == 1) then "    \\draw[fr, ultra thick] (1,3) rectangle (2,4);\n" endif ++
    if fix(uFMC[r, 5] == 1) then "    \\draw[fr, ultra thick] (1,2) rectangle (2,3);\n" endif ++
    if fix(uFMC[r, 6] == 1) then "    \\draw[fr, ultra thick] (1,1) rectangle (2,2);\n" endif ++
    if fix(uFMC[r, 7] == 1) then "    \\draw[fr, ultra thick] (1,0) rectangle (2,1);\n" endif ++
    if fix(uFMC[r, 8] == 1) then "    \\draw[fr, ultra thick] (2,3) rectangle (3,4);\n" endif ++
    if fix(uFMC[r, 9] == 1) then "    \\draw[fr, ultra thick] (2,2) rectangle (3,3);\n" endif ++
    if fix(uFMC[r,10] == 1) then "    \\draw[fr, ultra thick] (2,1) rectangle (3,2);\n" endif ++
    if fix(uFMC[r,11] == 1) then "    \\draw[fr, ultra thick] (2,0) rectangle (3,1);\n" endif ++
    if fix(uFMC[r,12] == 1) then "    \\draw[fr, ultra thick] (3,3) rectangle (4,4);\n" endif ++
    if fix(uFMC[r,13] == 1) then "    \\draw[fr, ultra thick] (3,2) rectangle (4,3);\n" endif ++
    if fix(uFMC[r,14] == 1) then "    \\draw[fr, ultra thick] (3,1) rectangle (4,2);\n" endif ++
    if fix(uFMC[r,15] == 1) then "    \\draw[fr, ultra thick] (3,0) rectangle (4,1);\n" endif ++
  if r < Rb-1 then
    if fix(uSSB[r+1, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 0]) == fix(uSSB[r+1, 0]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 0]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 1]) == fix(uSSB[r+1, 1]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 1]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 2]) == fix(uSSB[r+1, 2]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 2]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 3]) == fix(uSSB[r+1, 3]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 3]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 4]) == fix(uSSB[r+1, 4]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 4]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 5]) == fix(uSSB[r+1, 5]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 5]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 6]) == fix(uSSB[r+1, 6]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 6]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 7]) == fix(uSSB[r+1, 7]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 7]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 8]) == fix(uSSB[r+1, 8]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 8]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 9]) == fix(uSSB[r+1, 9]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 9]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1,10]) == fix(uSSB[r+1,10]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1,10]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1,11]) == fix(uSSB[r+1,11]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1,11]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1,12]) == fix(uSSB[r+1,12]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1,12]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1,13]) == fix(uSSB[r+1,13]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1,13]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1,14]) == fix(uSSB[r+1,14]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1,14]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1,15]) == fix(uSSB[r+1,15]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1,15]) ++ "}$}};\n" endif
  endif ++ 
    "    \\draw[->] (4,2) --  +(2,0);\n" ++
    "    \\node at (5,2) {$\\oplus$};\n"++
    "  \\end{scope}\n" ++

    "\\end{scope}\n\n"
    
  else 
    "\\begin{scope}[yshift=-" ++ show(((r-1)/2)*6) ++ "cm]\n" ++
    "  \\begin{scope}[xshift=" ++ show(29) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta X_" ++ show(r) ++ "$};\n" ++
    if fix(uXSB[r, 0]+uYSB[r, 0] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 0]+uYSB[r, 0] == 2) then "tt" elseif fix(uXSB[r, 0]+uYSB[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(uXSB[r, 1]+uYSB[r, 1] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 1]+uYSB[r, 1] == 2) then "tt" elseif fix(uXSB[r, 1]+uYSB[r, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(uXSB[r, 2]+uYSB[r, 2] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 2]+uYSB[r, 2] == 2) then "tt" elseif fix(uXSB[r, 2]+uYSB[r, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(uXSB[r, 3]+uYSB[r, 3] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 3]+uYSB[r, 3] == 2) then "tt" elseif fix(uXSB[r, 3]+uYSB[r, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(uXSB[r, 4]+uYSB[r, 4] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 4]+uYSB[r, 4] == 2) then "tt" elseif fix(uXSB[r, 4]+uYSB[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(uXSB[r, 5]+uYSB[r, 5] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 5]+uYSB[r, 5] == 2) then "tt" elseif fix(uXSB[r, 5]+uYSB[r, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(uXSB[r, 6]+uYSB[r, 6] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 6]+uYSB[r, 6] == 2) then "tt" elseif fix(uXSB[r, 6]+uYSB[r, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(uXSB[r, 7]+uYSB[r, 7] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 7]+uYSB[r, 7] == 2) then "tt" elseif fix(uXSB[r, 7]+uYSB[r, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(uXSB[r, 8]+uYSB[r, 8] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 8]+uYSB[r, 8] == 2) then "tt" elseif fix(uXSB[r, 8]+uYSB[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(uXSB[r, 9]+uYSB[r, 9] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 9]+uYSB[r, 9] == 2) then "tt" elseif fix(uXSB[r, 9]+uYSB[r, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(uXSB[r,10]+uYSB[r,10] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,10]+uYSB[r,10] == 2) then "tt" elseif fix(uXSB[r,10]+uYSB[r,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(uXSB[r,11]+uYSB[r,11] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,11]+uYSB[r,11] == 2) then "tt" elseif fix(uXSB[r,11]+uYSB[r,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(uXSB[r,12]+uYSB[r,12] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,12]+uYSB[r,12] == 2) then "tt" elseif fix(uXSB[r,12]+uYSB[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(uXSB[r,13]+uYSB[r,13] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,13]+uYSB[r,13] == 2) then "tt" elseif fix(uXSB[r,13]+uYSB[r,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(uXSB[r,14]+uYSB[r,14] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,14]+uYSB[r,14] == 2) then "tt" elseif fix(uXSB[r,14]+uYSB[r,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(uXSB[r,15]+uYSB[r,15] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,15]+uYSB[r,15] == 2) then "tt" elseif fix(uXSB[r,15]+uYSB[r,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    if fix(uVSB[r, 0] == 1) then "    \\draw[pattern=north west lines] (0,3) rectangle (1,4);\n" endif ++
    if fix(uVSB[r, 1] == 1) then "    \\draw[pattern=north west lines] (0,2) rectangle (1,3);\n" endif ++
    if fix(uVSB[r, 2] == 1) then "    \\draw[pattern=north west lines] (0,1) rectangle (1,2);\n" endif ++
    if fix(uVSB[r, 3] == 1) then "    \\draw[pattern=north west lines] (0,0) rectangle (1,1);\n" endif ++
    if fix(uVSB[r, 4] == 1) then "    \\draw[pattern=north west lines] (1,3) rectangle (2,4);\n" endif ++
    if fix(uVSB[r, 5] == 1) then "    \\draw[pattern=north west lines] (1,2) rectangle (2,3);\n" endif ++
    if fix(uVSB[r, 6] == 1) then "    \\draw[pattern=north west lines] (1,1) rectangle (2,2);\n" endif ++
    if fix(uVSB[r, 7] == 1) then "    \\draw[pattern=north west lines] (1,0) rectangle (2,1);\n" endif ++
    if fix(uVSB[r, 8] == 1) then "    \\draw[pattern=north west lines] (2,3) rectangle (3,4);\n" endif ++
    if fix(uVSB[r, 9] == 1) then "    \\draw[pattern=north west lines] (2,2) rectangle (3,3);\n" endif ++
    if fix(uVSB[r,10] == 1) then "    \\draw[pattern=north west lines] (2,1) rectangle (3,2);\n" endif ++
    if fix(uVSB[r,11] == 1) then "    \\draw[pattern=north west lines] (2,0) rectangle (3,1);\n" endif ++
    if fix(uVSB[r,12] == 1) then "    \\draw[pattern=north west lines] (3,3) rectangle (4,4);\n" endif ++
    if fix(uVSB[r,13] == 1) then "    \\draw[pattern=north west lines] (3,2) rectangle (4,3);\n" endif ++
    if fix(uVSB[r,14] == 1) then "    \\draw[pattern=north west lines] (3,1) rectangle (4,2);\n" endif ++
    if fix(uVSB[r,15] == 1) then "    \\draw[pattern=north west lines] (3,0) rectangle (4,1);\n" endif ++
    if fix(uSSB[r, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 0]) == fix(uSSB[r, 0]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 0]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 1]) == fix(uSSB[r, 1]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 1]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 2]) == fix(uSSB[r, 2]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 2]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 3]) == fix(uSSB[r, 3]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 3]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 4]) == fix(uSSB[r, 4]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 4]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 5]) == fix(uSSB[r, 5]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 5]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 6]) == fix(uSSB[r, 6]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 6]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 7]) == fix(uSSB[r, 7]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 7]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 8]) == fix(uSSB[r, 8]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 8]) ++ "}$}};\n" endif ++
    if fix(uSSB[r, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r, 9]) == fix(uSSB[r, 9]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r, 9]) ++ "}$}};\n" endif ++
    if fix(uSSB[r,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,10]) == fix(uSSB[r,10]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r,10]) ++ "}$}};\n" endif ++
    if fix(uSSB[r,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,11]) == fix(uSSB[r,11]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r,11]) ++ "}$}};\n" endif ++
    if fix(uSSB[r,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,12]) == fix(uSSB[r,12]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r,12]) ++ "}$}};\n" endif ++
    if fix(uSSB[r,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,13]) == fix(uSSB[r,13]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r,13]) ++ "}$}};\n" endif ++
    if fix(uSSB[r,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,14]) == fix(uSSB[r,14]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r,14]) ++ "}$}};\n" endif ++
    if fix(uSSB[r,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r,15]) == fix(uSSB[r,15]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r,15]) ++ "}$}};\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++    
    "    \\draw[->] (4,2) -- node[above] {\\tiny SB} node[below] {\\tiny SR} +(2,0);\n" ++
    "  \\end{scope}\n" ++ 

    % -----------------------------
    "  \\begin{scope}[xshift=" ++ show(35) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta Z_" ++ show(r) ++ "$};\n" ++
    if fix(uXSR[r, 0]+uYSR[r, 0] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 0]+uYSR[r, 0] == 2) then "tt" elseif fix(uXSR[r, 0]+uYSR[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(uXSR[r, 5]+uYSR[r, 5] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 5]+uYSR[r, 5] == 2) then "tt" elseif fix(uXSR[r, 5]+uYSR[r, 5] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(uXSR[r,10]+uYSR[r,10] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,10]+uYSR[r,10] == 2) then "tt" elseif fix(uXSR[r,10]+uYSR[r,10] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(uXSR[r,15]+uYSR[r,15] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,15]+uYSR[r,15] == 2) then "tt" elseif fix(uXSR[r,15]+uYSR[r,15] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(uXSR[r, 4]+uYSR[r, 4] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 4]+uYSR[r, 4] == 2) then "tt" elseif fix(uXSR[r, 4]+uYSR[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(uXSR[r, 9]+uYSR[r, 9] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 9]+uYSR[r, 9] == 2) then "tt" elseif fix(uXSR[r, 9]+uYSR[r, 9] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(uXSR[r,14]+uYSR[r,14] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,14]+uYSR[r,14] == 2) then "tt" elseif fix(uXSR[r,14]+uYSR[r,14] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(uXSR[r, 3]+uYSR[r, 3] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 3]+uYSR[r, 3] == 2) then "tt" elseif fix(uXSR[r, 3]+uYSR[r, 3] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(uXSR[r, 8]+uYSR[r, 8] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 8]+uYSR[r, 8] == 2) then "tt" elseif fix(uXSR[r, 8]+uYSR[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(uXSR[r,13]+uYSR[r,13] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,13]+uYSR[r,13] == 2) then "tt" elseif fix(uXSR[r,13]+uYSR[r,13] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(uXSR[r, 2]+uYSR[r, 2] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 2]+uYSR[r, 2] == 2) then "tt" elseif fix(uXSR[r, 2]+uYSR[r, 2] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(uXSR[r, 7]+uYSR[r, 7] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 7]+uYSR[r, 7] == 2) then "tt" elseif fix(uXSR[r, 7]+uYSR[r, 7] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(uXSR[r,12]+uYSR[r,12] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,12]+uYSR[r,12] == 2) then "tt" elseif fix(uXSR[r,12]+uYSR[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(uXSR[r, 1]+uYSR[r, 1] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 1]+uYSR[r, 1] == 2) then "tt" elseif fix(uXSR[r, 1]+uYSR[r, 1] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(uXSR[r, 6]+uYSR[r, 6] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 6]+uYSR[r, 6] == 2) then "tt" elseif fix(uXSR[r, 6]+uYSR[r, 6] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(uXSR[r,11]+uYSR[r,11] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,11]+uYSR[r,11] == 2) then "tt" elseif fix(uXSR[r,11]+uYSR[r,11] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    if fix(uVSR[r, 0] == 1) then "    \\draw[pattern=north west lines] (0,3) rectangle (1,4);\n" endif ++
    if fix(uVSR[r, 5] == 1) then "    \\draw[pattern=north west lines] (0,2) rectangle (1,3);\n" endif ++
    if fix(uVSR[r,10] == 1) then "    \\draw[pattern=north west lines] (0,1) rectangle (1,2);\n" endif ++
    if fix(uVSR[r,15] == 1) then "    \\draw[pattern=north west lines] (0,0) rectangle (1,1);\n" endif ++
    if fix(uVSR[r, 4] == 1) then "    \\draw[pattern=north west lines] (1,3) rectangle (2,4);\n" endif ++
    if fix(uVSR[r, 9] == 1) then "    \\draw[pattern=north west lines] (1,2) rectangle (2,3);\n" endif ++
    if fix(uVSR[r,14] == 1) then "    \\draw[pattern=north west lines] (1,1) rectangle (2,2);\n" endif ++
    if fix(uVSR[r, 3] == 1) then "    \\draw[pattern=north west lines] (1,0) rectangle (2,1);\n" endif ++
    if fix(uVSR[r, 8] == 1) then "    \\draw[pattern=north west lines] (2,3) rectangle (3,4);\n" endif ++
    if fix(uVSR[r,13] == 1) then "    \\draw[pattern=north west lines] (2,2) rectangle (3,3);\n" endif ++
    if fix(uVSR[r, 2] == 1) then "    \\draw[pattern=north west lines] (2,1) rectangle (3,2);\n" endif ++
    if fix(uVSR[r, 7] == 1) then "    \\draw[pattern=north west lines] (2,0) rectangle (3,1);\n" endif ++
    if fix(uVSR[r,12] == 1) then "    \\draw[pattern=north west lines] (3,3) rectangle (4,4);\n" endif ++
    if fix(uVSR[r, 1] == 1) then "    \\draw[pattern=north west lines] (3,2) rectangle (4,3);\n" endif ++
    if fix(uVSR[r, 6] == 1) then "    \\draw[pattern=north west lines] (3,1) rectangle (4,2);\n" endif ++
    if fix(uVSR[r,11] == 1) then "    \\draw[pattern=north west lines] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    if fix(uFSB[r, 0] == 1) then "    \\draw[fr, ultra thick] (0,3) rectangle (1,4);\n" endif ++
    if fix(uFSB[r, 5] == 1) then "    \\draw[fr, ultra thick] (0,2) rectangle (1,3);\n" endif ++
    if fix(uFSB[r,10] == 1) then "    \\draw[fr, ultra thick] (0,1) rectangle (1,2);\n" endif ++
    if fix(uFSB[r,15] == 1) then "    \\draw[fr, ultra thick] (0,0) rectangle (1,1);\n" endif ++
    if fix(uFSB[r, 4] == 1) then "    \\draw[fr, ultra thick] (1,3) rectangle (2,4);\n" endif ++
    if fix(uFSB[r, 9] == 1) then "    \\draw[fr, ultra thick] (1,2) rectangle (2,3);\n" endif ++
    if fix(uFSB[r,14] == 1) then "    \\draw[fr, ultra thick] (1,1) rectangle (2,2);\n" endif ++
    if fix(uFSB[r, 3] == 1) then "    \\draw[fr, ultra thick] (1,0) rectangle (2,1);\n" endif ++
    if fix(uFSB[r, 8] == 1) then "    \\draw[fr, ultra thick] (2,3) rectangle (3,4);\n" endif ++
    if fix(uFSB[r,13] == 1) then "    \\draw[fr, ultra thick] (2,2) rectangle (3,3);\n" endif ++
    if fix(uFSB[r, 2] == 1) then "    \\draw[fr, ultra thick] (2,1) rectangle (3,2);\n" endif ++
    if fix(uFSB[r, 7] == 1) then "    \\draw[fr, ultra thick] (2,0) rectangle (3,1);\n" endif ++
    if fix(uFSB[r,12] == 1) then "    \\draw[fr, ultra thick] (3,3) rectangle (4,4);\n" endif ++
    if fix(uFSB[r, 1] == 1) then "    \\draw[fr, ultra thick] (3,2) rectangle (4,3);\n" endif ++
    if fix(uFSB[r, 6] == 1) then "    \\draw[fr, ultra thick] (3,1) rectangle (4,2);\n" endif ++
    if fix(uFSB[r,11] == 1) then "    \\draw[fr, ultra thick] (3,0) rectangle (4,1);\n" endif ++
    if fix(uSMC[r, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 0]) == fix(uSMC[r, 0]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 0]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 1]) == fix(uSMC[r, 1]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 1]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 2]) == fix(uSMC[r, 2]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 2]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 3]) == fix(uSMC[r, 3]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 3]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 4]) == fix(uSMC[r, 4]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 4]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 5]) == fix(uSMC[r, 5]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 5]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 6]) == fix(uSMC[r, 6]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 6]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 7]) == fix(uSMC[r, 7]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 7]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 8]) == fix(uSMC[r, 8]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 8]) ++ "}$}};\n" endif ++
    if fix(uSMC[r, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r, 9]) == fix(uSMC[r, 9]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r, 9]) ++ "}$}};\n" endif ++
    if fix(uSMC[r,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r,10]) == fix(uSMC[r,10]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r,10]) ++ "}$}};\n" endif ++
    if fix(uSMC[r,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r,11]) == fix(uSMC[r,11]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r,11]) ++ "}$}};\n" endif ++
    if fix(uSMC[r,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r,12]) == fix(uSMC[r,12]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r,12]) ++ "}$}};\n" endif ++
    if fix(uSMC[r,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r,13]) == fix(uSMC[r,13]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r,13]) ++ "}$}};\n" endif ++
    if fix(uSMC[r,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r,14]) == fix(uSMC[r,14]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r,14]) ++ "}$}};\n" endif ++
    if fix(uSMC[r,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEMC[r,15]) == fix(uSMC[r,15]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSMC[r,15]) ++ "}$}};\n" endif ++
    "    \\draw[->] (4,2) -- node[above] {\\tiny MC} +(2,0);\n" ++
    if r == Rb-1 then "    \\node at (5,1.5)[below, fill opacity=0.5] {$\\stackrel{E_b}{\\leftarrow}$}\n"
    endif ++
    "  \\end{scope}\n" ++ 
    
    "  \\begin{scope}[xshift=" ++ show(41) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta W_" ++ show(r) ++ "$};\n" ++
    if fix(uXAK[r+1, 0]+uYAK[r+1, 0] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 0]+uYAK[r+1, 0] == 2) then "tt" elseif fix(uXAK[r+1, 0]+uYAK[r+1, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(uXAK[r+1, 1]+uYAK[r+1, 1] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 1]+uYAK[r+1, 1] == 2) then "tt" elseif fix(uXAK[r+1, 1]+uYAK[r+1, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(uXAK[r+1, 2]+uYAK[r+1, 2] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 2]+uYAK[r+1, 2] == 2) then "tt" elseif fix(uXAK[r+1, 2]+uYAK[r+1, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(uXAK[r+1, 3]+uYAK[r+1, 3] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 3]+uYAK[r+1, 3] == 2) then "tt" elseif fix(uXAK[r+1, 3]+uYAK[r+1, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(uXAK[r+1, 4]+uYAK[r+1, 4] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 4]+uYAK[r+1, 4] == 2) then "tt" elseif fix(uXAK[r+1, 4]+uYAK[r+1, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(uXAK[r+1, 5]+uYAK[r+1, 5] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 5]+uYAK[r+1, 5] == 2) then "tt" elseif fix(uXAK[r+1, 5]+uYAK[r+1, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(uXAK[r+1, 6]+uYAK[r+1, 6] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 6]+uYAK[r+1, 6] == 2) then "tt" elseif fix(uXAK[r+1, 6]+uYAK[r+1, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(uXAK[r+1, 7]+uYAK[r+1, 7] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 7]+uYAK[r+1, 7] == 2) then "tt" elseif fix(uXAK[r+1, 7]+uYAK[r+1, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(uXAK[r+1, 8]+uYAK[r+1, 8] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 8]+uYAK[r+1, 8] == 2) then "tt" elseif fix(uXAK[r+1, 8]+uYAK[r+1, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(uXAK[r+1, 9]+uYAK[r+1, 9] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 9]+uYAK[r+1, 9] == 2) then "tt" elseif fix(uXAK[r+1, 9]+uYAK[r+1, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(uXAK[r+1,10]+uYAK[r+1,10] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,10]+uYAK[r+1,10] == 2) then "tt" elseif fix(uXAK[r+1,10]+uYAK[r+1,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(uXAK[r+1,11]+uYAK[r+1,11] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,11]+uYAK[r+1,11] == 2) then "tt" elseif fix(uXAK[r+1,11]+uYAK[r+1,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(uXAK[r+1,12]+uYAK[r+1,12] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,12]+uYAK[r+1,12] == 2) then "tt" elseif fix(uXAK[r+1,12]+uYAK[r+1,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(uXAK[r+1,13]+uYAK[r+1,13] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,13]+uYAK[r+1,13] == 2) then "tt" elseif fix(uXAK[r+1,13]+uYAK[r+1,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(uXAK[r+1,14]+uYAK[r+1,14] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,14]+uYAK[r+1,14] == 2) then "tt" elseif fix(uXAK[r+1,14]+uYAK[r+1,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(uXAK[r+1,15]+uYAK[r+1,15] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,15]+uYAK[r+1,15] == 2) then "tt" elseif fix(uXAK[r+1,15]+uYAK[r+1,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    
    if fix(uVAK[r+1, 0] == 1) then "    \\draw[pattern=north west lines] (0,3) rectangle (1,4);\n" endif ++
    if fix(uVAK[r+1, 1] == 1) then "    \\draw[pattern=north west lines] (0,2) rectangle (1,3);\n" endif ++
    if fix(uVAK[r+1, 2] == 1) then "    \\draw[pattern=north west lines] (0,1) rectangle (1,2);\n" endif ++
    if fix(uVAK[r+1, 3] == 1) then "    \\draw[pattern=north west lines] (0,0) rectangle (1,1);\n" endif ++
    if fix(uVAK[r+1, 4] == 1) then "    \\draw[pattern=north west lines] (1,3) rectangle (2,4);\n" endif ++
    if fix(uVAK[r+1, 5] == 1) then "    \\draw[pattern=north west lines] (1,2) rectangle (2,3);\n" endif ++
    if fix(uVAK[r+1, 6] == 1) then "    \\draw[pattern=north west lines] (1,1) rectangle (2,2);\n" endif ++
    if fix(uVAK[r+1, 7] == 1) then "    \\draw[pattern=north west lines] (1,0) rectangle (2,1);\n" endif ++
    if fix(uVAK[r+1, 8] == 1) then "    \\draw[pattern=north west lines] (2,3) rectangle (3,4);\n" endif ++
    if fix(uVAK[r+1, 9] == 1) then "    \\draw[pattern=north west lines] (2,2) rectangle (3,3);\n" endif ++
    if fix(uVAK[r+1,10] == 1) then "    \\draw[pattern=north west lines] (2,1) rectangle (3,2);\n" endif ++
    if fix(uVAK[r+1,11] == 1) then "    \\draw[pattern=north west lines] (2,0) rectangle (3,1);\n" endif ++
    if fix(uVAK[r+1,12] == 1) then "    \\draw[pattern=north west lines] (3,3) rectangle (4,4);\n" endif ++
    if fix(uVAK[r+1,13] == 1) then "    \\draw[pattern=north west lines] (3,2) rectangle (4,3);\n" endif ++
    if fix(uVAK[r+1,14] == 1) then "    \\draw[pattern=north west lines] (3,1) rectangle (4,2);\n" endif ++
    if fix(uVAK[r+1,15] == 1) then "    \\draw[pattern=north west lines] (3,0) rectangle (4,1);\n" endif ++
    
    if fix(uFMC[r, 0] == 1) then "    \\draw[fr, ultra thick] (0,3) rectangle (1,4);\n" endif ++
    if fix(uFMC[r, 1] == 1) then "    \\draw[fr, ultra thick] (0,2) rectangle (1,3);\n" endif ++
    if fix(uFMC[r, 2] == 1) then "    \\draw[fr, ultra thick] (0,1) rectangle (1,2);\n" endif ++
    if fix(uFMC[r, 3] == 1) then "    \\draw[fr, ultra thick] (0,0) rectangle (1,1);\n" endif ++
    if fix(uFMC[r, 4] == 1) then "    \\draw[fr, ultra thick] (1,3) rectangle (2,4);\n" endif ++
    if fix(uFMC[r, 5] == 1) then "    \\draw[fr, ultra thick] (1,2) rectangle (2,3);\n" endif ++
    if fix(uFMC[r, 6] == 1) then "    \\draw[fr, ultra thick] (1,1) rectangle (2,2);\n" endif ++
    if fix(uFMC[r, 7] == 1) then "    \\draw[fr, ultra thick] (1,0) rectangle (2,1);\n" endif ++
    if fix(uFMC[r, 8] == 1) then "    \\draw[fr, ultra thick] (2,3) rectangle (3,4);\n" endif ++
    if fix(uFMC[r, 9] == 1) then "    \\draw[fr, ultra thick] (2,2) rectangle (3,3);\n" endif ++
    if fix(uFMC[r,10] == 1) then "    \\draw[fr, ultra thick] (2,1) rectangle (3,2);\n" endif ++
    if fix(uFMC[r,11] == 1) then "    \\draw[fr, ultra thick] (2,0) rectangle (3,1);\n" endif ++
    if fix(uFMC[r,12] == 1) then "    \\draw[fr, ultra thick] (3,3) rectangle (4,4);\n" endif ++
    if fix(uFMC[r,13] == 1) then "    \\draw[fr, ultra thick] (3,2) rectangle (4,3);\n" endif ++
    if fix(uFMC[r,14] == 1) then "    \\draw[fr, ultra thick] (3,1) rectangle (4,2);\n" endif ++
    if fix(uFMC[r,15] == 1) then "    \\draw[fr, ultra thick] (3,0) rectangle (4,1);\n" endif ++
  if r < Rb-1 then
    if fix(uSSB[r+1, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 0]) == fix(uSSB[r+1, 0]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 0]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 1]) == fix(uSSB[r+1, 1]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 1]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 2]) == fix(uSSB[r+1, 2]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 2]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 3]) == fix(uSSB[r+1, 3]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 3]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 4]) == fix(uSSB[r+1, 4]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 4]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 5]) == fix(uSSB[r+1, 5]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 5]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 6]) == fix(uSSB[r+1, 6]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 6]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 7]) == fix(uSSB[r+1, 7]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 7]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 8]) == fix(uSSB[r+1, 8]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 8]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1, 9]) == fix(uSSB[r+1, 9]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1, 9]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1,10]) == fix(uSSB[r+1,10]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1,10]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1,11]) == fix(uSSB[r+1,11]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1,11]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1,12]) == fix(uSSB[r+1,12]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1,12]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1,13]) == fix(uSSB[r+1,13]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1,13]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1,14]) == fix(uSSB[r+1,14]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1,14]) ++ "}$}};\n" endif ++
    if fix(uSSB[r+1,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uESB[r+1,15]) == fix(uSSB[r+1,15]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(uSSB[r+1,15]) ++ "}$}};\n" endif
    endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    "    \\draw[->] (4,2) --  +(1,0);\n" ++
%     "    \\node at (5,2) {$\\oplus$};\n"++
    "  \\end{scope}\n" ++
    
    "  \\begin{scope}[xshift=" ++ show(46) ++ "cm]\n" ++    
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta STK_" ++ show(r) ++ "$};\n" ++
    if fix(uSTK[r, 0]) == 1 then "    \\fill[fk] (0,3) rectangle (1,4);\n" endif ++
    if fix(uSTK[r, 1]) == 1 then "    \\fill[fk] (0,2) rectangle (1,3);\n" endif ++
    if fix(uSTK[r, 2]) == 1 then "    \\fill[fk] (0,1) rectangle (1,2);\n" endif ++
    if fix(uSTK[r, 3]) == 1 then "    \\fill[fk] (0,0) rectangle (1,1);\n" endif ++
    if fix(uSTK[r, 4]) == 1 then "    \\fill[fk] (1,3) rectangle (2,4);\n" endif ++
    if fix(uSTK[r, 5]) == 1 then "    \\fill[fk] (1,2) rectangle (2,3);\n" endif ++
    if fix(uSTK[r, 6]) == 1 then "    \\fill[fk] (1,1) rectangle (2,2);\n" endif ++
    if fix(uSTK[r, 7]) == 1 then "    \\fill[fk] (1,0) rectangle (2,1);\n" endif ++
    if fix(uSTK[r, 8]) == 1 then "    \\fill[fk] (2,3) rectangle (3,4);\n" endif ++
    if fix(uSTK[r, 9]) == 1 then "    \\fill[fk] (2,2) rectangle (3,3);\n" endif ++
    if fix(uSTK[r,10]) == 1 then "    \\fill[fk] (2,1) rectangle (3,2);\n" endif ++
    if fix(uSTK[r,11]) == 1 then "    \\fill[fk] (2,0) rectangle (3,1);\n" endif ++
    if fix(uSTK[r,12]) == 1 then "    \\fill[fk] (3,3) rectangle (4,4);\n" endif ++
    if fix(uSTK[r,13]) == 1 then "    \\fill[fk] (3,2) rectangle (4,3);\n" endif ++
    if fix(uSTK[r,14]) == 1 then "    \\fill[fk] (3,1) rectangle (4,2);\n" endif ++
    if fix(uSTK[r,15]) == 1 then "    \\fill[fk] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    if fix(uGSTK[r, 0]) == 1 then "    \\draw[gk, ultra thick] (0,3) rectangle (1,4);\n" endif ++
    if fix(uGSTK[r, 1]) == 1 then "    \\draw[gk, ultra thick] (0,2) rectangle (1,3);\n" endif ++
    if fix(uGSTK[r, 2]) == 1 then "    \\draw[gk, ultra thick] (0,1) rectangle (1,2);\n" endif ++
    if fix(uGSTK[r, 3]) == 1 then "    \\draw[gk, ultra thick] (0,0) rectangle (1,1);\n" endif ++
    if fix(uGSTK[r, 4]) == 1 then "    \\draw[gk, ultra thick] (1,3) rectangle (2,4);\n" endif ++
    if fix(uGSTK[r, 5]) == 1 then "    \\draw[gk, ultra thick] (1,2) rectangle (2,3);\n" endif ++
    if fix(uGSTK[r, 6]) == 1 then "    \\draw[gk, ultra thick] (1,1) rectangle (2,2);\n" endif ++
    if fix(uGSTK[r, 7]) == 1 then "    \\draw[gk, ultra thick] (1,0) rectangle (2,1);\n" endif ++
    if fix(uGSTK[r, 8]) == 1 then "    \\draw[gk, ultra thick] (2,3) rectangle (3,4);\n" endif ++
    if fix(uGSTK[r, 9]) == 1 then "    \\draw[gk, ultra thick] (2,2) rectangle (3,3);\n" endif ++
    if fix(uGSTK[r,10]) == 1 then "    \\draw[gk, ultra thick] (2,1) rectangle (3,2);\n" endif ++
    if fix(uGSTK[r,11]) == 1 then "    \\draw[gk, ultra thick] (2,0) rectangle (3,1);\n" endif ++
    if fix(uGSTK[r,12]) == 1 then "    \\draw[gk, ultra thick] (3,3) rectangle (4,4);\n" endif ++
    if fix(uGSTK[r,13]) == 1 then "    \\draw[gk, ultra thick] (3,2) rectangle (4,3);\n" endif ++
    if fix(uGSTK[r,14]) == 1 then "    \\draw[gk, ultra thick] (3,1) rectangle (4,2);\n" endif ++
    if fix(uGSTK[r,15]) == 1 then "    \\draw[gk, ultra thick] (3,0) rectangle (4,1);\n" endif ++
    if fix(uSGK[r, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 0]) == fix(uSGK[r, 0]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 0]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 1]) == fix(uSGK[r, 1]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 1]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 2]) == fix(uSGK[r, 2]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 2]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 3]) == fix(uSGK[r, 3]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 3]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 4]) == fix(uSGK[r, 4]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 4]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 5]) == fix(uSGK[r, 5]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 5]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 6]) == fix(uSGK[r, 6]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 6]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 7]) == fix(uSGK[r, 7]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 7]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 8]) == fix(uSGK[r, 8]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 8]) ++ "}$};\n" endif ++
    if fix(uSGK[r, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r, 9]) == fix(uSGK[r, 9]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r, 9]) ++ "}$};\n" endif ++
    if fix(uSGK[r,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r,10]) == fix(uSGK[r,10]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r,10]) ++ "}$};\n" endif ++
    if fix(uSGK[r,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r,11]) == fix(uSGK[r,11]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r,11]) ++ "}$};\n" endif ++
    if fix(uSGK[r,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r,12]) == fix(uSGK[r,12]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r,12]) ++ "}$};\n" endif ++
    if fix(uSGK[r,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r,13]) == fix(uSGK[r,13]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r,13]) ++ "}$};\n" endif ++
    if fix(uSGK[r,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r,14]) == fix(uSGK[r,14]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r,14]) ++ "}$};\n" endif ++
    if fix(uSGK[r,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(uEGK[r,15]) == fix(uSGK[r,15]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(uSGK[r,15]) ++ "}$};\n" endif ++
    "    \\draw[->] (2,4) -- ++(0,0.5) --++(-20,0) --++(0,-2.2);\n" ++
    "  \\end{scope}\n" ++

    "\\end{scope}\n\n"
    endif
    | r in 0..Rb-1];


% === draw for Eu+Em ===
output[
if r mod 2 == 1 then 
    "\\begin{scope}[yshift=-" ++ show(((r-1)/2)*6) ++ "cm]\n" ++    
    "  \\begin{scope}[xshift=" ++ show(29) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta X_" ++ show(r) ++ "$};\n" ++
	  if fix(uXSB[r, 0]+uYSB[r, 0] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 0]+uYSB[r, 0] == 2) then "tt" elseif fix(uXSB[r, 0]+uYSB[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(uXSB[r, 1]+uYSB[r, 1] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 1]+uYSB[r, 1] == 2) then "tt" elseif fix(uXSB[r, 1]+uYSB[r, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(uXSB[r, 2]+uYSB[r, 2] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 2]+uYSB[r, 2] == 2) then "tt" elseif fix(uXSB[r, 2]+uYSB[r, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(uXSB[r, 3]+uYSB[r, 3] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 3]+uYSB[r, 3] == 2) then "tt" elseif fix(uXSB[r, 3]+uYSB[r, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(uXSB[r, 4]+uYSB[r, 4] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 4]+uYSB[r, 4] == 2) then "tt" elseif fix(uXSB[r, 4]+uYSB[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(uXSB[r, 5]+uYSB[r, 5] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 5]+uYSB[r, 5] == 2) then "tt" elseif fix(uXSB[r, 5]+uYSB[r, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(uXSB[r, 6]+uYSB[r, 6] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 6]+uYSB[r, 6] == 2) then "tt" elseif fix(uXSB[r, 6]+uYSB[r, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(uXSB[r, 7]+uYSB[r, 7] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 7]+uYSB[r, 7] == 2) then "tt" elseif fix(uXSB[r, 7]+uYSB[r, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(uXSB[r, 8]+uYSB[r, 8] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 8]+uYSB[r, 8] == 2) then "tt" elseif fix(uXSB[r, 8]+uYSB[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(uXSB[r, 9]+uYSB[r, 9] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 9]+uYSB[r, 9] == 2) then "tt" elseif fix(uXSB[r, 9]+uYSB[r, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(uXSB[r,10]+uYSB[r,10] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,10]+uYSB[r,10] == 2) then "tt" elseif fix(uXSB[r,10]+uYSB[r,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(uXSB[r,11]+uYSB[r,11] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,11]+uYSB[r,11] == 2) then "tt" elseif fix(uXSB[r,11]+uYSB[r,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(uXSB[r,12]+uYSB[r,12] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,12]+uYSB[r,12] == 2) then "tt" elseif fix(uXSB[r,12]+uYSB[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(uXSB[r,13]+uYSB[r,13] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,13]+uYSB[r,13] == 2) then "tt" elseif fix(uXSB[r,13]+uYSB[r,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(uXSB[r,14]+uYSB[r,14] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,14]+uYSB[r,14] == 2) then "tt" elseif fix(uXSB[r,14]+uYSB[r,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(uXSB[r,15]+uYSB[r,15] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,15]+uYSB[r,15] == 2) then "tt" elseif fix(uXSB[r,15]+uYSB[r,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    "    \\draw[->] (4,2) -- node[above] {\\tiny SB} node[below] {\\tiny SR} +(2,0);\n" ++
    "  \\end{scope}\n" ++
    
  % -----------------------------
    "  \\begin{scope}[xshift=" ++ show(35) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta Z_" ++ show(r) ++ "$};\n" ++
    if fix(uXSR[r, 0]+uYSR[r, 0] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 0]+uYSR[r, 0] == 2) then "tt" elseif fix(uXSR[r, 0]+uYSR[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(uXSR[r, 5]+uYSR[r, 5] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 5]+uYSR[r, 5] == 2) then "tt" elseif fix(uXSR[r, 5]+uYSR[r, 5] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(uXSR[r,10]+uYSR[r,10] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,10]+uYSR[r,10] == 2) then "tt" elseif fix(uXSR[r,10]+uYSR[r,10] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(uXSR[r,15]+uYSR[r,15] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,15]+uYSR[r,15] == 2) then "tt" elseif fix(uXSR[r,15]+uYSR[r,15] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(uXSR[r, 4]+uYSR[r, 4] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 4]+uYSR[r, 4] == 2) then "tt" elseif fix(uXSR[r, 4]+uYSR[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(uXSR[r, 9]+uYSR[r, 9] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 9]+uYSR[r, 9] == 2) then "tt" elseif fix(uXSR[r, 9]+uYSR[r, 9] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(uXSR[r,14]+uYSR[r,14] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,14]+uYSR[r,14] == 2) then "tt" elseif fix(uXSR[r,14]+uYSR[r,14] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(uXSR[r, 3]+uYSR[r, 3] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 3]+uYSR[r, 3] == 2) then "tt" elseif fix(uXSR[r, 3]+uYSR[r, 3] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(uXSR[r, 8]+uYSR[r, 8] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 8]+uYSR[r, 8] == 2) then "tt" elseif fix(uXSR[r, 8]+uYSR[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(uXSR[r,13]+uYSR[r,13] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,13]+uYSR[r,13] == 2) then "tt" elseif fix(uXSR[r,13]+uYSR[r,13] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(uXSR[r, 2]+uYSR[r, 2] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 2]+uYSR[r, 2] == 2) then "tt" elseif fix(uXSR[r, 2]+uYSR[r, 2] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(uXSR[r, 7]+uYSR[r, 7] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 7]+uYSR[r, 7] == 2) then "tt" elseif fix(uXSR[r, 7]+uYSR[r, 7] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(uXSR[r,12]+uYSR[r,12] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,12]+uYSR[r,12] == 2) then "tt" elseif fix(uXSR[r,12]+uYSR[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(uXSR[r, 1]+uYSR[r, 1] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 1]+uYSR[r, 1] == 2) then "tt" elseif fix(uXSR[r, 1]+uYSR[r, 1] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(uXSR[r, 6]+uYSR[r, 6] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 6]+uYSR[r, 6] == 2) then "tt" elseif fix(uXSR[r, 6]+uYSR[r, 6] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(uXSR[r,11]+uYSR[r,11] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,11]+uYSR[r,11] == 2) then "tt" elseif fix(uXSR[r,11]+uYSR[r,11] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    if r != Rb+Ru+Rm-1 then
    "    \\draw[->] (4,2) -- node[above] {\\tiny MC} +(2,0);\n"
    endif ++
    "  \\end{scope}\n" ++ 
    
  if r != Rb+Ru+Rm-1 then
    "  \\begin{scope}[xshift=" ++ show(41) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta W_" ++ show(r) ++ "$};\n" ++
	  if fix(uXAK[r+1, 0]+uYAK[r+1, 0] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 0]+uYAK[r+1, 0] == 2) then "tt" elseif fix(uXAK[r+1, 0]+uYAK[r+1, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(uXAK[r+1, 1]+uYAK[r+1, 1] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 1]+uYAK[r+1, 1] == 2) then "tt" elseif fix(uXAK[r+1, 1]+uYAK[r+1, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(uXAK[r+1, 2]+uYAK[r+1, 2] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 2]+uYAK[r+1, 2] == 2) then "tt" elseif fix(uXAK[r+1, 2]+uYAK[r+1, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(uXAK[r+1, 3]+uYAK[r+1, 3] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 3]+uYAK[r+1, 3] == 2) then "tt" elseif fix(uXAK[r+1, 3]+uYAK[r+1, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(uXAK[r+1, 4]+uYAK[r+1, 4] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 4]+uYAK[r+1, 4] == 2) then "tt" elseif fix(uXAK[r+1, 4]+uYAK[r+1, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(uXAK[r+1, 5]+uYAK[r+1, 5] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 5]+uYAK[r+1, 5] == 2) then "tt" elseif fix(uXAK[r+1, 5]+uYAK[r+1, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(uXAK[r+1, 6]+uYAK[r+1, 6] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 6]+uYAK[r+1, 6] == 2) then "tt" elseif fix(uXAK[r+1, 6]+uYAK[r+1, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(uXAK[r+1, 7]+uYAK[r+1, 7] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 7]+uYAK[r+1, 7] == 2) then "tt" elseif fix(uXAK[r+1, 7]+uYAK[r+1, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(uXAK[r+1, 8]+uYAK[r+1, 8] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 8]+uYAK[r+1, 8] == 2) then "tt" elseif fix(uXAK[r+1, 8]+uYAK[r+1, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(uXAK[r+1, 9]+uYAK[r+1, 9] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 9]+uYAK[r+1, 9] == 2) then "tt" elseif fix(uXAK[r+1, 9]+uYAK[r+1, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(uXAK[r+1,10]+uYAK[r+1,10] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,10]+uYAK[r+1,10] == 2) then "tt" elseif fix(uXAK[r+1,10]+uYAK[r+1,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(uXAK[r+1,11]+uYAK[r+1,11] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,11]+uYAK[r+1,11] == 2) then "tt" elseif fix(uXAK[r+1,11]+uYAK[r+1,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(uXAK[r+1,12]+uYAK[r+1,12] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,12]+uYAK[r+1,12] == 2) then "tt" elseif fix(uXAK[r+1,12]+uYAK[r+1,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(uXAK[r+1,13]+uYAK[r+1,13] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,13]+uYAK[r+1,13] == 2) then "tt" elseif fix(uXAK[r+1,13]+uYAK[r+1,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(uXAK[r+1,14]+uYAK[r+1,14] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,14]+uYAK[r+1,14] == 2) then "tt" elseif fix(uXAK[r+1,14]+uYAK[r+1,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(uXAK[r+1,15]+uYAK[r+1,15] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,15]+uYAK[r+1,15] == 2) then "tt" elseif fix(uXAK[r+1,15]+uYAK[r+1,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    "  \\end{scope}\n"
  endif ++
    
    "  \\begin{scope}[xshift=" ++ show(46) ++ "cm]\n" ++    
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta STK_" ++ show(r) ++ "$};\n" ++
    if fix(uSTK[r, 0]) == 1 then "    \\fill[fk] (0,3) rectangle (1,4);\n" endif ++
    if fix(uSTK[r, 1]) == 1 then "    \\fill[fk] (0,2) rectangle (1,3);\n" endif ++
    if fix(uSTK[r, 2]) == 1 then "    \\fill[fk] (0,1) rectangle (1,2);\n" endif ++
    if fix(uSTK[r, 3]) == 1 then "    \\fill[fk] (0,0) rectangle (1,1);\n" endif ++
    if fix(uSTK[r, 4]) == 1 then "    \\fill[fk] (1,3) rectangle (2,4);\n" endif ++
    if fix(uSTK[r, 5]) == 1 then "    \\fill[fk] (1,2) rectangle (2,3);\n" endif ++
    if fix(uSTK[r, 6]) == 1 then "    \\fill[fk] (1,1) rectangle (2,2);\n" endif ++
    if fix(uSTK[r, 7]) == 1 then "    \\fill[fk] (1,0) rectangle (2,1);\n" endif ++
    if fix(uSTK[r, 8]) == 1 then "    \\fill[fk] (2,3) rectangle (3,4);\n" endif ++
    if fix(uSTK[r, 9]) == 1 then "    \\fill[fk] (2,2) rectangle (3,3);\n" endif ++
    if fix(uSTK[r,10]) == 1 then "    \\fill[fk] (2,1) rectangle (3,2);\n" endif ++
    if fix(uSTK[r,11]) == 1 then "    \\fill[fk] (2,0) rectangle (3,1);\n" endif ++
    if fix(uSTK[r,12]) == 1 then "    \\fill[fk] (3,3) rectangle (4,4);\n" endif ++
    if fix(uSTK[r,13]) == 1 then "    \\fill[fk] (3,2) rectangle (4,3);\n" endif ++
    if fix(uSTK[r,14]) == 1 then "    \\fill[fk] (3,1) rectangle (4,2);\n" endif ++
    if fix(uSTK[r,15]) == 1 then "    \\fill[fk] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    "    \\draw[->] (2,4) -- ++(0,0.5) --++(-20,0) --++(0,-2.2);\n" ++
    "  \\end{scope}\n" ++
    
    
    "\\end{scope}\n\n" 
    
    
else 
    "\\begin{scope}[yshift=-" ++ show((r/2)*6) ++ "cm]\n" ++
    "  \\begin{scope}[xshift=" ++ show(0) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta STK_" ++ show(r) ++ "$};\n" ++
    if fix(uSTK[r, 0]) == 1 then "    \\fill[fk] (0,3) rectangle (1,4);\n" endif ++
    if fix(uSTK[r, 1]) == 1 then "    \\fill[fk] (0,2) rectangle (1,3);\n" endif ++
    if fix(uSTK[r, 2]) == 1 then "    \\fill[fk] (0,1) rectangle (1,2);\n" endif ++
    if fix(uSTK[r, 3]) == 1 then "    \\fill[fk] (0,0) rectangle (1,1);\n" endif ++
    if fix(uSTK[r, 4]) == 1 then "    \\fill[fk] (1,3) rectangle (2,4);\n" endif ++
    if fix(uSTK[r, 5]) == 1 then "    \\fill[fk] (1,2) rectangle (2,3);\n" endif ++
    if fix(uSTK[r, 6]) == 1 then "    \\fill[fk] (1,1) rectangle (2,2);\n" endif ++
    if fix(uSTK[r, 7]) == 1 then "    \\fill[fk] (1,0) rectangle (2,1);\n" endif ++
    if fix(uSTK[r, 8]) == 1 then "    \\fill[fk] (2,3) rectangle (3,4);\n" endif ++
    if fix(uSTK[r, 9]) == 1 then "    \\fill[fk] (2,2) rectangle (3,3);\n" endif ++
    if fix(uSTK[r,10]) == 1 then "    \\fill[fk] (2,1) rectangle (3,2);\n" endif ++
    if fix(uSTK[r,11]) == 1 then "    \\fill[fk] (2,0) rectangle (3,1);\n" endif ++
    if fix(uSTK[r,12]) == 1 then "    \\fill[fk] (3,3) rectangle (4,4);\n" endif ++
    if fix(uSTK[r,13]) == 1 then "    \\fill[fk] (3,2) rectangle (4,3);\n" endif ++
    if fix(uSTK[r,14]) == 1 then "    \\fill[fk] (3,1) rectangle (4,2);\n" endif ++
    if fix(uSTK[r,15]) == 1 then "    \\fill[fk] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    "  \\end{scope}\n" ++
    
    "  \\begin{scope}[xshift=" ++ show(5) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta " ++ if r==0 then "P" else "W_" ++ show(r-1) endif ++ "$};\n" ++
    if fix(uXAK[r, 0]+uYAK[r, 0] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 0]+uYAK[r, 0] == 2) then "tt" elseif fix(uXAK[r, 0]+uYAK[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(uXAK[r, 1]+uYAK[r, 1] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 1]+uYAK[r, 1] == 2) then "tt" elseif fix(uXAK[r, 1]+uYAK[r, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(uXAK[r, 2]+uYAK[r, 2] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 2]+uYAK[r, 2] == 2) then "tt" elseif fix(uXAK[r, 2]+uYAK[r, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(uXAK[r, 3]+uYAK[r, 3] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 3]+uYAK[r, 3] == 2) then "tt" elseif fix(uXAK[r, 3]+uYAK[r, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(uXAK[r, 4]+uYAK[r, 4] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 4]+uYAK[r, 4] == 2) then "tt" elseif fix(uXAK[r, 4]+uYAK[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(uXAK[r, 5]+uYAK[r, 5] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 5]+uYAK[r, 5] == 2) then "tt" elseif fix(uXAK[r, 5]+uYAK[r, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(uXAK[r, 6]+uYAK[r, 6] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 6]+uYAK[r, 6] == 2) then "tt" elseif fix(uXAK[r, 6]+uYAK[r, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(uXAK[r, 7]+uYAK[r, 7] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 7]+uYAK[r, 7] == 2) then "tt" elseif fix(uXAK[r, 7]+uYAK[r, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(uXAK[r, 8]+uYAK[r, 8] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 8]+uYAK[r, 8] == 2) then "tt" elseif fix(uXAK[r, 8]+uYAK[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(uXAK[r, 9]+uYAK[r, 9] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r, 9]+uYAK[r, 9] == 2) then "tt" elseif fix(uXAK[r, 9]+uYAK[r, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(uXAK[r,10]+uYAK[r,10] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r,10]+uYAK[r,10] == 2) then "tt" elseif fix(uXAK[r,10]+uYAK[r,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(uXAK[r,11]+uYAK[r,11] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r,11]+uYAK[r,11] == 2) then "tt" elseif fix(uXAK[r,11]+uYAK[r,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(uXAK[r,12]+uYAK[r,12] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r,12]+uYAK[r,12] == 2) then "tt" elseif fix(uXAK[r,12]+uYAK[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(uXAK[r,13]+uYAK[r,13] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r,13]+uYAK[r,13] == 2) then "tt" elseif fix(uXAK[r,13]+uYAK[r,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(uXAK[r,14]+uYAK[r,14] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r,14]+uYAK[r,14] == 2) then "tt" elseif fix(uXAK[r,14]+uYAK[r,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(uXAK[r,15]+uYAK[r,15] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r,15]+uYAK[r,15] == 2) then "tt" elseif fix(uXAK[r,15]+uYAK[r,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    "    \\draw[->] (4,2) -- +(2,0);\n" ++ 
    "    \\draw[->] (-3,4)--++(0,0.5) --++(8,0)--++(0,-2.2);\n" ++
    "    \\node at (5,2) {$\\oplus$};\n" ++
    "  \\end{scope}\n" ++ 
    
% -----------------------------
    "  \\begin{scope}[xshift=" ++ show(11) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta X_" ++ show(r) ++ "$};\n" ++
    if fix(uXSB[r, 0]+uYSB[r, 0] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 0]+uYSB[r, 0] == 2) then "tt" elseif fix(uXSB[r, 0]+uYSB[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(uXSB[r, 1]+uYSB[r, 1] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 1]+uYSB[r, 1] == 2) then "tt" elseif fix(uXSB[r, 1]+uYSB[r, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(uXSB[r, 2]+uYSB[r, 2] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 2]+uYSB[r, 2] == 2) then "tt" elseif fix(uXSB[r, 2]+uYSB[r, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(uXSB[r, 3]+uYSB[r, 3] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 3]+uYSB[r, 3] == 2) then "tt" elseif fix(uXSB[r, 3]+uYSB[r, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(uXSB[r, 4]+uYSB[r, 4] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 4]+uYSB[r, 4] == 2) then "tt" elseif fix(uXSB[r, 4]+uYSB[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(uXSB[r, 5]+uYSB[r, 5] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 5]+uYSB[r, 5] == 2) then "tt" elseif fix(uXSB[r, 5]+uYSB[r, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(uXSB[r, 6]+uYSB[r, 6] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 6]+uYSB[r, 6] == 2) then "tt" elseif fix(uXSB[r, 6]+uYSB[r, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(uXSB[r, 7]+uYSB[r, 7] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 7]+uYSB[r, 7] == 2) then "tt" elseif fix(uXSB[r, 7]+uYSB[r, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(uXSB[r, 8]+uYSB[r, 8] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 8]+uYSB[r, 8] == 2) then "tt" elseif fix(uXSB[r, 8]+uYSB[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(uXSB[r, 9]+uYSB[r, 9] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r, 9]+uYSB[r, 9] == 2) then "tt" elseif fix(uXSB[r, 9]+uYSB[r, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(uXSB[r,10]+uYSB[r,10] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,10]+uYSB[r,10] == 2) then "tt" elseif fix(uXSB[r,10]+uYSB[r,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(uXSB[r,11]+uYSB[r,11] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,11]+uYSB[r,11] == 2) then "tt" elseif fix(uXSB[r,11]+uYSB[r,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(uXSB[r,12]+uYSB[r,12] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,12]+uYSB[r,12] == 2) then "tt" elseif fix(uXSB[r,12]+uYSB[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(uXSB[r,13]+uYSB[r,13] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,13]+uYSB[r,13] == 2) then "tt" elseif fix(uXSB[r,13]+uYSB[r,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(uXSB[r,14]+uYSB[r,14] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,14]+uYSB[r,14] == 2) then "tt" elseif fix(uXSB[r,14]+uYSB[r,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(uXSB[r,15]+uYSB[r,15] > 0) then 
    "    \\fill[" ++ if fix(uXSB[r,15]+uYSB[r,15] == 2) then "tt" elseif fix(uXSB[r,15]+uYSB[r,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++    
    "    \\draw[->] (4,2) -- node[above] {\\tiny SB} node[below] {\\tiny SR} +(2,0);\n" ++
    "  \\end{scope}\n" ++ 

    % -----------------------------
    "  \\begin{scope}[xshift=" ++ show(17) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta Z_" ++ show(r) ++ "$};\n" ++
    if fix(uXSR[r, 0]+uYSR[r, 0] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 0]+uYSR[r, 0] == 2) then "tt" elseif fix(uXSR[r, 0]+uYSR[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(uXSR[r, 5]+uYSR[r, 5] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 5]+uYSR[r, 5] == 2) then "tt" elseif fix(uXSR[r, 5]+uYSR[r, 5] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(uXSR[r,10]+uYSR[r,10] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,10]+uYSR[r,10] == 2) then "tt" elseif fix(uXSR[r,10]+uYSR[r,10] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(uXSR[r,15]+uYSR[r,15] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,15]+uYSR[r,15] == 2) then "tt" elseif fix(uXSR[r,15]+uYSR[r,15] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(uXSR[r, 4]+uYSR[r, 4] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 4]+uYSR[r, 4] == 2) then "tt" elseif fix(uXSR[r, 4]+uYSR[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(uXSR[r, 9]+uYSR[r, 9] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 9]+uYSR[r, 9] == 2) then "tt" elseif fix(uXSR[r, 9]+uYSR[r, 9] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(uXSR[r,14]+uYSR[r,14] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,14]+uYSR[r,14] == 2) then "tt" elseif fix(uXSR[r,14]+uYSR[r,14] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(uXSR[r, 3]+uYSR[r, 3] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 3]+uYSR[r, 3] == 2) then "tt" elseif fix(uXSR[r, 3]+uYSR[r, 3] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(uXSR[r, 8]+uYSR[r, 8] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 8]+uYSR[r, 8] == 2) then "tt" elseif fix(uXSR[r, 8]+uYSR[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(uXSR[r,13]+uYSR[r,13] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,13]+uYSR[r,13] == 2) then "tt" elseif fix(uXSR[r,13]+uYSR[r,13] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(uXSR[r, 2]+uYSR[r, 2] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 2]+uYSR[r, 2] == 2) then "tt" elseif fix(uXSR[r, 2]+uYSR[r, 2] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(uXSR[r, 7]+uYSR[r, 7] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 7]+uYSR[r, 7] == 2) then "tt" elseif fix(uXSR[r, 7]+uYSR[r, 7] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(uXSR[r,12]+uYSR[r,12] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,12]+uYSR[r,12] == 2) then "tt" elseif fix(uXSR[r,12]+uYSR[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(uXSR[r, 1]+uYSR[r, 1] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 1]+uYSR[r, 1] == 2) then "tt" elseif fix(uXSR[r, 1]+uYSR[r, 1] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(uXSR[r, 6]+uYSR[r, 6] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r, 6]+uYSR[r, 6] == 2) then "tt" elseif fix(uXSR[r, 6]+uYSR[r, 6] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(uXSR[r,11]+uYSR[r,11] > 0) then 
    "    \\fill[" ++ if fix(uXSR[r,11]+uYSR[r,11] == 2) then "tt" elseif fix(uXSR[r,11]+uYSR[r,11] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    if r != Rb+Ru+Rm-1 then
    "    \\draw[->] (4,2) -- node[above] {\\tiny MC} +(2,0);\n"
    endif ++
    "  \\end{scope}\n" ++ 
    
  if r != Rb+Ru+Rm-1 then
    "  \\begin{scope}[xshift=" ++ show(23) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta W_" ++ show(r) ++ "$};\n" ++
    if fix(uXAK[r+1, 0]+uYAK[r+1, 0] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 0]+uYAK[r+1, 0] == 2) then "tt" elseif fix(uXAK[r+1, 0]+uYAK[r+1, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(uXAK[r+1, 1]+uYAK[r+1, 1] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 1]+uYAK[r+1, 1] == 2) then "tt" elseif fix(uXAK[r+1, 1]+uYAK[r+1, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(uXAK[r+1, 2]+uYAK[r+1, 2] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 2]+uYAK[r+1, 2] == 2) then "tt" elseif fix(uXAK[r+1, 2]+uYAK[r+1, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(uXAK[r+1, 3]+uYAK[r+1, 3] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 3]+uYAK[r+1, 3] == 2) then "tt" elseif fix(uXAK[r+1, 3]+uYAK[r+1, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(uXAK[r+1, 4]+uYAK[r+1, 4] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 4]+uYAK[r+1, 4] == 2) then "tt" elseif fix(uXAK[r+1, 4]+uYAK[r+1, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(uXAK[r+1, 5]+uYAK[r+1, 5] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 5]+uYAK[r+1, 5] == 2) then "tt" elseif fix(uXAK[r+1, 5]+uYAK[r+1, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(uXAK[r+1, 6]+uYAK[r+1, 6] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 6]+uYAK[r+1, 6] == 2) then "tt" elseif fix(uXAK[r+1, 6]+uYAK[r+1, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(uXAK[r+1, 7]+uYAK[r+1, 7] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 7]+uYAK[r+1, 7] == 2) then "tt" elseif fix(uXAK[r+1, 7]+uYAK[r+1, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(uXAK[r+1, 8]+uYAK[r+1, 8] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 8]+uYAK[r+1, 8] == 2) then "tt" elseif fix(uXAK[r+1, 8]+uYAK[r+1, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(uXAK[r+1, 9]+uYAK[r+1, 9] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1, 9]+uYAK[r+1, 9] == 2) then "tt" elseif fix(uXAK[r+1, 9]+uYAK[r+1, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(uXAK[r+1,10]+uYAK[r+1,10] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,10]+uYAK[r+1,10] == 2) then "tt" elseif fix(uXAK[r+1,10]+uYAK[r+1,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(uXAK[r+1,11]+uYAK[r+1,11] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,11]+uYAK[r+1,11] == 2) then "tt" elseif fix(uXAK[r+1,11]+uYAK[r+1,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(uXAK[r+1,12]+uYAK[r+1,12] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,12]+uYAK[r+1,12] == 2) then "tt" elseif fix(uXAK[r+1,12]+uYAK[r+1,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(uXAK[r+1,13]+uYAK[r+1,13] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,13]+uYAK[r+1,13] == 2) then "tt" elseif fix(uXAK[r+1,13]+uYAK[r+1,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(uXAK[r+1,14]+uYAK[r+1,14] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,14]+uYAK[r+1,14] == 2) then "tt" elseif fix(uXAK[r+1,14]+uYAK[r+1,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(uXAK[r+1,15]+uYAK[r+1,15] > 0) then 
    "    \\fill[" ++ if fix(uXAK[r+1,15]+uYAK[r+1,15] == 2) then "tt" elseif fix(uXAK[r+1,15]+uYAK[r+1,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    if r != Rb+Ru+Rm-1 then "    \\draw[->] (4,2) --  +(2,0);\n" ++ "    \\node at (5,2) {$\\oplus$};\n" endif ++
    "  \\end{scope}\n"
  endif ++
    
    "\\end{scope}\n"
    
    endif
    | r in Rb..Rb+Ru+Rm-1];
%XXXXXXXXXX
output[
    if (Rb+Ru+Rm-1) mod 2 == 0 then 
    "\\begin{scope}[yshift=-" ++ show(((Rb+Ru+Rm-1)/2)*6+2) ++ "cm]\n"
    else
    "\\begin{scope}[yshift=-" ++ show(((Rb+Ru+Rm-2)/2)*6+2) ++ "cm]\n"
    endif ++
    "\\draw[help lines, dashed, fill opacity=0.5] (2,0) -- (20,0);\n" ++
    "\\draw[help lines, dashed, fill opacity=0.5] (30,0) -- (48,0);\n" ++
    "\\node at(20.5,0)[right, fill opacity=0.5] {\\scriptsize $E_m: \\{\\Delta X_{" ++ show(Rb+Ru) ++ "} \\leftrightarrow \\Delta W_{" ++ show(Rb+Ru+Rm) ++ "}\\}$};\n" ++
    "\\end{scope}\n\n" 
    ];



var int: ypass = if (Rb+Ru) mod 2 == 0 then 8 else 13 endif;

% % === draw for Em + El ===
output[
if r mod 2 == 1 then 
    "\\begin{scope}[yshift=-" ++ show(((r-1)/2)*6+ypass) ++ "cm]\n" ++    
    "  \\begin{scope}[xshift=" ++ show(29) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta X_{" ++ show(r) ++ "}$};\n" ++
	  if fix(lXSB[r, 0]+lYSB[r, 0] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 0]+lYSB[r, 0] == 2) then "tt" elseif fix(lXSB[r, 0]+lYSB[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(lXSB[r, 1]+lYSB[r, 1] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 1]+lYSB[r, 1] == 2) then "tt" elseif fix(lXSB[r, 1]+lYSB[r, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(lXSB[r, 2]+lYSB[r, 2] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 2]+lYSB[r, 2] == 2) then "tt" elseif fix(lXSB[r, 2]+lYSB[r, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(lXSB[r, 3]+lYSB[r, 3] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 3]+lYSB[r, 3] == 2) then "tt" elseif fix(lXSB[r, 3]+lYSB[r, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(lXSB[r, 4]+lYSB[r, 4] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 4]+lYSB[r, 4] == 2) then "tt" elseif fix(lXSB[r, 4]+lYSB[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(lXSB[r, 5]+lYSB[r, 5] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 5]+lYSB[r, 5] == 2) then "tt" elseif fix(lXSB[r, 5]+lYSB[r, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(lXSB[r, 6]+lYSB[r, 6] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 6]+lYSB[r, 6] == 2) then "tt" elseif fix(lXSB[r, 6]+lYSB[r, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(lXSB[r, 7]+lYSB[r, 7] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 7]+lYSB[r, 7] == 2) then "tt" elseif fix(lXSB[r, 7]+lYSB[r, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(lXSB[r, 8]+lYSB[r, 8] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 8]+lYSB[r, 8] == 2) then "tt" elseif fix(lXSB[r, 8]+lYSB[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(lXSB[r, 9]+lYSB[r, 9] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 9]+lYSB[r, 9] == 2) then "tt" elseif fix(lXSB[r, 9]+lYSB[r, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(lXSB[r,10]+lYSB[r,10] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,10]+lYSB[r,10] == 2) then "tt" elseif fix(lXSB[r,10]+lYSB[r,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(lXSB[r,11]+lYSB[r,11] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,11]+lYSB[r,11] == 2) then "tt" elseif fix(lXSB[r,11]+lYSB[r,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(lXSB[r,12]+lYSB[r,12] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,12]+lYSB[r,12] == 2) then "tt" elseif fix(lXSB[r,12]+lYSB[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(lXSB[r,13]+lYSB[r,13] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,13]+lYSB[r,13] == 2) then "tt" elseif fix(lXSB[r,13]+lYSB[r,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(lXSB[r,14]+lYSB[r,14] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,14]+lYSB[r,14] == 2) then "tt" elseif fix(lXSB[r,14]+lYSB[r,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(lXSB[r,15]+lYSB[r,15] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,15]+lYSB[r,15] == 2) then "tt" elseif fix(lXSB[r,15]+lYSB[r,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    "    \\draw[->] (4,2) -- node[above] {\\tiny SB} node[below] {\\tiny SR} +(2,0);\n" ++
    "  \\end{scope}\n" ++
    
  % -----------------------------
    "  \\begin{scope}[xshift=" ++ show(35) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta Z_{" ++ show(r) ++ "}$};\n" ++
    if fix(lXSR[r, 0]+lYSR[r, 0] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 0]+lYSR[r, 0] == 2) then "tt" elseif fix(lXSR[r, 0]+lYSR[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(lXSR[r, 5]+lYSR[r, 5] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 5]+lYSR[r, 5] == 2) then "tt" elseif fix(lXSR[r, 5]+lYSR[r, 5] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(lXSR[r,10]+lYSR[r,10] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,10]+lYSR[r,10] == 2) then "tt" elseif fix(lXSR[r,10]+lYSR[r,10] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(lXSR[r,15]+lYSR[r,15] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,15]+lYSR[r,15] == 2) then "tt" elseif fix(lXSR[r,15]+lYSR[r,15] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(lXSR[r, 4]+lYSR[r, 4] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 4]+lYSR[r, 4] == 2) then "tt" elseif fix(lXSR[r, 4]+lYSR[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(lXSR[r, 9]+lYSR[r, 9] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 9]+lYSR[r, 9] == 2) then "tt" elseif fix(lXSR[r, 9]+lYSR[r, 9] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(lXSR[r,14]+lYSR[r,14] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,14]+lYSR[r,14] == 2) then "tt" elseif fix(lXSR[r,14]+lYSR[r,14] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(lXSR[r, 3]+lYSR[r, 3] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 3]+lYSR[r, 3] == 2) then "tt" elseif fix(lXSR[r, 3]+lYSR[r, 3] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(lXSR[r, 8]+lYSR[r, 8] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 8]+lYSR[r, 8] == 2) then "tt" elseif fix(lXSR[r, 8]+lYSR[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(lXSR[r,13]+lYSR[r,13] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,13]+lYSR[r,13] == 2) then "tt" elseif fix(lXSR[r,13]+lYSR[r,13] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(lXSR[r, 2]+lYSR[r, 2] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 2]+lYSR[r, 2] == 2) then "tt" elseif fix(lXSR[r, 2]+lYSR[r, 2] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(lXSR[r, 7]+lYSR[r, 7] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 7]+lYSR[r, 7] == 2) then "tt" elseif fix(lXSR[r, 7]+lYSR[r, 7] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(lXSR[r,12]+lYSR[r,12] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,12]+lYSR[r,12] == 2) then "tt" elseif fix(lXSR[r,12]+lYSR[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(lXSR[r, 1]+lYSR[r, 1] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 1]+lYSR[r, 1] == 2) then "tt" elseif fix(lXSR[r, 1]+lYSR[r, 1] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(lXSR[r, 6]+lYSR[r, 6] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 6]+lYSR[r, 6] == 2) then "tt" elseif fix(lXSR[r, 6]+lYSR[r, 6] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(lXSR[r,11]+lYSR[r,11] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,11]+lYSR[r,11] == 2) then "tt" elseif fix(lXSR[r,11]+lYSR[r,11] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    "    \\draw[->] (4,2) -- node[above] {\\tiny MC} +(2,0);\n" ++
    "  \\end{scope}\n" ++ 
    
    "  \\begin{scope}[xshift=" ++ show(41) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta W_{" ++ show(r) ++ "}$};\n" ++
	  if fix(lXAK[r+1, 0]+lYAK[r+1, 0] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 0]+lYAK[r+1, 0] == 2) then "tt" elseif fix(lXAK[r+1, 0]+lYAK[r+1, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(lXAK[r+1, 1]+lYAK[r+1, 1] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 1]+lYAK[r+1, 1] == 2) then "tt" elseif fix(lXAK[r+1, 1]+lYAK[r+1, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(lXAK[r+1, 2]+lYAK[r+1, 2] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 2]+lYAK[r+1, 2] == 2) then "tt" elseif fix(lXAK[r+1, 2]+lYAK[r+1, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(lXAK[r+1, 3]+lYAK[r+1, 3] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 3]+lYAK[r+1, 3] == 2) then "tt" elseif fix(lXAK[r+1, 3]+lYAK[r+1, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(lXAK[r+1, 4]+lYAK[r+1, 4] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 4]+lYAK[r+1, 4] == 2) then "tt" elseif fix(lXAK[r+1, 4]+lYAK[r+1, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(lXAK[r+1, 5]+lYAK[r+1, 5] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 5]+lYAK[r+1, 5] == 2) then "tt" elseif fix(lXAK[r+1, 5]+lYAK[r+1, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(lXAK[r+1, 6]+lYAK[r+1, 6] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 6]+lYAK[r+1, 6] == 2) then "tt" elseif fix(lXAK[r+1, 6]+lYAK[r+1, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(lXAK[r+1, 7]+lYAK[r+1, 7] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 7]+lYAK[r+1, 7] == 2) then "tt" elseif fix(lXAK[r+1, 7]+lYAK[r+1, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(lXAK[r+1, 8]+lYAK[r+1, 8] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 8]+lYAK[r+1, 8] == 2) then "tt" elseif fix(lXAK[r+1, 8]+lYAK[r+1, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(lXAK[r+1, 9]+lYAK[r+1, 9] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 9]+lYAK[r+1, 9] == 2) then "tt" elseif fix(lXAK[r+1, 9]+lYAK[r+1, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(lXAK[r+1,10]+lYAK[r+1,10] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,10]+lYAK[r+1,10] == 2) then "tt" elseif fix(lXAK[r+1,10]+lYAK[r+1,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(lXAK[r+1,11]+lYAK[r+1,11] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,11]+lYAK[r+1,11] == 2) then "tt" elseif fix(lXAK[r+1,11]+lYAK[r+1,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(lXAK[r+1,12]+lYAK[r+1,12] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,12]+lYAK[r+1,12] == 2) then "tt" elseif fix(lXAK[r+1,12]+lYAK[r+1,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(lXAK[r+1,13]+lYAK[r+1,13] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,13]+lYAK[r+1,13] == 2) then "tt" elseif fix(lXAK[r+1,13]+lYAK[r+1,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(lXAK[r+1,14]+lYAK[r+1,14] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,14]+lYAK[r+1,14] == 2) then "tt" elseif fix(lXAK[r+1,14]+lYAK[r+1,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(lXAK[r+1,15]+lYAK[r+1,15] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,15]+lYAK[r+1,15] == 2) then "tt" elseif fix(lXAK[r+1,15]+lYAK[r+1,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    "  \\end{scope}\n" ++ 
    
    "  \\begin{scope}[xshift=" ++ show(46) ++ "cm]\n" ++    
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta STK_{" ++ show(r) ++ "}$};\n" ++
    if fix(lSTK[r, 0]) == 1 then "    \\fill[fk] (0,3) rectangle (1,4);\n" endif ++
    if fix(lSTK[r, 1]) == 1 then "    \\fill[fk] (0,2) rectangle (1,3);\n" endif ++
    if fix(lSTK[r, 2]) == 1 then "    \\fill[fk] (0,1) rectangle (1,2);\n" endif ++
    if fix(lSTK[r, 3]) == 1 then "    \\fill[fk] (0,0) rectangle (1,1);\n" endif ++
    if fix(lSTK[r, 4]) == 1 then "    \\fill[fk] (1,3) rectangle (2,4);\n" endif ++
    if fix(lSTK[r, 5]) == 1 then "    \\fill[fk] (1,2) rectangle (2,3);\n" endif ++
    if fix(lSTK[r, 6]) == 1 then "    \\fill[fk] (1,1) rectangle (2,2);\n" endif ++
    if fix(lSTK[r, 7]) == 1 then "    \\fill[fk] (1,0) rectangle (2,1);\n" endif ++
    if fix(lSTK[r, 8]) == 1 then "    \\fill[fk] (2,3) rectangle (3,4);\n" endif ++
    if fix(lSTK[r, 9]) == 1 then "    \\fill[fk] (2,2) rectangle (3,3);\n" endif ++
    if fix(lSTK[r,10]) == 1 then "    \\fill[fk] (2,1) rectangle (3,2);\n" endif ++
    if fix(lSTK[r,11]) == 1 then "    \\fill[fk] (2,0) rectangle (3,1);\n" endif ++
    if fix(lSTK[r,12]) == 1 then "    \\fill[fk] (3,3) rectangle (4,4);\n" endif ++
    if fix(lSTK[r,13]) == 1 then "    \\fill[fk] (3,2) rectangle (4,3);\n" endif ++
    if fix(lSTK[r,14]) == 1 then "    \\fill[fk] (3,1) rectangle (4,2);\n" endif ++
    if fix(lSTK[r,15]) == 1 then "    \\fill[fk] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    if r != Rb+Ru then
    "    \\draw[->] (2,4) -- ++(0,0.5) --++(-20,0) --++(0,-2.2);\n"
    endif ++
    "  \\end{scope}\n" ++
    
    "\\end{scope}\n\n" 
    
    else 
    "\\begin{scope}[yshift=-" ++ show((r/2)*6+ypass) ++ "cm]\n" ++
    "  \\begin{scope}[xshift=" ++ show(0) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta STK_{" ++ show(r) ++ "}$};\n" ++
    if fix(lSTK[r, 0]) == 1 then "    \\fill[fk] (0,3) rectangle (1,4);\n" endif ++
    if fix(lSTK[r, 1]) == 1 then "    \\fill[fk] (0,2) rectangle (1,3);\n" endif ++
    if fix(lSTK[r, 2]) == 1 then "    \\fill[fk] (0,1) rectangle (1,2);\n" endif ++
    if fix(lSTK[r, 3]) == 1 then "    \\fill[fk] (0,0) rectangle (1,1);\n" endif ++
    if fix(lSTK[r, 4]) == 1 then "    \\fill[fk] (1,3) rectangle (2,4);\n" endif ++
    if fix(lSTK[r, 5]) == 1 then "    \\fill[fk] (1,2) rectangle (2,3);\n" endif ++
    if fix(lSTK[r, 6]) == 1 then "    \\fill[fk] (1,1) rectangle (2,2);\n" endif ++
    if fix(lSTK[r, 7]) == 1 then "    \\fill[fk] (1,0) rectangle (2,1);\n" endif ++
    if fix(lSTK[r, 8]) == 1 then "    \\fill[fk] (2,3) rectangle (3,4);\n" endif ++
    if fix(lSTK[r, 9]) == 1 then "    \\fill[fk] (2,2) rectangle (3,3);\n" endif ++
    if fix(lSTK[r,10]) == 1 then "    \\fill[fk] (2,1) rectangle (3,2);\n" endif ++
    if fix(lSTK[r,11]) == 1 then "    \\fill[fk] (2,0) rectangle (3,1);\n" endif ++
    if fix(lSTK[r,12]) == 1 then "    \\fill[fk] (3,3) rectangle (4,4);\n" endif ++
    if fix(lSTK[r,13]) == 1 then "    \\fill[fk] (3,2) rectangle (4,3);\n" endif ++
    if fix(lSTK[r,14]) == 1 then "    \\fill[fk] (3,1) rectangle (4,2);\n" endif ++
    if fix(lSTK[r,15]) == 1 then "    \\fill[fk] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    "  \\end{scope}\n" ++
    
  if r != Rb+Ru then
    "  \\begin{scope}[xshift=" ++ show(5) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta " ++ "W_{" ++ show(r-1) ++ "}$};\n" ++
    if fix(lXAK[r, 0]+lYAK[r, 0] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 0]+lYAK[r, 0] == 2) then "tt" elseif fix(lXAK[r, 0]+lYAK[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(lXAK[r, 1]+lYAK[r, 1] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 1]+lYAK[r, 1] == 2) then "tt" elseif fix(lXAK[r, 1]+lYAK[r, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(lXAK[r, 2]+lYAK[r, 2] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 2]+lYAK[r, 2] == 2) then "tt" elseif fix(lXAK[r, 2]+lYAK[r, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(lXAK[r, 3]+lYAK[r, 3] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 3]+lYAK[r, 3] == 2) then "tt" elseif fix(lXAK[r, 3]+lYAK[r, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(lXAK[r, 4]+lYAK[r, 4] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 4]+lYAK[r, 4] == 2) then "tt" elseif fix(lXAK[r, 4]+lYAK[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(lXAK[r, 5]+lYAK[r, 5] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 5]+lYAK[r, 5] == 2) then "tt" elseif fix(lXAK[r, 5]+lYAK[r, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(lXAK[r, 6]+lYAK[r, 6] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 6]+lYAK[r, 6] == 2) then "tt" elseif fix(lXAK[r, 6]+lYAK[r, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(lXAK[r, 7]+lYAK[r, 7] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 7]+lYAK[r, 7] == 2) then "tt" elseif fix(lXAK[r, 7]+lYAK[r, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(lXAK[r, 8]+lYAK[r, 8] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 8]+lYAK[r, 8] == 2) then "tt" elseif fix(lXAK[r, 8]+lYAK[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(lXAK[r, 9]+lYAK[r, 9] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 9]+lYAK[r, 9] == 2) then "tt" elseif fix(lXAK[r, 9]+lYAK[r, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(lXAK[r,10]+lYAK[r,10] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r,10]+lYAK[r,10] == 2) then "tt" elseif fix(lXAK[r,10]+lYAK[r,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(lXAK[r,11]+lYAK[r,11] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r,11]+lYAK[r,11] == 2) then "tt" elseif fix(lXAK[r,11]+lYAK[r,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(lXAK[r,12]+lYAK[r,12] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r,12]+lYAK[r,12] == 2) then "tt" elseif fix(lXAK[r,12]+lYAK[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(lXAK[r,13]+lYAK[r,13] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r,13]+lYAK[r,13] == 2) then "tt" elseif fix(lXAK[r,13]+lYAK[r,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(lXAK[r,14]+lYAK[r,14] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r,14]+lYAK[r,14] == 2) then "tt" elseif fix(lXAK[r,14]+lYAK[r,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(lXAK[r,15]+lYAK[r,15] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r,15]+lYAK[r,15] == 2) then "tt" elseif fix(lXAK[r,15]+lYAK[r,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    "    \\draw[->] (4,2) -- +(2,0);\n" ++ 
    "    \\draw[->] (-3,4)--++(0,0.5) --++(8,0)--++(0,-2.2);\n" ++
    "    \\node at (5,2) {$\\oplus$};\n" ++
    "  \\end{scope}\n"
  endif ++
    
% -----------------------------
    "  \\begin{scope}[xshift=" ++ show(11) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta X_{" ++ show(r) ++ "}$};\n" ++
    if fix(lXSB[r, 0]+lYSB[r, 0] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 0]+lYSB[r, 0] == 2) then "tt" elseif fix(lXSB[r, 0]+lYSB[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(lXSB[r, 1]+lYSB[r, 1] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 1]+lYSB[r, 1] == 2) then "tt" elseif fix(lXSB[r, 1]+lYSB[r, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(lXSB[r, 2]+lYSB[r, 2] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 2]+lYSB[r, 2] == 2) then "tt" elseif fix(lXSB[r, 2]+lYSB[r, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(lXSB[r, 3]+lYSB[r, 3] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 3]+lYSB[r, 3] == 2) then "tt" elseif fix(lXSB[r, 3]+lYSB[r, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(lXSB[r, 4]+lYSB[r, 4] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 4]+lYSB[r, 4] == 2) then "tt" elseif fix(lXSB[r, 4]+lYSB[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(lXSB[r, 5]+lYSB[r, 5] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 5]+lYSB[r, 5] == 2) then "tt" elseif fix(lXSB[r, 5]+lYSB[r, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(lXSB[r, 6]+lYSB[r, 6] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 6]+lYSB[r, 6] == 2) then "tt" elseif fix(lXSB[r, 6]+lYSB[r, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(lXSB[r, 7]+lYSB[r, 7] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 7]+lYSB[r, 7] == 2) then "tt" elseif fix(lXSB[r, 7]+lYSB[r, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(lXSB[r, 8]+lYSB[r, 8] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 8]+lYSB[r, 8] == 2) then "tt" elseif fix(lXSB[r, 8]+lYSB[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(lXSB[r, 9]+lYSB[r, 9] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 9]+lYSB[r, 9] == 2) then "tt" elseif fix(lXSB[r, 9]+lYSB[r, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(lXSB[r,10]+lYSB[r,10] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,10]+lYSB[r,10] == 2) then "tt" elseif fix(lXSB[r,10]+lYSB[r,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(lXSB[r,11]+lYSB[r,11] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,11]+lYSB[r,11] == 2) then "tt" elseif fix(lXSB[r,11]+lYSB[r,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(lXSB[r,12]+lYSB[r,12] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,12]+lYSB[r,12] == 2) then "tt" elseif fix(lXSB[r,12]+lYSB[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(lXSB[r,13]+lYSB[r,13] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,13]+lYSB[r,13] == 2) then "tt" elseif fix(lXSB[r,13]+lYSB[r,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(lXSB[r,14]+lYSB[r,14] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,14]+lYSB[r,14] == 2) then "tt" elseif fix(lXSB[r,14]+lYSB[r,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(lXSB[r,15]+lYSB[r,15] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,15]+lYSB[r,15] == 2) then "tt" elseif fix(lXSB[r,15]+lYSB[r,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++    
    "    \\draw[->] (4,2) -- node[above] {\\tiny SB} node[below] {\\tiny SR} +(2,0);\n" ++
    "  \\end{scope}\n" ++ 

    % -----------------------------
    "  \\begin{scope}[xshift=" ++ show(17) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta Z_{" ++ show(r) ++ "}$};\n" ++
    if fix(lXSR[r, 0]+lYSR[r, 0] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 0]+lYSR[r, 0] == 2) then "tt" elseif fix(lXSR[r, 0]+lYSR[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(lXSR[r, 5]+lYSR[r, 5] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 5]+lYSR[r, 5] == 2) then "tt" elseif fix(lXSR[r, 5]+lYSR[r, 5] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(lXSR[r,10]+lYSR[r,10] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,10]+lYSR[r,10] == 2) then "tt" elseif fix(lXSR[r,10]+lYSR[r,10] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(lXSR[r,15]+lYSR[r,15] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,15]+lYSR[r,15] == 2) then "tt" elseif fix(lXSR[r,15]+lYSR[r,15] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(lXSR[r, 4]+lYSR[r, 4] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 4]+lYSR[r, 4] == 2) then "tt" elseif fix(lXSR[r, 4]+lYSR[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(lXSR[r, 9]+lYSR[r, 9] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 9]+lYSR[r, 9] == 2) then "tt" elseif fix(lXSR[r, 9]+lYSR[r, 9] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(lXSR[r,14]+lYSR[r,14] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,14]+lYSR[r,14] == 2) then "tt" elseif fix(lXSR[r,14]+lYSR[r,14] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(lXSR[r, 3]+lYSR[r, 3] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 3]+lYSR[r, 3] == 2) then "tt" elseif fix(lXSR[r, 3]+lYSR[r, 3] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(lXSR[r, 8]+lYSR[r, 8] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 8]+lYSR[r, 8] == 2) then "tt" elseif fix(lXSR[r, 8]+lYSR[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(lXSR[r,13]+lYSR[r,13] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,13]+lYSR[r,13] == 2) then "tt" elseif fix(lXSR[r,13]+lYSR[r,13] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(lXSR[r, 2]+lYSR[r, 2] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 2]+lYSR[r, 2] == 2) then "tt" elseif fix(lXSR[r, 2]+lYSR[r, 2] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(lXSR[r, 7]+lYSR[r, 7] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 7]+lYSR[r, 7] == 2) then "tt" elseif fix(lXSR[r, 7]+lYSR[r, 7] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(lXSR[r,12]+lYSR[r,12] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,12]+lYSR[r,12] == 2) then "tt" elseif fix(lXSR[r,12]+lYSR[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(lXSR[r, 1]+lYSR[r, 1] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 1]+lYSR[r, 1] == 2) then "tt" elseif fix(lXSR[r, 1]+lYSR[r, 1] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(lXSR[r, 6]+lYSR[r, 6] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 6]+lYSR[r, 6] == 2) then "tt" elseif fix(lXSR[r, 6]+lYSR[r, 6] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(lXSR[r,11]+lYSR[r,11] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,11]+lYSR[r,11] == 2) then "tt" elseif fix(lXSR[r,11]+lYSR[r,11] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    "    \\draw[->] (4,2) -- node[above] {\\tiny MC} +(2,0);\n" ++
    "  \\end{scope}\n" ++ 
    
    "  \\begin{scope}[xshift=" ++ show(23) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta W_{" ++ show(r) ++ "}$};\n" ++
    if fix(lXAK[r+1, 0]+lYAK[r+1, 0] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 0]+lYAK[r+1, 0] == 2) then "tt" elseif fix(lXAK[r+1, 0]+lYAK[r+1, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(lXAK[r+1, 1]+lYAK[r+1, 1] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 1]+lYAK[r+1, 1] == 2) then "tt" elseif fix(lXAK[r+1, 1]+lYAK[r+1, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(lXAK[r+1, 2]+lYAK[r+1, 2] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 2]+lYAK[r+1, 2] == 2) then "tt" elseif fix(lXAK[r+1, 2]+lYAK[r+1, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(lXAK[r+1, 3]+lYAK[r+1, 3] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 3]+lYAK[r+1, 3] == 2) then "tt" elseif fix(lXAK[r+1, 3]+lYAK[r+1, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(lXAK[r+1, 4]+lYAK[r+1, 4] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 4]+lYAK[r+1, 4] == 2) then "tt" elseif fix(lXAK[r+1, 4]+lYAK[r+1, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(lXAK[r+1, 5]+lYAK[r+1, 5] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 5]+lYAK[r+1, 5] == 2) then "tt" elseif fix(lXAK[r+1, 5]+lYAK[r+1, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(lXAK[r+1, 6]+lYAK[r+1, 6] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 6]+lYAK[r+1, 6] == 2) then "tt" elseif fix(lXAK[r+1, 6]+lYAK[r+1, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(lXAK[r+1, 7]+lYAK[r+1, 7] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 7]+lYAK[r+1, 7] == 2) then "tt" elseif fix(lXAK[r+1, 7]+lYAK[r+1, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(lXAK[r+1, 8]+lYAK[r+1, 8] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 8]+lYAK[r+1, 8] == 2) then "tt" elseif fix(lXAK[r+1, 8]+lYAK[r+1, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(lXAK[r+1, 9]+lYAK[r+1, 9] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 9]+lYAK[r+1, 9] == 2) then "tt" elseif fix(lXAK[r+1, 9]+lYAK[r+1, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(lXAK[r+1,10]+lYAK[r+1,10] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,10]+lYAK[r+1,10] == 2) then "tt" elseif fix(lXAK[r+1,10]+lYAK[r+1,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(lXAK[r+1,11]+lYAK[r+1,11] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,11]+lYAK[r+1,11] == 2) then "tt" elseif fix(lXAK[r+1,11]+lYAK[r+1,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(lXAK[r+1,12]+lYAK[r+1,12] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,12]+lYAK[r+1,12] == 2) then "tt" elseif fix(lXAK[r+1,12]+lYAK[r+1,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(lXAK[r+1,13]+lYAK[r+1,13] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,13]+lYAK[r+1,13] == 2) then "tt" elseif fix(lXAK[r+1,13]+lYAK[r+1,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(lXAK[r+1,14]+lYAK[r+1,14] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,14]+lYAK[r+1,14] == 2) then "tt" elseif fix(lXAK[r+1,14]+lYAK[r+1,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(lXAK[r+1,15]+lYAK[r+1,15] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,15]+lYAK[r+1,15] == 2) then "tt" elseif fix(lXAK[r+1,15]+lYAK[r+1,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    "    \\draw[->] (4,2) --  +(2,0);\n" ++
    "    \\node at (5,2) {$\\oplus$};\n"++
    "  \\end{scope}\n" ++
    
    
    "\\end{scope}\n"
    
    endif
    | r in Rb+Ru..Rb+Ru+Rm+Rl-1];
    
    

% === draw for Ef ===
output [
  if r mod 2 == 0 then 
    "\\begin{scope}[yshift=-" ++ show((r/2)*6+ypass) ++ "cm]\n" ++
    "  \\begin{scope}[xshift=" ++ show(0) ++ "cm]\n" ++    
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta STK_{" ++ show(r) ++ "}$};\n" ++
    if fix(lSTK[r, 0]) == 1 then "    \\fill[fk] (0,3) rectangle (1,4);\n" endif ++
    if fix(lSTK[r, 1]) == 1 then "    \\fill[fk] (0,2) rectangle (1,3);\n" endif ++
    if fix(lSTK[r, 2]) == 1 then "    \\fill[fk] (0,1) rectangle (1,2);\n" endif ++
    if fix(lSTK[r, 3]) == 1 then "    \\fill[fk] (0,0) rectangle (1,1);\n" endif ++
    if fix(lSTK[r, 4]) == 1 then "    \\fill[fk] (1,3) rectangle (2,4);\n" endif ++
    if fix(lSTK[r, 5]) == 1 then "    \\fill[fk] (1,2) rectangle (2,3);\n" endif ++
    if fix(lSTK[r, 6]) == 1 then "    \\fill[fk] (1,1) rectangle (2,2);\n" endif ++
    if fix(lSTK[r, 7]) == 1 then "    \\fill[fk] (1,0) rectangle (2,1);\n" endif ++
    if fix(lSTK[r, 8]) == 1 then "    \\fill[fk] (2,3) rectangle (3,4);\n" endif ++
    if fix(lSTK[r, 9]) == 1 then "    \\fill[fk] (2,2) rectangle (3,3);\n" endif ++
    if fix(lSTK[r,10]) == 1 then "    \\fill[fk] (2,1) rectangle (3,2);\n" endif ++
    if fix(lSTK[r,11]) == 1 then "    \\fill[fk] (2,0) rectangle (3,1);\n" endif ++
    if fix(lSTK[r,12]) == 1 then "    \\fill[fk] (3,3) rectangle (4,4);\n" endif ++
    if fix(lSTK[r,13]) == 1 then "    \\fill[fk] (3,2) rectangle (4,3);\n" endif ++
    if fix(lSTK[r,14]) == 1 then "    \\fill[fk] (3,1) rectangle (4,2);\n" endif ++
    if fix(lSTK[r,15]) == 1 then "    \\fill[fk] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
  if r != Rb+Ru+Rm+Rl then
    if fix(lGSTK[r, 0]) == 1 then "    \\draw[geqk, ultra thick] (0,3) rectangle (1,4);\n" endif ++
    if fix(lGSTK[r, 1]) == 1 then "    \\draw[geqk, ultra thick] (0,2) rectangle (1,3);\n" endif ++
    if fix(lGSTK[r, 2]) == 1 then "    \\draw[geqk, ultra thick] (0,1) rectangle (1,2);\n" endif ++
    if fix(lGSTK[r, 3]) == 1 then "    \\draw[geqk, ultra thick] (0,0) rectangle (1,1);\n" endif ++
    if fix(lGSTK[r, 4]) == 1 then "    \\draw[geqk, ultra thick] (1,3) rectangle (2,4);\n" endif ++
    if fix(lGSTK[r, 5]) == 1 then "    \\draw[geqk, ultra thick] (1,2) rectangle (2,3);\n" endif ++
    if fix(lGSTK[r, 6]) == 1 then "    \\draw[geqk, ultra thick] (1,1) rectangle (2,2);\n" endif ++
    if fix(lGSTK[r, 7]) == 1 then "    \\draw[geqk, ultra thick] (1,0) rectangle (2,1);\n" endif ++
    if fix(lGSTK[r, 8]) == 1 then "    \\draw[geqk, ultra thick] (2,3) rectangle (3,4);\n" endif ++
    if fix(lGSTK[r, 9]) == 1 then "    \\draw[geqk, ultra thick] (2,2) rectangle (3,3);\n" endif ++
    if fix(lGSTK[r,10]) == 1 then "    \\draw[geqk, ultra thick] (2,1) rectangle (3,2);\n" endif ++
    if fix(lGSTK[r,11]) == 1 then "    \\draw[geqk, ultra thick] (2,0) rectangle (3,1);\n" endif ++
    if fix(lGSTK[r,12]) == 1 then "    \\draw[geqk, ultra thick] (3,3) rectangle (4,4);\n" endif ++
    if fix(lGSTK[r,13]) == 1 then "    \\draw[geqk, ultra thick] (3,2) rectangle (4,3);\n" endif ++
    if fix(lGSTK[r,14]) == 1 then "    \\draw[geqk, ultra thick] (3,1) rectangle (4,2);\n" endif ++
    if fix(lGSTK[r,15]) == 1 then "    \\draw[geqk, ultra thick] (3,0) rectangle (4,1);\n" endif ++
    
    if fix(lSGK[r, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 0]) == fix(lSGK[r, 0]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 0]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 1]) == fix(lSGK[r, 1]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 1]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 2]) == fix(lSGK[r, 2]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 2]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 3]) == fix(lSGK[r, 3]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 3]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 4]) == fix(lSGK[r, 4]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 4]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 5]) == fix(lSGK[r, 5]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 5]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 6]) == fix(lSGK[r, 6]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 6]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 7]) == fix(lSGK[r, 7]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 7]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 8]) == fix(lSGK[r, 8]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 8]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 9]) == fix(lSGK[r, 9]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 9]) ++ "}$};\n" endif ++
    if fix(lSGK[r,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,10]) == fix(lSGK[r,10]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,10]) ++ "}$};\n" endif ++
    if fix(lSGK[r,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,11]) == fix(lSGK[r,11]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,11]) ++ "}$};\n" endif ++
    if fix(lSGK[r,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,12]) == fix(lSGK[r,12]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,12]) ++ "}$};\n" endif ++
    if fix(lSGK[r,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,13]) == fix(lSGK[r,13]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,13]) ++ "}$};\n" endif ++
    if fix(lSGK[r,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,14]) == fix(lSGK[r,14]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,14]) ++ "}$};\n" endif ++
    if fix(lSGK[r,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,15]) == fix(lSGK[r,15]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,15]) ++ "}$};\n" endif
    endif ++
    "  \\end{scope}\n" ++
    
    % -----------------------------
    "  \\begin{scope}[xshift=" ++ show(5) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta " ++ "W_{" ++ show(r-1) ++ "}$};\n" ++
    if fix(lXAK[r, 0]+lYAK[r, 0] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 0]+lYAK[r, 0] == 2) then "tt" elseif fix(lXAK[r, 0]+lYAK[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(lXAK[r, 1]+lYAK[r, 1] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 1]+lYAK[r, 1] == 2) then "tt" elseif fix(lXAK[r, 1]+lYAK[r, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(lXAK[r, 2]+lYAK[r, 2] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 2]+lYAK[r, 2] == 2) then "tt" elseif fix(lXAK[r, 2]+lYAK[r, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(lXAK[r, 3]+lYAK[r, 3] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 3]+lYAK[r, 3] == 2) then "tt" elseif fix(lXAK[r, 3]+lYAK[r, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(lXAK[r, 4]+lYAK[r, 4] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 4]+lYAK[r, 4] == 2) then "tt" elseif fix(lXAK[r, 4]+lYAK[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(lXAK[r, 5]+lYAK[r, 5] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 5]+lYAK[r, 5] == 2) then "tt" elseif fix(lXAK[r, 5]+lYAK[r, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(lXAK[r, 6]+lYAK[r, 6] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 6]+lYAK[r, 6] == 2) then "tt" elseif fix(lXAK[r, 6]+lYAK[r, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(lXAK[r, 7]+lYAK[r, 7] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 7]+lYAK[r, 7] == 2) then "tt" elseif fix(lXAK[r, 7]+lYAK[r, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(lXAK[r, 8]+lYAK[r, 8] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 8]+lYAK[r, 8] == 2) then "tt" elseif fix(lXAK[r, 8]+lYAK[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(lXAK[r, 9]+lYAK[r, 9] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r, 9]+lYAK[r, 9] == 2) then "tt" elseif fix(lXAK[r, 9]+lYAK[r, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(lXAK[r,10]+lYAK[r,10] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r,10]+lYAK[r,10] == 2) then "tt" elseif fix(lXAK[r,10]+lYAK[r,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(lXAK[r,11]+lYAK[r,11] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r,11]+lYAK[r,11] == 2) then "tt" elseif fix(lXAK[r,11]+lYAK[r,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(lXAK[r,12]+lYAK[r,12] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r,12]+lYAK[r,12] == 2) then "tt" elseif fix(lXAK[r,12]+lYAK[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(lXAK[r,13]+lYAK[r,13] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r,13]+lYAK[r,13] == 2) then "tt" elseif fix(lXAK[r,13]+lYAK[r,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(lXAK[r,14]+lYAK[r,14] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r,14]+lYAK[r,14] == 2) then "tt" elseif fix(lXAK[r,14]+lYAK[r,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(lXAK[r,15]+lYAK[r,15] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r,15]+lYAK[r,15] == 2) then "tt" elseif fix(lXAK[r,15]+lYAK[r,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
  if r != Rb+Ru+Rm+Rl then
    if fix(lVAK[r, 0] == 1) then "    \\draw[pattern=north west lines] (0,3) rectangle (1,4);\n" endif ++
    if fix(lVAK[r, 1] == 1) then "    \\draw[pattern=north west lines] (0,2) rectangle (1,3);\n" endif ++
    if fix(lVAK[r, 2] == 1) then "    \\draw[pattern=north west lines] (0,1) rectangle (1,2);\n" endif ++
    if fix(lVAK[r, 3] == 1) then "    \\draw[pattern=north west lines] (0,0) rectangle (1,1);\n" endif ++
    if fix(lVAK[r, 4] == 1) then "    \\draw[pattern=north west lines] (1,3) rectangle (2,4);\n" endif ++
    if fix(lVAK[r, 5] == 1) then "    \\draw[pattern=north west lines] (1,2) rectangle (2,3);\n" endif ++
    if fix(lVAK[r, 6] == 1) then "    \\draw[pattern=north west lines] (1,1) rectangle (2,2);\n" endif ++
    if fix(lVAK[r, 7] == 1) then "    \\draw[pattern=north west lines] (1,0) rectangle (2,1);\n" endif ++
    if fix(lVAK[r, 8] == 1) then "    \\draw[pattern=north west lines] (2,3) rectangle (3,4);\n" endif ++
    if fix(lVAK[r, 9] == 1) then "    \\draw[pattern=north west lines] (2,2) rectangle (3,3);\n" endif ++
    if fix(lVAK[r,10] == 1) then "    \\draw[pattern=north west lines] (2,1) rectangle (3,2);\n" endif ++
    if fix(lVAK[r,11] == 1) then "    \\draw[pattern=north west lines] (2,0) rectangle (3,1);\n" endif ++
    if fix(lVAK[r,12] == 1) then "    \\draw[pattern=north west lines] (3,3) rectangle (4,4);\n" endif ++
    if fix(lVAK[r,13] == 1) then "    \\draw[pattern=north west lines] (3,2) rectangle (4,3);\n" endif ++
    if fix(lVAK[r,14] == 1) then "    \\draw[pattern=north west lines] (3,1) rectangle (4,2);\n" endif ++
    if fix(lVAK[r,15] == 1) then "    \\draw[pattern=north west lines] (3,0) rectangle (4,1);\n" endif
  endif ++ 
    
  if r <= Rb+Ru+Rm+Rl+Rf-1 then
    if fix(lSSB[r, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 0]) == fix(lSSB[r, 0]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 0]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 1]) == fix(lSSB[r, 1]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 1]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 2]) == fix(lSSB[r, 2]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 2]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 3]) == fix(lSSB[r, 3]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 3]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 4]) == fix(lSSB[r, 4]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 4]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 5]) == fix(lSSB[r, 5]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 5]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 6]) == fix(lSSB[r, 6]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 6]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 7]) == fix(lSSB[r, 7]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 7]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 8]) == fix(lSSB[r, 8]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 8]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 9]) == fix(lSSB[r, 9]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 9]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,10]) == fix(lSSB[r,10]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,10]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,11]) == fix(lSSB[r,11]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,11]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,12]) == fix(lSSB[r,12]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,12]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,13]) == fix(lSSB[r,13]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,13]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,14]) == fix(lSSB[r,14]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,14]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,15]) == fix(lSSB[r,15]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,15]) ++ "}$}};\n" endif
  endif ++
    "    \\draw[->] (4,2) -- +(2,0);\n" ++ 
    "    \\draw[->] (-3,4)--++(0,0.5) --++(8,0)--++(0,-2.2);\n" ++
    "    \\node at (5,2) {$\\oplus$};\n" ++
    if r == Rb+Ru+Rm+Rl+Rf then "\\node at (7,2) {$\\Delta C$};\n" endif ++
    "  \\end{scope}\n" ++ 
    
% -----------------------------
  if r != Rb+Ru+Rm+Rl+Rf then
    "  \\begin{scope}[xshift=" ++ show(11) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta X_{" ++ show(r) ++ "}$};\n" ++
    if fix(lXSB[r, 0]+lYSB[r, 0] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 0]+lYSB[r, 0] == 2) then "tt" elseif fix(lXSB[r, 0]+lYSB[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(lXSB[r, 1]+lYSB[r, 1] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 1]+lYSB[r, 1] == 2) then "tt" elseif fix(lXSB[r, 1]+lYSB[r, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(lXSB[r, 2]+lYSB[r, 2] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 2]+lYSB[r, 2] == 2) then "tt" elseif fix(lXSB[r, 2]+lYSB[r, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(lXSB[r, 3]+lYSB[r, 3] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 3]+lYSB[r, 3] == 2) then "tt" elseif fix(lXSB[r, 3]+lYSB[r, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(lXSB[r, 4]+lYSB[r, 4] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 4]+lYSB[r, 4] == 2) then "tt" elseif fix(lXSB[r, 4]+lYSB[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(lXSB[r, 5]+lYSB[r, 5] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 5]+lYSB[r, 5] == 2) then "tt" elseif fix(lXSB[r, 5]+lYSB[r, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(lXSB[r, 6]+lYSB[r, 6] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 6]+lYSB[r, 6] == 2) then "tt" elseif fix(lXSB[r, 6]+lYSB[r, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(lXSB[r, 7]+lYSB[r, 7] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 7]+lYSB[r, 7] == 2) then "tt" elseif fix(lXSB[r, 7]+lYSB[r, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(lXSB[r, 8]+lYSB[r, 8] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 8]+lYSB[r, 8] == 2) then "tt" elseif fix(lXSB[r, 8]+lYSB[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(lXSB[r, 9]+lYSB[r, 9] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 9]+lYSB[r, 9] == 2) then "tt" elseif fix(lXSB[r, 9]+lYSB[r, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(lXSB[r,10]+lYSB[r,10] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,10]+lYSB[r,10] == 2) then "tt" elseif fix(lXSB[r,10]+lYSB[r,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(lXSB[r,11]+lYSB[r,11] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,11]+lYSB[r,11] == 2) then "tt" elseif fix(lXSB[r,11]+lYSB[r,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(lXSB[r,12]+lYSB[r,12] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,12]+lYSB[r,12] == 2) then "tt" elseif fix(lXSB[r,12]+lYSB[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(lXSB[r,13]+lYSB[r,13] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,13]+lYSB[r,13] == 2) then "tt" elseif fix(lXSB[r,13]+lYSB[r,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(lXSB[r,14]+lYSB[r,14] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,14]+lYSB[r,14] == 2) then "tt" elseif fix(lXSB[r,14]+lYSB[r,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(lXSB[r,15]+lYSB[r,15] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,15]+lYSB[r,15] == 2) then "tt" elseif fix(lXSB[r,15]+lYSB[r,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    if fix(lVSB[r, 0] == 1) then "    \\draw[pattern=north west lines] (0,3) rectangle (1,4);\n" endif ++
    if fix(lVSB[r, 1] == 1) then "    \\draw[pattern=north west lines] (0,2) rectangle (1,3);\n" endif ++
    if fix(lVSB[r, 2] == 1) then "    \\draw[pattern=north west lines] (0,1) rectangle (1,2);\n" endif ++
    if fix(lVSB[r, 3] == 1) then "    \\draw[pattern=north west lines] (0,0) rectangle (1,1);\n" endif ++
    if fix(lVSB[r, 4] == 1) then "    \\draw[pattern=north west lines] (1,3) rectangle (2,4);\n" endif ++
    if fix(lVSB[r, 5] == 1) then "    \\draw[pattern=north west lines] (1,2) rectangle (2,3);\n" endif ++
    if fix(lVSB[r, 6] == 1) then "    \\draw[pattern=north west lines] (1,1) rectangle (2,2);\n" endif ++
    if fix(lVSB[r, 7] == 1) then "    \\draw[pattern=north west lines] (1,0) rectangle (2,1);\n" endif ++
    if fix(lVSB[r, 8] == 1) then "    \\draw[pattern=north west lines] (2,3) rectangle (3,4);\n" endif ++
    if fix(lVSB[r, 9] == 1) then "    \\draw[pattern=north west lines] (2,2) rectangle (3,3);\n" endif ++
    if fix(lVSB[r,10] == 1) then "    \\draw[pattern=north west lines] (2,1) rectangle (3,2);\n" endif ++
    if fix(lVSB[r,11] == 1) then "    \\draw[pattern=north west lines] (2,0) rectangle (3,1);\n" endif ++
    if fix(lVSB[r,12] == 1) then "    \\draw[pattern=north west lines] (3,3) rectangle (4,4);\n" endif ++
    if fix(lVSB[r,13] == 1) then "    \\draw[pattern=north west lines] (3,2) rectangle (4,3);\n" endif ++
    if fix(lVSB[r,14] == 1) then "    \\draw[pattern=north west lines] (3,1) rectangle (4,2);\n" endif ++
    if fix(lVSB[r,15] == 1) then "    \\draw[pattern=north west lines] (3,0) rectangle (4,1);\n" endif ++
    
    if fix(lFSB[r, 0] == 1) then "    \\draw[fr, ultra thick] (0,3) rectangle (1,4);\n" endif ++
    if fix(lFSB[r, 1] == 1) then "    \\draw[fr, ultra thick] (0,2) rectangle (1,3);\n" endif ++
    if fix(lFSB[r, 2] == 1) then "    \\draw[fr, ultra thick] (0,1) rectangle (1,2);\n" endif ++
    if fix(lFSB[r, 3] == 1) then "    \\draw[fr, ultra thick] (0,0) rectangle (1,1);\n" endif ++
    if fix(lFSB[r, 4] == 1) then "    \\draw[fr, ultra thick] (1,3) rectangle (2,4);\n" endif ++
    if fix(lFSB[r, 5] == 1) then "    \\draw[fr, ultra thick] (1,2) rectangle (2,3);\n" endif ++
    if fix(lFSB[r, 6] == 1) then "    \\draw[fr, ultra thick] (1,1) rectangle (2,2);\n" endif ++
    if fix(lFSB[r, 7] == 1) then "    \\draw[fr, ultra thick] (1,0) rectangle (2,1);\n" endif ++
    if fix(lFSB[r, 8] == 1) then "    \\draw[fr, ultra thick] (2,3) rectangle (3,4);\n" endif ++
    if fix(lFSB[r, 9] == 1) then "    \\draw[fr, ultra thick] (2,2) rectangle (3,3);\n" endif ++
    if fix(lFSB[r,10] == 1) then "    \\draw[fr, ultra thick] (2,1) rectangle (3,2);\n" endif ++
    if fix(lFSB[r,11] == 1) then "    \\draw[fr, ultra thick] (2,0) rectangle (3,1);\n" endif ++
    if fix(lFSB[r,12] == 1) then "    \\draw[fr, ultra thick] (3,3) rectangle (4,4);\n" endif ++
    if fix(lFSB[r,13] == 1) then "    \\draw[fr, ultra thick] (3,2) rectangle (4,3);\n" endif ++
    if fix(lFSB[r,14] == 1) then "    \\draw[fr, ultra thick] (3,1) rectangle (4,2);\n" endif ++
    if fix(lFSB[r,15] == 1) then "    \\draw[fr, ultra thick] (3,0) rectangle (4,1);\n" endif ++

  if r <= Rb+Ru+Rm+Rl+Rf-1 then
    if fix(lSSB[r, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 0]) == fix(lSSB[r, 0]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 0]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 1]) == fix(lSSB[r, 1]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 1]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 2]) == fix(lSSB[r, 2]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 2]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 3]) == fix(lSSB[r, 3]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 3]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 4]) == fix(lSSB[r, 4]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 4]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 5]) == fix(lSSB[r, 5]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 5]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 6]) == fix(lSSB[r, 6]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 6]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 7]) == fix(lSSB[r, 7]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 7]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 8]) == fix(lSSB[r, 8]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 8]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 9]) == fix(lSSB[r, 9]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 9]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,10]) == fix(lSSB[r,10]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,10]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,11]) == fix(lSSB[r,11]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,11]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,12]) == fix(lSSB[r,12]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,12]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,13]) == fix(lSSB[r,13]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,13]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,14]) == fix(lSSB[r,14]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,14]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,15]) == fix(lSSB[r,15]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,15]) ++ "}$}};\n" endif 
    endif ++
    "    \\draw[->] (4,2) -- node[above] {\\tiny" ++
      if r == Rb+Ru+Rm+Rl then "$\\stackrel{\\textcolor{gray}{\\stackrel{\\rightarrow}{E_f}}}{\\text{SB}}$" 
      else " SB" 
      endif ++ 
      "} node[below, yshift=0mm] {\\tiny $\\stackrel{\\textcolor{geqk}{eqk}}{\\text{SR}}$} +(2,0);\n" ++
    "  \\end{scope}\n"
  endif ++

  if r != Rb+Ru+Rm+Rl+Rf then
    % -----------------------------
    "  \\begin{scope}[xshift=" ++ show(17) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta Z_{" ++ show(r) ++ "}$};\n" ++
    if fix(lXSR[r, 0]+lYSR[r, 0] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 0]+lYSR[r, 0] == 2) then "tt" elseif fix(lXSR[r, 0]+lYSR[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(lXSR[r, 5]+lYSR[r, 5] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 5]+lYSR[r, 5] == 2) then "tt" elseif fix(lXSR[r, 5]+lYSR[r, 5] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(lXSR[r,10]+lYSR[r,10] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,10]+lYSR[r,10] == 2) then "tt" elseif fix(lXSR[r,10]+lYSR[r,10] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(lXSR[r,15]+lYSR[r,15] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,15]+lYSR[r,15] == 2) then "tt" elseif fix(lXSR[r,15]+lYSR[r,15] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(lXSR[r, 4]+lYSR[r, 4] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 4]+lYSR[r, 4] == 2) then "tt" elseif fix(lXSR[r, 4]+lYSR[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(lXSR[r, 9]+lYSR[r, 9] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 9]+lYSR[r, 9] == 2) then "tt" elseif fix(lXSR[r, 9]+lYSR[r, 9] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(lXSR[r,14]+lYSR[r,14] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,14]+lYSR[r,14] == 2) then "tt" elseif fix(lXSR[r,14]+lYSR[r,14] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(lXSR[r, 3]+lYSR[r, 3] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 3]+lYSR[r, 3] == 2) then "tt" elseif fix(lXSR[r, 3]+lYSR[r, 3] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(lXSR[r, 8]+lYSR[r, 8] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 8]+lYSR[r, 8] == 2) then "tt" elseif fix(lXSR[r, 8]+lYSR[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(lXSR[r,13]+lYSR[r,13] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,13]+lYSR[r,13] == 2) then "tt" elseif fix(lXSR[r,13]+lYSR[r,13] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(lXSR[r, 2]+lYSR[r, 2] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 2]+lYSR[r, 2] == 2) then "tt" elseif fix(lXSR[r, 2]+lYSR[r, 2] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(lXSR[r, 7]+lYSR[r, 7] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 7]+lYSR[r, 7] == 2) then "tt" elseif fix(lXSR[r, 7]+lYSR[r, 7] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(lXSR[r,12]+lYSR[r,12] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,12]+lYSR[r,12] == 2) then "tt" elseif fix(lXSR[r,12]+lYSR[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(lXSR[r, 1]+lYSR[r, 1] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 1]+lYSR[r, 1] == 2) then "tt" elseif fix(lXSR[r, 1]+lYSR[r, 1] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(lXSR[r, 6]+lYSR[r, 6] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 6]+lYSR[r, 6] == 2) then "tt" elseif fix(lXSR[r, 6]+lYSR[r, 6] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(lXSR[r,11]+lYSR[r,11] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,11]+lYSR[r,11] == 2) then "tt" elseif fix(lXSR[r,11]+lYSR[r,11] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    if fix(lVSR[r, 0] == 1) then "    \\draw[pattern=north west lines] (0,3) rectangle (1,4);\n" endif ++
    if fix(lVSR[r, 5] == 1) then "    \\draw[pattern=north west lines] (0,2) rectangle (1,3);\n" endif ++
    if fix(lVSR[r,10] == 1) then "    \\draw[pattern=north west lines] (0,1) rectangle (1,2);\n" endif ++
    if fix(lVSR[r,15] == 1) then "    \\draw[pattern=north west lines] (0,0) rectangle (1,1);\n" endif ++
    if fix(lVSR[r, 4] == 1) then "    \\draw[pattern=north west lines] (1,3) rectangle (2,4);\n" endif ++
    if fix(lVSR[r, 9] == 1) then "    \\draw[pattern=north west lines] (1,2) rectangle (2,3);\n" endif ++
    if fix(lVSR[r,14] == 1) then "    \\draw[pattern=north west lines] (1,1) rectangle (2,2);\n" endif ++
    if fix(lVSR[r, 3] == 1) then "    \\draw[pattern=north west lines] (1,0) rectangle (2,1);\n" endif ++
    if fix(lVSR[r, 8] == 1) then "    \\draw[pattern=north west lines] (2,3) rectangle (3,4);\n" endif ++
    if fix(lVSR[r,13] == 1) then "    \\draw[pattern=north west lines] (2,2) rectangle (3,3);\n" endif ++
    if fix(lVSR[r, 2] == 1) then "    \\draw[pattern=north west lines] (2,1) rectangle (3,2);\n" endif ++
    if fix(lVSR[r, 7] == 1) then "    \\draw[pattern=north west lines] (2,0) rectangle (3,1);\n" endif ++
    if fix(lVSR[r,12] == 1) then "    \\draw[pattern=north west lines] (3,3) rectangle (4,4);\n" endif ++
    if fix(lVSR[r, 1] == 1) then "    \\draw[pattern=north west lines] (3,2) rectangle (4,3);\n" endif ++
    if fix(lVSR[r, 6] == 1) then "    \\draw[pattern=north west lines] (3,1) rectangle (4,2);\n" endif ++
    if fix(lVSR[r,11] == 1) then "    \\draw[pattern=north west lines] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    if fix(lFMC[r, 0] == 1) then "    \\draw[fr, ultra thick] (0,3) rectangle (1,4);\n" endif ++
    if fix(lFMC[r, 1] == 1) then "    \\draw[fr, ultra thick] (0,2) rectangle (1,3);\n" endif ++
    if fix(lFMC[r, 2] == 1) then "    \\draw[fr, ultra thick] (0,1) rectangle (1,2);\n" endif ++
    if fix(lFMC[r, 3] == 1) then "    \\draw[fr, ultra thick] (0,0) rectangle (1,1);\n" endif ++
    if fix(lFMC[r, 4] == 1) then "    \\draw[fr, ultra thick] (1,3) rectangle (2,4);\n" endif ++
    if fix(lFMC[r, 5] == 1) then "    \\draw[fr, ultra thick] (1,2) rectangle (2,3);\n" endif ++
    if fix(lFMC[r, 6] == 1) then "    \\draw[fr, ultra thick] (1,1) rectangle (2,2);\n" endif ++
    if fix(lFMC[r, 7] == 1) then "    \\draw[fr, ultra thick] (1,0) rectangle (2,1);\n" endif ++
    if fix(lFMC[r, 8] == 1) then "    \\draw[fr, ultra thick] (2,3) rectangle (3,4);\n" endif ++
    if fix(lFMC[r, 9] == 1) then "    \\draw[fr, ultra thick] (2,2) rectangle (3,3);\n" endif ++
    if fix(lFMC[r,10] == 1) then "    \\draw[fr, ultra thick] (2,1) rectangle (3,2);\n" endif ++
    if fix(lFMC[r,11] == 1) then "    \\draw[fr, ultra thick] (2,0) rectangle (3,1);\n" endif ++
    if fix(lFMC[r,12] == 1) then "    \\draw[fr, ultra thick] (3,3) rectangle (4,4);\n" endif ++
    if fix(lFMC[r,13] == 1) then "    \\draw[fr, ultra thick] (3,2) rectangle (4,3);\n" endif ++
    if fix(lFMC[r,14] == 1) then "    \\draw[fr, ultra thick] (3,1) rectangle (4,2);\n" endif ++
    if fix(lFMC[r,15] == 1) then "    \\draw[fr, ultra thick] (3,0) rectangle (4,1);\n" endif ++
  if r <= Rb+Ru+Rm+Rl+Rf-2 then
    if fix(lSMC[r, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 0]) == fix(lSMC[r, 0]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 0]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 1]) == fix(lSMC[r, 1]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 1]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 2]) == fix(lSMC[r, 2]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 2]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 3]) == fix(lSMC[r, 3]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 3]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 4]) == fix(lSMC[r, 4]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 4]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 5]) == fix(lSMC[r, 5]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 5]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 6]) == fix(lSMC[r, 6]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 6]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 7]) == fix(lSMC[r, 7]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 7]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 8]) == fix(lSMC[r, 8]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 8]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 9]) == fix(lSMC[r, 9]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 9]) ++ "}$}};\n" endif ++
    if fix(lSMC[r,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r,10]) == fix(lSMC[r,10]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r,10]) ++ "}$}};\n" endif ++
    if fix(lSMC[r,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r,11]) == fix(lSMC[r,11]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r,11]) ++ "}$}};\n" endif ++
    if fix(lSMC[r,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r,12]) == fix(lSMC[r,12]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r,12]) ++ "}$}};\n" endif ++
    if fix(lSMC[r,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r,13]) == fix(lSMC[r,13]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r,13]) ++ "}$}};\n" endif ++
    if fix(lSMC[r,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r,14]) == fix(lSMC[r,14]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r,14]) ++ "}$}};\n" endif ++
    if fix(lSMC[r,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r,15]) == fix(lSMC[r,15]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r,15]) ++ "}$}};\n" endif
    endif ++
    "    \\draw[->] (4,2) -- node[above] {\\tiny MC} +(2,0);\n" ++
    if r == Rb-1 then "    \\node at (5,1.5)[below, fill opacity=0.5] {$\\stackrel{E_b}{\\leftarrow}$}\n"
    endif ++
    "  \\end{scope}\n"
  endif ++
  if r != Rb+Ru+Rm+Rl+Rf then
    "  \\begin{scope}[xshift=" ++ show(23) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta W_{" ++ show(r) ++ "}$};\n" ++
    if fix(lXAK[r+1, 0]+lYAK[r+1, 0] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 0]+lYAK[r+1, 0] == 2) then "tt" elseif fix(lXAK[r+1, 0]+lYAK[r+1, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(lXAK[r+1, 1]+lYAK[r+1, 1] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 1]+lYAK[r+1, 1] == 2) then "tt" elseif fix(lXAK[r+1, 1]+lYAK[r+1, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(lXAK[r+1, 2]+lYAK[r+1, 2] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 2]+lYAK[r+1, 2] == 2) then "tt" elseif fix(lXAK[r+1, 2]+lYAK[r+1, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(lXAK[r+1, 3]+lYAK[r+1, 3] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 3]+lYAK[r+1, 3] == 2) then "tt" elseif fix(lXAK[r+1, 3]+lYAK[r+1, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(lXAK[r+1, 4]+lYAK[r+1, 4] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 4]+lYAK[r+1, 4] == 2) then "tt" elseif fix(lXAK[r+1, 4]+lYAK[r+1, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(lXAK[r+1, 5]+lYAK[r+1, 5] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 5]+lYAK[r+1, 5] == 2) then "tt" elseif fix(lXAK[r+1, 5]+lYAK[r+1, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(lXAK[r+1, 6]+lYAK[r+1, 6] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 6]+lYAK[r+1, 6] == 2) then "tt" elseif fix(lXAK[r+1, 6]+lYAK[r+1, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(lXAK[r+1, 7]+lYAK[r+1, 7] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 7]+lYAK[r+1, 7] == 2) then "tt" elseif fix(lXAK[r+1, 7]+lYAK[r+1, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(lXAK[r+1, 8]+lYAK[r+1, 8] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 8]+lYAK[r+1, 8] == 2) then "tt" elseif fix(lXAK[r+1, 8]+lYAK[r+1, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(lXAK[r+1, 9]+lYAK[r+1, 9] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 9]+lYAK[r+1, 9] == 2) then "tt" elseif fix(lXAK[r+1, 9]+lYAK[r+1, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(lXAK[r+1,10]+lYAK[r+1,10] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,10]+lYAK[r+1,10] == 2) then "tt" elseif fix(lXAK[r+1,10]+lYAK[r+1,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(lXAK[r+1,11]+lYAK[r+1,11] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,11]+lYAK[r+1,11] == 2) then "tt" elseif fix(lXAK[r+1,11]+lYAK[r+1,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(lXAK[r+1,12]+lYAK[r+1,12] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,12]+lYAK[r+1,12] == 2) then "tt" elseif fix(lXAK[r+1,12]+lYAK[r+1,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(lXAK[r+1,13]+lYAK[r+1,13] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,13]+lYAK[r+1,13] == 2) then "tt" elseif fix(lXAK[r+1,13]+lYAK[r+1,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(lXAK[r+1,14]+lYAK[r+1,14] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,14]+lYAK[r+1,14] == 2) then "tt" elseif fix(lXAK[r+1,14]+lYAK[r+1,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(lXAK[r+1,15]+lYAK[r+1,15] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,15]+lYAK[r+1,15] == 2) then "tt" elseif fix(lXAK[r+1,15]+lYAK[r+1,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
  if r != Rb+Ru+Rm+Rl-1 then
    if fix(lVAK[r+1, 0] == 1) then "    \\draw[pattern=north west lines] (0,3) rectangle (1,4);\n" endif ++
    if fix(lVAK[r+1, 1] == 1) then "    \\draw[pattern=north west lines] (0,2) rectangle (1,3);\n" endif ++
    if fix(lVAK[r+1, 2] == 1) then "    \\draw[pattern=north west lines] (0,1) rectangle (1,2);\n" endif ++
    if fix(lVAK[r+1, 3] == 1) then "    \\draw[pattern=north west lines] (0,0) rectangle (1,1);\n" endif ++
    if fix(lVAK[r+1, 4] == 1) then "    \\draw[pattern=north west lines] (1,3) rectangle (2,4);\n" endif ++
    if fix(lVAK[r+1, 5] == 1) then "    \\draw[pattern=north west lines] (1,2) rectangle (2,3);\n" endif ++
    if fix(lVAK[r+1, 6] == 1) then "    \\draw[pattern=north west lines] (1,1) rectangle (2,2);\n" endif ++
    if fix(lVAK[r+1, 7] == 1) then "    \\draw[pattern=north west lines] (1,0) rectangle (2,1);\n" endif ++
    if fix(lVAK[r+1, 8] == 1) then "    \\draw[pattern=north west lines] (2,3) rectangle (3,4);\n" endif ++
    if fix(lVAK[r+1, 9] == 1) then "    \\draw[pattern=north west lines] (2,2) rectangle (3,3);\n" endif ++
    if fix(lVAK[r+1,10] == 1) then "    \\draw[pattern=north west lines] (2,1) rectangle (3,2);\n" endif ++
    if fix(lVAK[r+1,11] == 1) then "    \\draw[pattern=north west lines] (2,0) rectangle (3,1);\n" endif ++
    if fix(lVAK[r+1,12] == 1) then "    \\draw[pattern=north west lines] (3,3) rectangle (4,4);\n" endif ++
    if fix(lVAK[r+1,13] == 1) then "    \\draw[pattern=north west lines] (3,2) rectangle (4,3);\n" endif ++
    if fix(lVAK[r+1,14] == 1) then "    \\draw[pattern=north west lines] (3,1) rectangle (4,2);\n" endif ++
    if fix(lVAK[r+1,15] == 1) then "    \\draw[pattern=north west lines] (3,0) rectangle (4,1);\n" endif
  endif ++
  if r+1 <= Rb+Ru+Rm+Rl+Rf-1 then
    if fix(lSSB[r+1, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 0]) == fix(lSSB[r+1, 0]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 0]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 1]) == fix(lSSB[r+1, 1]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 1]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 2]) == fix(lSSB[r+1, 2]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 2]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 3]) == fix(lSSB[r+1, 3]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 3]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 4]) == fix(lSSB[r+1, 4]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 4]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 5]) == fix(lSSB[r+1, 5]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 5]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 6]) == fix(lSSB[r+1, 6]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 6]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 7]) == fix(lSSB[r+1, 7]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 7]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 8]) == fix(lSSB[r+1, 8]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 8]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 9]) == fix(lSSB[r+1, 9]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 9]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1,10]) == fix(lSSB[r+1,10]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1,10]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1,11]) == fix(lSSB[r+1,11]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1,11]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1,12]) == fix(lSSB[r+1,12]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1,12]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1,13]) == fix(lSSB[r+1,13]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1,13]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1,14]) == fix(lSSB[r+1,14]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1,14]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1,15]) == fix(lSSB[r+1,15]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1,15]) ++ "}$}};\n" endif
  endif ++
    "    \\draw[->] (4,2) --  +(2,0);\n" ++
    "    \\node at (5,2) {$\\oplus$};\n"++
    if r == Rb+Ru+Rm+Rl+Rf-1 then "\\node at (7,2) {$\\Delta C$};\n" endif ++
    "  \\end{scope}\n"
  endif ++
    "\\end{scope}\n\n"

  
  elseif r != Rb+Ru+Rm+Rl+Rf then 
    "\\begin{scope}[yshift=-" ++ show(((r-1)/2)*6+ypass) ++ "cm]\n" ++
    "  \\begin{scope}[xshift=" ++ show(29) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta X_{" ++ show(r) ++ "}$};\n" ++
    if fix(lXSB[r, 0]+lYSB[r, 0] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 0]+lYSB[r, 0] == 2) then "tt" elseif fix(lXSB[r, 0]+lYSB[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(lXSB[r, 1]+lYSB[r, 1] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 1]+lYSB[r, 1] == 2) then "tt" elseif fix(lXSB[r, 1]+lYSB[r, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(lXSB[r, 2]+lYSB[r, 2] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 2]+lYSB[r, 2] == 2) then "tt" elseif fix(lXSB[r, 2]+lYSB[r, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(lXSB[r, 3]+lYSB[r, 3] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 3]+lYSB[r, 3] == 2) then "tt" elseif fix(lXSB[r, 3]+lYSB[r, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(lXSB[r, 4]+lYSB[r, 4] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 4]+lYSB[r, 4] == 2) then "tt" elseif fix(lXSB[r, 4]+lYSB[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(lXSB[r, 5]+lYSB[r, 5] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 5]+lYSB[r, 5] == 2) then "tt" elseif fix(lXSB[r, 5]+lYSB[r, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(lXSB[r, 6]+lYSB[r, 6] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 6]+lYSB[r, 6] == 2) then "tt" elseif fix(lXSB[r, 6]+lYSB[r, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(lXSB[r, 7]+lYSB[r, 7] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 7]+lYSB[r, 7] == 2) then "tt" elseif fix(lXSB[r, 7]+lYSB[r, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(lXSB[r, 8]+lYSB[r, 8] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 8]+lYSB[r, 8] == 2) then "tt" elseif fix(lXSB[r, 8]+lYSB[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(lXSB[r, 9]+lYSB[r, 9] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r, 9]+lYSB[r, 9] == 2) then "tt" elseif fix(lXSB[r, 9]+lYSB[r, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(lXSB[r,10]+lYSB[r,10] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,10]+lYSB[r,10] == 2) then "tt" elseif fix(lXSB[r,10]+lYSB[r,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(lXSB[r,11]+lYSB[r,11] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,11]+lYSB[r,11] == 2) then "tt" elseif fix(lXSB[r,11]+lYSB[r,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(lXSB[r,12]+lYSB[r,12] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,12]+lYSB[r,12] == 2) then "tt" elseif fix(lXSB[r,12]+lYSB[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(lXSB[r,13]+lYSB[r,13] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,13]+lYSB[r,13] == 2) then "tt" elseif fix(lXSB[r,13]+lYSB[r,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(lXSB[r,14]+lYSB[r,14] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,14]+lYSB[r,14] == 2) then "tt" elseif fix(lXSB[r,14]+lYSB[r,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(lXSB[r,15]+lYSB[r,15] > 0) then 
    "    \\fill[" ++ if fix(lXSB[r,15]+lYSB[r,15] == 2) then "tt" elseif fix(lXSB[r,15]+lYSB[r,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    if fix(lVSB[r, 0] == 1) then "    \\draw[pattern=north west lines] (0,3) rectangle (1,4);\n" endif ++
    if fix(lVSB[r, 1] == 1) then "    \\draw[pattern=north west lines] (0,2) rectangle (1,3);\n" endif ++
    if fix(lVSB[r, 2] == 1) then "    \\draw[pattern=north west lines] (0,1) rectangle (1,2);\n" endif ++
    if fix(lVSB[r, 3] == 1) then "    \\draw[pattern=north west lines] (0,0) rectangle (1,1);\n" endif ++
    if fix(lVSB[r, 4] == 1) then "    \\draw[pattern=north west lines] (1,3) rectangle (2,4);\n" endif ++
    if fix(lVSB[r, 5] == 1) then "    \\draw[pattern=north west lines] (1,2) rectangle (2,3);\n" endif ++
    if fix(lVSB[r, 6] == 1) then "    \\draw[pattern=north west lines] (1,1) rectangle (2,2);\n" endif ++
    if fix(lVSB[r, 7] == 1) then "    \\draw[pattern=north west lines] (1,0) rectangle (2,1);\n" endif ++
    if fix(lVSB[r, 8] == 1) then "    \\draw[pattern=north west lines] (2,3) rectangle (3,4);\n" endif ++
    if fix(lVSB[r, 9] == 1) then "    \\draw[pattern=north west lines] (2,2) rectangle (3,3);\n" endif ++
    if fix(lVSB[r,10] == 1) then "    \\draw[pattern=north west lines] (2,1) rectangle (3,2);\n" endif ++
    if fix(lVSB[r,11] == 1) then "    \\draw[pattern=north west lines] (2,0) rectangle (3,1);\n" endif ++
    if fix(lVSB[r,12] == 1) then "    \\draw[pattern=north west lines] (3,3) rectangle (4,4);\n" endif ++
    if fix(lVSB[r,13] == 1) then "    \\draw[pattern=north west lines] (3,2) rectangle (4,3);\n" endif ++
    if fix(lVSB[r,14] == 1) then "    \\draw[pattern=north west lines] (3,1) rectangle (4,2);\n" endif ++
    if fix(lVSB[r,15] == 1) then "    \\draw[pattern=north west lines] (3,0) rectangle (4,1);\n" endif ++
    
    if fix(lFSB[r, 0] == 1) then "    \\draw[fr, ultra thick] (0,3) rectangle (1,4);\n" endif ++
    if fix(lFSB[r, 1] == 1) then "    \\draw[fr, ultra thick] (0,2) rectangle (1,3);\n" endif ++
    if fix(lFSB[r, 2] == 1) then "    \\draw[fr, ultra thick] (0,1) rectangle (1,2);\n" endif ++
    if fix(lFSB[r, 3] == 1) then "    \\draw[fr, ultra thick] (0,0) rectangle (1,1);\n" endif ++
    if fix(lFSB[r, 4] == 1) then "    \\draw[fr, ultra thick] (1,3) rectangle (2,4);\n" endif ++
    if fix(lFSB[r, 5] == 1) then "    \\draw[fr, ultra thick] (1,2) rectangle (2,3);\n" endif ++
    if fix(lFSB[r, 6] == 1) then "    \\draw[fr, ultra thick] (1,1) rectangle (2,2);\n" endif ++
    if fix(lFSB[r, 7] == 1) then "    \\draw[fr, ultra thick] (1,0) rectangle (2,1);\n" endif ++
    if fix(lFSB[r, 8] == 1) then "    \\draw[fr, ultra thick] (2,3) rectangle (3,4);\n" endif ++
    if fix(lFSB[r, 9] == 1) then "    \\draw[fr, ultra thick] (2,2) rectangle (3,3);\n" endif ++
    if fix(lFSB[r,10] == 1) then "    \\draw[fr, ultra thick] (2,1) rectangle (3,2);\n" endif ++
    if fix(lFSB[r,11] == 1) then "    \\draw[fr, ultra thick] (2,0) rectangle (3,1);\n" endif ++
    if fix(lFSB[r,12] == 1) then "    \\draw[fr, ultra thick] (3,3) rectangle (4,4);\n" endif ++
    if fix(lFSB[r,13] == 1) then "    \\draw[fr, ultra thick] (3,2) rectangle (4,3);\n" endif ++
    if fix(lFSB[r,14] == 1) then "    \\draw[fr, ultra thick] (3,1) rectangle (4,2);\n" endif ++
    if fix(lFSB[r,15] == 1) then "    \\draw[fr, ultra thick] (3,0) rectangle (4,1);\n" endif ++
  if r <= Rb+Ru+Rm+Rl+Rf-1 then
    if fix(lSSB[r, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 0]) == fix(lSSB[r, 0]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 0]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 1]) == fix(lSSB[r, 1]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 1]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 2]) == fix(lSSB[r, 2]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 2]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 3]) == fix(lSSB[r, 3]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 3]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 4]) == fix(lSSB[r, 4]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 4]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 5]) == fix(lSSB[r, 5]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 5]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 6]) == fix(lSSB[r, 6]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 6]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 7]) == fix(lSSB[r, 7]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 7]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 8]) == fix(lSSB[r, 8]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 8]) ++ "}$}};\n" endif ++
    if fix(lSSB[r, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r, 9]) == fix(lSSB[r, 9]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r, 9]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,10]) == fix(lSSB[r,10]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,10]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,11]) == fix(lSSB[r,11]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,11]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,12]) == fix(lSSB[r,12]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,12]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,13]) == fix(lSSB[r,13]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,13]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,14]) == fix(lSSB[r,14]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,14]) ++ "}$}};\n" endif ++
    if fix(lSSB[r,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r,15]) == fix(lSSB[r,15]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r,15]) ++ "}$}};\n" endif
    endif ++
    "    \\draw[->] (4,2) -- node[above] {\\tiny SB} node[below] {\\tiny $\\stackrel{\\textcolor{geqk}{eqk}}{\\text{SR}}$} +(2,0);\n" ++
    "  \\end{scope}\n" ++ 

    % -----------------------------
    "  \\begin{scope}[xshift=" ++ show(35) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta Z_{" ++ show(r) ++ "}$};\n" ++
    if fix(lXSR[r, 0]+lYSR[r, 0] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 0]+lYSR[r, 0] == 2) then "tt" elseif fix(lXSR[r, 0]+lYSR[r, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(lXSR[r, 5]+lYSR[r, 5] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 5]+lYSR[r, 5] == 2) then "tt" elseif fix(lXSR[r, 5]+lYSR[r, 5] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(lXSR[r,10]+lYSR[r,10] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,10]+lYSR[r,10] == 2) then "tt" elseif fix(lXSR[r,10]+lYSR[r,10] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(lXSR[r,15]+lYSR[r,15] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,15]+lYSR[r,15] == 2) then "tt" elseif fix(lXSR[r,15]+lYSR[r,15] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(lXSR[r, 4]+lYSR[r, 4] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 4]+lYSR[r, 4] == 2) then "tt" elseif fix(lXSR[r, 4]+lYSR[r, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(lXSR[r, 9]+lYSR[r, 9] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 9]+lYSR[r, 9] == 2) then "tt" elseif fix(lXSR[r, 9]+lYSR[r, 9] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(lXSR[r,14]+lYSR[r,14] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,14]+lYSR[r,14] == 2) then "tt" elseif fix(lXSR[r,14]+lYSR[r,14] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(lXSR[r, 3]+lYSR[r, 3] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 3]+lYSR[r, 3] == 2) then "tt" elseif fix(lXSR[r, 3]+lYSR[r, 3] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(lXSR[r, 8]+lYSR[r, 8] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 8]+lYSR[r, 8] == 2) then "tt" elseif fix(lXSR[r, 8]+lYSR[r, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(lXSR[r,13]+lYSR[r,13] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,13]+lYSR[r,13] == 2) then "tt" elseif fix(lXSR[r,13]+lYSR[r,13] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(lXSR[r, 2]+lYSR[r, 2] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 2]+lYSR[r, 2] == 2) then "tt" elseif fix(lXSR[r, 2]+lYSR[r, 2] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(lXSR[r, 7]+lYSR[r, 7] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 7]+lYSR[r, 7] == 2) then "tt" elseif fix(lXSR[r, 7]+lYSR[r, 7] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(lXSR[r,12]+lYSR[r,12] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,12]+lYSR[r,12] == 2) then "tt" elseif fix(lXSR[r,12]+lYSR[r,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(lXSR[r, 1]+lYSR[r, 1] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 1]+lYSR[r, 1] == 2) then "tt" elseif fix(lXSR[r, 1]+lYSR[r, 1] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(lXSR[r, 6]+lYSR[r, 6] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r, 6]+lYSR[r, 6] == 2) then "tt" elseif fix(lXSR[r, 6]+lYSR[r, 6] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(lXSR[r,11]+lYSR[r,11] > 0) then 
    "    \\fill[" ++ if fix(lXSR[r,11]+lYSR[r,11] == 2) then "tt" elseif fix(lXSR[r,11]+lYSR[r,11] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    if fix(lVSR[r, 0] == 1) then "    \\draw[pattern=north west lines] (0,3) rectangle (1,4);\n" endif ++
    if fix(lVSR[r, 5] == 1) then "    \\draw[pattern=north west lines] (0,2) rectangle (1,3);\n" endif ++
    if fix(lVSR[r,10] == 1) then "    \\draw[pattern=north west lines] (0,1) rectangle (1,2);\n" endif ++
    if fix(lVSR[r,15] == 1) then "    \\draw[pattern=north west lines] (0,0) rectangle (1,1);\n" endif ++
    if fix(lVSR[r, 4] == 1) then "    \\draw[pattern=north west lines] (1,3) rectangle (2,4);\n" endif ++
    if fix(lVSR[r, 9] == 1) then "    \\draw[pattern=north west lines] (1,2) rectangle (2,3);\n" endif ++
    if fix(lVSR[r,14] == 1) then "    \\draw[pattern=north west lines] (1,1) rectangle (2,2);\n" endif ++
    if fix(lVSR[r, 3] == 1) then "    \\draw[pattern=north west lines] (1,0) rectangle (2,1);\n" endif ++
    if fix(lVSR[r, 8] == 1) then "    \\draw[pattern=north west lines] (2,3) rectangle (3,4);\n" endif ++
    if fix(lVSR[r,13] == 1) then "    \\draw[pattern=north west lines] (2,2) rectangle (3,3);\n" endif ++
    if fix(lVSR[r, 2] == 1) then "    \\draw[pattern=north west lines] (2,1) rectangle (3,2);\n" endif ++
    if fix(lVSR[r, 7] == 1) then "    \\draw[pattern=north west lines] (2,0) rectangle (3,1);\n" endif ++
    if fix(lVSR[r,12] == 1) then "    \\draw[pattern=north west lines] (3,3) rectangle (4,4);\n" endif ++
    if fix(lVSR[r, 1] == 1) then "    \\draw[pattern=north west lines] (3,2) rectangle (4,3);\n" endif ++
    if fix(lVSR[r, 6] == 1) then "    \\draw[pattern=north west lines] (3,1) rectangle (4,2);\n" endif ++
    if fix(lVSR[r,11] == 1) then "    \\draw[pattern=north west lines] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    if fix(lFMC[r, 0] == 1) then "    \\draw[fr, ultra thick] (0,3) rectangle (1,4);\n" endif ++
    if fix(lFMC[r, 1] == 1) then "    \\draw[fr, ultra thick] (0,2) rectangle (1,3);\n" endif ++
    if fix(lFMC[r, 2] == 1) then "    \\draw[fr, ultra thick] (0,1) rectangle (1,2);\n" endif ++
    if fix(lFMC[r, 3] == 1) then "    \\draw[fr, ultra thick] (0,0) rectangle (1,1);\n" endif ++
    if fix(lFMC[r, 4] == 1) then "    \\draw[fr, ultra thick] (1,3) rectangle (2,4);\n" endif ++
    if fix(lFMC[r, 5] == 1) then "    \\draw[fr, ultra thick] (1,2) rectangle (2,3);\n" endif ++
    if fix(lFMC[r, 6] == 1) then "    \\draw[fr, ultra thick] (1,1) rectangle (2,2);\n" endif ++
    if fix(lFMC[r, 7] == 1) then "    \\draw[fr, ultra thick] (1,0) rectangle (2,1);\n" endif ++
    if fix(lFMC[r, 8] == 1) then "    \\draw[fr, ultra thick] (2,3) rectangle (3,4);\n" endif ++
    if fix(lFMC[r, 9] == 1) then "    \\draw[fr, ultra thick] (2,2) rectangle (3,3);\n" endif ++
    if fix(lFMC[r,10] == 1) then "    \\draw[fr, ultra thick] (2,1) rectangle (3,2);\n" endif ++
    if fix(lFMC[r,11] == 1) then "    \\draw[fr, ultra thick] (2,0) rectangle (3,1);\n" endif ++
    if fix(lFMC[r,12] == 1) then "    \\draw[fr, ultra thick] (3,3) rectangle (4,4);\n" endif ++
    if fix(lFMC[r,13] == 1) then "    \\draw[fr, ultra thick] (3,2) rectangle (4,3);\n" endif ++
    if fix(lFMC[r,14] == 1) then "    \\draw[fr, ultra thick] (3,1) rectangle (4,2);\n" endif ++
    if fix(lFMC[r,15] == 1) then "    \\draw[fr, ultra thick] (3,0) rectangle (4,1);\n" endif ++
  if r <= Rb+Ru+Rm+Rl+Rf-2 then
    if fix(lSMC[r, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 0]) == fix(lSMC[r, 0]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 0]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 1]) == fix(lSMC[r, 1]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 1]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 2]) == fix(lSMC[r, 2]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 2]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 3]) == fix(lSMC[r, 3]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 3]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 4]) == fix(lSMC[r, 4]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 4]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 5]) == fix(lSMC[r, 5]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 5]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 6]) == fix(lSMC[r, 6]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 6]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 7]) == fix(lSMC[r, 7]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 7]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 8]) == fix(lSMC[r, 8]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 8]) ++ "}$}};\n" endif ++
    if fix(lSMC[r, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r, 9]) == fix(lSMC[r, 9]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r, 9]) ++ "}$}};\n" endif ++
    if fix(lSMC[r,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r,10]) == fix(lSMC[r,10]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r,10]) ++ "}$}};\n" endif ++
    if fix(lSMC[r,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r,11]) == fix(lSMC[r,11]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r,11]) ++ "}$}};\n" endif ++
    if fix(lSMC[r,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r,12]) == fix(lSMC[r,12]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r,12]) ++ "}$}};\n" endif ++
    if fix(lSMC[r,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r,13]) == fix(lSMC[r,13]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r,13]) ++ "}$}};\n" endif ++
    if fix(lSMC[r,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r,14]) == fix(lSMC[r,14]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r,14]) ++ "}$}};\n" endif ++
    if fix(lSMC[r,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEMC[r,15]) == fix(lSMC[r,15]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSMC[r,15]) ++ "}$}};\n" endif
    endif ++
    "    \\draw[->] (4,2) -- node[above] {\\tiny MC} +(2,0);\n" ++
    if r == Rb-1 then "    \\node at (5,1.5)[below, fill opacity=0.5] {$\\stackrel{E_b}{\\leftarrow}$}\n"
    endif ++
    "  \\end{scope}\n" ++ 
    
    "  \\begin{scope}[xshift=" ++ show(41) ++ "cm]\n" ++
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta W_{" ++ show(r) ++ "}$};\n" ++
    if fix(lXAK[r+1, 0]+lYAK[r+1, 0] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 0]+lYAK[r+1, 0] == 2) then "tt" elseif fix(lXAK[r+1, 0]+lYAK[r+1, 0] == 1) then "fs" endif ++ "] (0,3) rectangle (1,4);\n" endif ++
    if fix(lXAK[r+1, 1]+lYAK[r+1, 1] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 1]+lYAK[r+1, 1] == 2) then "tt" elseif fix(lXAK[r+1, 1]+lYAK[r+1, 1] == 1) then "fs" endif ++ "] (0,2) rectangle (1,3);\n" endif ++
    if fix(lXAK[r+1, 2]+lYAK[r+1, 2] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 2]+lYAK[r+1, 2] == 2) then "tt" elseif fix(lXAK[r+1, 2]+lYAK[r+1, 2] == 1) then "fs" endif ++ "] (0,1) rectangle (1,2);\n" endif ++
    if fix(lXAK[r+1, 3]+lYAK[r+1, 3] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 3]+lYAK[r+1, 3] == 2) then "tt" elseif fix(lXAK[r+1, 3]+lYAK[r+1, 3] == 1) then "fs" endif ++ "] (0,0) rectangle (1,1);\n" endif ++
    if fix(lXAK[r+1, 4]+lYAK[r+1, 4] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 4]+lYAK[r+1, 4] == 2) then "tt" elseif fix(lXAK[r+1, 4]+lYAK[r+1, 4] == 1) then "fs" endif ++ "] (1,3) rectangle (2,4);\n" endif ++
    if fix(lXAK[r+1, 5]+lYAK[r+1, 5] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 5]+lYAK[r+1, 5] == 2) then "tt" elseif fix(lXAK[r+1, 5]+lYAK[r+1, 5] == 1) then "fs" endif ++ "] (1,2) rectangle (2,3);\n" endif ++
    if fix(lXAK[r+1, 6]+lYAK[r+1, 6] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 6]+lYAK[r+1, 6] == 2) then "tt" elseif fix(lXAK[r+1, 6]+lYAK[r+1, 6] == 1) then "fs" endif ++ "] (1,1) rectangle (2,2);\n" endif ++
    if fix(lXAK[r+1, 7]+lYAK[r+1, 7] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 7]+lYAK[r+1, 7] == 2) then "tt" elseif fix(lXAK[r+1, 7]+lYAK[r+1, 7] == 1) then "fs" endif ++ "] (1,0) rectangle (2,1);\n" endif ++
    if fix(lXAK[r+1, 8]+lYAK[r+1, 8] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 8]+lYAK[r+1, 8] == 2) then "tt" elseif fix(lXAK[r+1, 8]+lYAK[r+1, 8] == 1) then "fs" endif ++ "] (2,3) rectangle (3,4);\n" endif ++
    if fix(lXAK[r+1, 9]+lYAK[r+1, 9] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1, 9]+lYAK[r+1, 9] == 2) then "tt" elseif fix(lXAK[r+1, 9]+lYAK[r+1, 9] == 1) then "fs" endif ++ "] (2,2) rectangle (3,3);\n" endif ++
    if fix(lXAK[r+1,10]+lYAK[r+1,10] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,10]+lYAK[r+1,10] == 2) then "tt" elseif fix(lXAK[r+1,10]+lYAK[r+1,10] == 1) then "fs" endif ++ "] (2,1) rectangle (3,2);\n" endif ++ 
    if fix(lXAK[r+1,11]+lYAK[r+1,11] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,11]+lYAK[r+1,11] == 2) then "tt" elseif fix(lXAK[r+1,11]+lYAK[r+1,11] == 1) then "fs" endif ++ "] (2,0) rectangle (3,1);\n" endif ++
    if fix(lXAK[r+1,12]+lYAK[r+1,12] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,12]+lYAK[r+1,12] == 2) then "tt" elseif fix(lXAK[r+1,12]+lYAK[r+1,12] == 1) then "fs" endif ++ "] (3,3) rectangle (4,4);\n" endif ++
    if fix(lXAK[r+1,13]+lYAK[r+1,13] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,13]+lYAK[r+1,13] == 2) then "tt" elseif fix(lXAK[r+1,13]+lYAK[r+1,13] == 1) then "fs" endif ++ "] (3,2) rectangle (4,3);\n" endif ++
    if fix(lXAK[r+1,14]+lYAK[r+1,14] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,14]+lYAK[r+1,14] == 2) then "tt" elseif fix(lXAK[r+1,14]+lYAK[r+1,14] == 1) then "fs" endif ++ "] (3,1) rectangle (4,2);\n" endif ++    
    if fix(lXAK[r+1,15]+lYAK[r+1,15] > 0) then 
    "    \\fill[" ++ if fix(lXAK[r+1,15]+lYAK[r+1,15] == 2) then "tt" elseif fix(lXAK[r+1,15]+lYAK[r+1,15] == 1) then "fs" endif ++ "] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
  if r != Rb+Ru+Rm+Rl then
    if fix(lVAK[r+1, 0] == 1) then "    \\draw[pattern=north west lines] (0,3) rectangle (1,4);\n" endif ++
    if fix(lVAK[r+1, 1] == 1) then "    \\draw[pattern=north west lines] (0,2) rectangle (1,3);\n" endif ++
    if fix(lVAK[r+1, 2] == 1) then "    \\draw[pattern=north west lines] (0,1) rectangle (1,2);\n" endif ++
    if fix(lVAK[r+1, 3] == 1) then "    \\draw[pattern=north west lines] (0,0) rectangle (1,1);\n" endif ++
    if fix(lVAK[r+1, 4] == 1) then "    \\draw[pattern=north west lines] (1,3) rectangle (2,4);\n" endif ++
    if fix(lVAK[r+1, 5] == 1) then "    \\draw[pattern=north west lines] (1,2) rectangle (2,3);\n" endif ++
    if fix(lVAK[r+1, 6] == 1) then "    \\draw[pattern=north west lines] (1,1) rectangle (2,2);\n" endif ++
    if fix(lVAK[r+1, 7] == 1) then "    \\draw[pattern=north west lines] (1,0) rectangle (2,1);\n" endif ++
    if fix(lVAK[r+1, 8] == 1) then "    \\draw[pattern=north west lines] (2,3) rectangle (3,4);\n" endif ++
    if fix(lVAK[r+1, 9] == 1) then "    \\draw[pattern=north west lines] (2,2) rectangle (3,3);\n" endif ++
    if fix(lVAK[r+1,10] == 1) then "    \\draw[pattern=north west lines] (2,1) rectangle (3,2);\n" endif ++
    if fix(lVAK[r+1,11] == 1) then "    \\draw[pattern=north west lines] (2,0) rectangle (3,1);\n" endif ++
    if fix(lVAK[r+1,12] == 1) then "    \\draw[pattern=north west lines] (3,3) rectangle (4,4);\n" endif ++
    if fix(lVAK[r+1,13] == 1) then "    \\draw[pattern=north west lines] (3,2) rectangle (4,3);\n" endif ++
    if fix(lVAK[r+1,14] == 1) then "    \\draw[pattern=north west lines] (3,1) rectangle (4,2);\n" endif ++
    if fix(lVAK[r+1,15] == 1) then "    \\draw[pattern=north west lines] (3,0) rectangle (4,1);\n" endif
  endif ++
  if r <= Rb+Ru+Rm+Rl+Rf-2 then
    if fix(lSSB[r+1, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 0]) == fix(lSSB[r+1, 0]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 0]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 1]) == fix(lSSB[r+1, 1]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 1]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 2]) == fix(lSSB[r+1, 2]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 2]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 3]) == fix(lSSB[r+1, 3]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 3]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 4]) == fix(lSSB[r+1, 4]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 4]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 5]) == fix(lSSB[r+1, 5]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 5]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 6]) == fix(lSSB[r+1, 6]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 6]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 7]) == fix(lSSB[r+1, 7]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 7]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 8]) == fix(lSSB[r+1, 8]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 8]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1, 9]) == fix(lSSB[r+1, 9]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1, 9]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1,10]) == fix(lSSB[r+1,10]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1,10]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1,11]) == fix(lSSB[r+1,11]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1,11]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1,12]) == fix(lSSB[r+1,12]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1,12]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1,13]) == fix(lSSB[r+1,13]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1,13]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1,14]) == fix(lSSB[r+1,14]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1,14]) ++ "}$}};\n" endif ++
    if fix(lSSB[r+1,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lESB[r+1,15]) == fix(lSSB[r+1,15]) then "red" else "black" endif ++ "} \\bm{$\\mathsf{" ++ show(lSSB[r+1,15]) ++ "}$}};\n" endif
    endif ++
    "  \\end{scope}\n" ++
    
    "  \\begin{scope}[xshift=" ++ show(46) ++ "cm]\n" ++    
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta STK_{" ++ show(r) ++ "}$};\n" ++
    if fix(lSTK[r, 0]) == 1 then "    \\fill[fk] (0,3) rectangle (1,4);\n" endif ++
    if fix(lSTK[r, 1]) == 1 then "    \\fill[fk] (0,2) rectangle (1,3);\n" endif ++
    if fix(lSTK[r, 2]) == 1 then "    \\fill[fk] (0,1) rectangle (1,2);\n" endif ++
    if fix(lSTK[r, 3]) == 1 then "    \\fill[fk] (0,0) rectangle (1,1);\n" endif ++
    if fix(lSTK[r, 4]) == 1 then "    \\fill[fk] (1,3) rectangle (2,4);\n" endif ++
    if fix(lSTK[r, 5]) == 1 then "    \\fill[fk] (1,2) rectangle (2,3);\n" endif ++
    if fix(lSTK[r, 6]) == 1 then "    \\fill[fk] (1,1) rectangle (2,2);\n" endif ++
    if fix(lSTK[r, 7]) == 1 then "    \\fill[fk] (1,0) rectangle (2,1);\n" endif ++
    if fix(lSTK[r, 8]) == 1 then "    \\fill[fk] (2,3) rectangle (3,4);\n" endif ++
    if fix(lSTK[r, 9]) == 1 then "    \\fill[fk] (2,2) rectangle (3,3);\n" endif ++
    if fix(lSTK[r,10]) == 1 then "    \\fill[fk] (2,1) rectangle (3,2);\n" endif ++
    if fix(lSTK[r,11]) == 1 then "    \\fill[fk] (2,0) rectangle (3,1);\n" endif ++
    if fix(lSTK[r,12]) == 1 then "    \\fill[fk] (3,3) rectangle (4,4);\n" endif ++
    if fix(lSTK[r,13]) == 1 then "    \\fill[fk] (3,2) rectangle (4,3);\n" endif ++
    if fix(lSTK[r,14]) == 1 then "    \\fill[fk] (3,1) rectangle (4,2);\n" endif ++
    if fix(lSTK[r,15]) == 1 then "    \\fill[fk] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
  if r != Rb+Ru+Rm+Rl then
    if fix(lGSTK[r, 0]) == 1 then "    \\draw[geqk, ultra thick] (0,3) rectangle (1,4);\n" endif ++
    if fix(lGSTK[r, 1]) == 1 then "    \\draw[geqk, ultra thick] (0,2) rectangle (1,3);\n" endif ++
    if fix(lGSTK[r, 2]) == 1 then "    \\draw[geqk, ultra thick] (0,1) rectangle (1,2);\n" endif ++
    if fix(lGSTK[r, 3]) == 1 then "    \\draw[geqk, ultra thick] (0,0) rectangle (1,1);\n" endif ++
    if fix(lGSTK[r, 4]) == 1 then "    \\draw[geqk, ultra thick] (1,3) rectangle (2,4);\n" endif ++
    if fix(lGSTK[r, 5]) == 1 then "    \\draw[geqk, ultra thick] (1,2) rectangle (2,3);\n" endif ++
    if fix(lGSTK[r, 6]) == 1 then "    \\draw[geqk, ultra thick] (1,1) rectangle (2,2);\n" endif ++
    if fix(lGSTK[r, 7]) == 1 then "    \\draw[geqk, ultra thick] (1,0) rectangle (2,1);\n" endif ++
    if fix(lGSTK[r, 8]) == 1 then "    \\draw[geqk, ultra thick] (2,3) rectangle (3,4);\n" endif ++
    if fix(lGSTK[r, 9]) == 1 then "    \\draw[geqk, ultra thick] (2,2) rectangle (3,3);\n" endif ++
    if fix(lGSTK[r,10]) == 1 then "    \\draw[geqk, ultra thick] (2,1) rectangle (3,2);\n" endif ++
    if fix(lGSTK[r,11]) == 1 then "    \\draw[geqk, ultra thick] (2,0) rectangle (3,1);\n" endif ++
    if fix(lGSTK[r,12]) == 1 then "    \\draw[geqk, ultra thick] (3,3) rectangle (4,4);\n" endif ++
    if fix(lGSTK[r,13]) == 1 then "    \\draw[geqk, ultra thick] (3,2) rectangle (4,3);\n" endif ++
    if fix(lGSTK[r,14]) == 1 then "    \\draw[geqk, ultra thick] (3,1) rectangle (4,2);\n" endif ++
    if fix(lGSTK[r,15]) == 1 then "    \\draw[geqk, ultra thick] (3,0) rectangle (4,1);\n" endif ++
    
    if fix(lSGK[r, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 0]) == fix(lSGK[r, 0]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 0]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 1]) == fix(lSGK[r, 1]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 1]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 2]) == fix(lSGK[r, 2]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 2]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 3]) == fix(lSGK[r, 3]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 3]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 4]) == fix(lSGK[r, 4]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 4]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 5]) == fix(lSGK[r, 5]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 5]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 6]) == fix(lSGK[r, 6]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 6]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 7]) == fix(lSGK[r, 7]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 7]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 8]) == fix(lSGK[r, 8]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 8]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 9]) == fix(lSGK[r, 9]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 9]) ++ "}$};\n" endif ++
    if fix(lSGK[r,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,10]) == fix(lSGK[r,10]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,10]) ++ "}$};\n" endif ++
    if fix(lSGK[r,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,11]) == fix(lSGK[r,11]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,11]) ++ "}$};\n" endif ++
    if fix(lSGK[r,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,12]) == fix(lSGK[r,12]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,12]) ++ "}$};\n" endif ++
    if fix(lSGK[r,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,13]) == fix(lSGK[r,13]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,13]) ++ "}$};\n" endif ++
    if fix(lSGK[r,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,14]) == fix(lSGK[r,14]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,14]) ++ "}$};\n" endif ++
    if fix(lSGK[r,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,15]) == fix(lSGK[r,15]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,15]) ++ "}$};\n" endif
    endif ++
    "    \\draw[->] (2,4) -- ++(0,0.5) --++(-20,0) --++(0,-2.2);\n" ++
    "  \\end{scope}\n" ++

    "\\end{scope}\n\n"
    
  else 
  if r != Rb+Ru+Rm+Rl then
    "\\begin{scope}[yshift=-" ++ show(((r-1)/2)*6+ypass) ++ "cm]\n" ++
    "\\begin{scope}[xshift=" ++ show(46) ++ "cm]\n" ++    
    "    \\node at(2,0)[below] {\\scriptsize $\\Delta STK_{" ++ show(r) ++ "}$};\n" ++
    if fix(lSTK[r, 0]) == 1 then "    \\fill[fk] (0,3) rectangle (1,4);\n" endif ++
    if fix(lSTK[r, 1]) == 1 then "    \\fill[fk] (0,2) rectangle (1,3);\n" endif ++
    if fix(lSTK[r, 2]) == 1 then "    \\fill[fk] (0,1) rectangle (1,2);\n" endif ++
    if fix(lSTK[r, 3]) == 1 then "    \\fill[fk] (0,0) rectangle (1,1);\n" endif ++
    if fix(lSTK[r, 4]) == 1 then "    \\fill[fk] (1,3) rectangle (2,4);\n" endif ++
    if fix(lSTK[r, 5]) == 1 then "    \\fill[fk] (1,2) rectangle (2,3);\n" endif ++
    if fix(lSTK[r, 6]) == 1 then "    \\fill[fk] (1,1) rectangle (2,2);\n" endif ++
    if fix(lSTK[r, 7]) == 1 then "    \\fill[fk] (1,0) rectangle (2,1);\n" endif ++
    if fix(lSTK[r, 8]) == 1 then "    \\fill[fk] (2,3) rectangle (3,4);\n" endif ++
    if fix(lSTK[r, 9]) == 1 then "    \\fill[fk] (2,2) rectangle (3,3);\n" endif ++
    if fix(lSTK[r,10]) == 1 then "    \\fill[fk] (2,1) rectangle (3,2);\n" endif ++
    if fix(lSTK[r,11]) == 1 then "    \\fill[fk] (2,0) rectangle (3,1);\n" endif ++
    if fix(lSTK[r,12]) == 1 then "    \\fill[fk] (3,3) rectangle (4,4);\n" endif ++
    if fix(lSTK[r,13]) == 1 then "    \\fill[fk] (3,2) rectangle (4,3);\n" endif ++
    if fix(lSTK[r,14]) == 1 then "    \\fill[fk] (3,1) rectangle (4,2);\n" endif ++
    if fix(lSTK[r,15]) == 1 then "    \\fill[fk] (3,0) rectangle (4,1);\n" endif ++
    "    \\draw (0,0) rectangle (4,4);\n" ++
    "    \\draw (0,1) -- +(4,0);\n" ++
    "    \\draw (0,2) -- +(4,0);\n" ++
    "    \\draw (0,3) -- +(4,0);\n" ++
    "    \\draw (1,0) -- +(0,4);\n" ++
    "    \\draw (2,0) -- +(0,4);\n" ++
    "    \\draw (3,0) -- +(0,4);\n" ++
    if fix(lGSTK[r, 0]) == 1 then "    \\draw[geqk, ultra thick] (0,3) rectangle (1,4);\n" endif ++
    if fix(lGSTK[r, 1]) == 1 then "    \\draw[geqk, ultra thick] (0,2) rectangle (1,3);\n" endif ++
    if fix(lGSTK[r, 2]) == 1 then "    \\draw[geqk, ultra thick] (0,1) rectangle (1,2);\n" endif ++
    if fix(lGSTK[r, 3]) == 1 then "    \\draw[geqk, ultra thick] (0,0) rectangle (1,1);\n" endif ++
    if fix(lGSTK[r, 4]) == 1 then "    \\draw[geqk, ultra thick] (1,3) rectangle (2,4);\n" endif ++
    if fix(lGSTK[r, 5]) == 1 then "    \\draw[geqk, ultra thick] (1,2) rectangle (2,3);\n" endif ++
    if fix(lGSTK[r, 6]) == 1 then "    \\draw[geqk, ultra thick] (1,1) rectangle (2,2);\n" endif ++
    if fix(lGSTK[r, 7]) == 1 then "    \\draw[geqk, ultra thick] (1,0) rectangle (2,1);\n" endif ++
    if fix(lGSTK[r, 8]) == 1 then "    \\draw[geqk, ultra thick] (2,3) rectangle (3,4);\n" endif ++
    if fix(lGSTK[r, 9]) == 1 then "    \\draw[geqk, ultra thick] (2,2) rectangle (3,3);\n" endif ++
    if fix(lGSTK[r,10]) == 1 then "    \\draw[geqk, ultra thick] (2,1) rectangle (3,2);\n" endif ++
    if fix(lGSTK[r,11]) == 1 then "    \\draw[geqk, ultra thick] (2,0) rectangle (3,1);\n" endif ++
    if fix(lGSTK[r,12]) == 1 then "    \\draw[geqk, ultra thick] (3,3) rectangle (4,4);\n" endif ++
    if fix(lGSTK[r,13]) == 1 then "    \\draw[geqk, ultra thick] (3,2) rectangle (4,3);\n" endif ++
    if fix(lGSTK[r,14]) == 1 then "    \\draw[geqk, ultra thick] (3,1) rectangle (4,2);\n" endif ++
    if fix(lGSTK[r,15]) == 1 then "    \\draw[geqk, ultra thick] (3,0) rectangle (4,1);\n" endif ++
    if fix(lSGK[r, 0]) >= 0 then "    \\node at(0+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 0]) == fix(lSGK[r, 0]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 0]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 1]) >= 0 then "    \\node at(0+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 1]) == fix(lSGK[r, 1]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 1]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 2]) >= 0 then "    \\node at(0+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 2]) == fix(lSGK[r, 2]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 2]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 3]) >= 0 then "    \\node at(0+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 3]) == fix(lSGK[r, 3]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 3]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 4]) >= 0 then "    \\node at(1+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 4]) == fix(lSGK[r, 4]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 4]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 5]) >= 0 then "    \\node at(1+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 5]) == fix(lSGK[r, 5]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 5]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 6]) >= 0 then "    \\node at(1+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 6]) == fix(lSGK[r, 6]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 6]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 7]) >= 0 then "    \\node at(1+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 7]) == fix(lSGK[r, 7]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 7]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 8]) >= 0 then "    \\node at(2+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 8]) == fix(lSGK[r, 8]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 8]) ++ "}$};\n" endif ++
    if fix(lSGK[r, 9]) >= 0 then "    \\node at(2+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r, 9]) == fix(lSGK[r, 9]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r, 9]) ++ "}$};\n" endif ++
    if fix(lSGK[r,10]) >= 0 then "    \\node at(2+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,10]) == fix(lSGK[r,10]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,10]) ++ "}$};\n" endif ++
    if fix(lSGK[r,11]) >= 0 then "    \\node at(2+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,11]) == fix(lSGK[r,11]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,11]) ++ "}$};\n" endif ++
    if fix(lSGK[r,12]) >= 0 then "    \\node at(3+0.5,3+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,12]) == fix(lSGK[r,12]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,12]) ++ "}$};\n" endif ++
    if fix(lSGK[r,13]) >= 0 then "    \\node at(3+0.5,2+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,13]) == fix(lSGK[r,13]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,13]) ++ "}$};\n" endif ++
    if fix(lSGK[r,14]) >= 0 then "    \\node at(3+0.5,1+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,14]) == fix(lSGK[r,14]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,14]) ++ "}$};\n" endif ++
    if fix(lSGK[r,15]) >= 0 then "    \\node at(3+0.5,0+0.5) {\\scriptsize \\color{" ++ if fix(lEGK[r,15]) == fix(lSGK[r,15]) then "red" else "black" endif ++ "} $\\mathsf{" ++ show(lSGK[r,15]) ++ "}$};\n" endif ++
    "    \\draw[->] (2,4) -- ++(0,0.5) --++(-20,0) --++(0,-2.2);\n" ++
    "  \\end{scope}\n"
    endif ++ 

    "\\end{scope}\n\n"
    
  endif
    | r in Rb+Ru+Rm+Rl..Rb+Ru+Rm+Rl+Rf];


output[
    if ((Rb+Ru+Rm+Rl+Rf) mod 2) == 0 then 
    "\\begin{scope}[yshift=-" ++ show(((Rb+Ru+Rm+Rl+Rf-1)/2)*6+ypass+6) ++ "cm]\n"
    else 
    "\\begin{scope}[yshift=-" ++ show(((Rb+Ru+Rm+Rl+Rf-1)/2)*6+ypass+3) ++ "cm]\n"
    endif ++
    "\\begin{scope}[xshift=0cm]\n" ++
    "\\node at(25,0) {\\small Prob.: " ++ show(PrAtt) ++ " (" ++ 
                                          show(PrEb) ++ ", " ++  show(PrEu) ++ ", " ++ show(PrEm) ++ ", "  ++ show(PrEl) ++ ", " ++ show(PrEf) ++ ");\\quad" ++
                      "$r_b=" ++ show(rb) ++"$\\; $r'_b=" ++ show(rb_p) ++ "$\\; $m_b=" ++ show(mb) ++"$\\; $m'_b=" ++ show(mb_p) ++ "$;\\quad " ++
                      "$r_f=" ++ show(rf) ++"$\\; $r'_f=" ++ show(rf_p) ++ "$\\; $m_f=" ++ show(mf) ++"$\\; $m'_f=" ++ show(mf_p) ++ "$};\n" ++
                     
    "\\node at(25,-1.5) {\\small DataC: " ++ show(DataC) ++ ",\\quad " ++ 
                        "MemoryC: " ++ show(MemoryC) ++ " ($M_\\epsilon=" ++ show(Mepsilon) ++"$),\\quad " ++
                        "TimeC: " ++ show(TimeC) ++ 
                        " [$T_1$=" ++ show(T1) ++ ", " ++ 
                        " $T_{2u}$=" ++ show(T2u) ++
                        " $T_{2l}$=" ++ show(T2l) ++ ", " ++ 
                        "$T_3$=" ++ show(T3) ++ " ($T_\\epsilon$=" ++ show(Tepsilon) ++ ")]};\n" ++
                        
    "\\end{scope}\n \\end{scope}\n\n"
];

output["\\end{tikzpicture}\n" ++ 
       "\\end{document}\n"];
       
       
